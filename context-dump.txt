================================================================
 INFRAPHYSICS-WEB — Context Dump
 Generated: 2026-02-04 16:37:40
 Files: 69  |  Lines: 9847  |  Chars: 358020
================================================================

── File sizes (chars) ──────────────────────────────────────────

  CLAUDE.md                                                  3,592 chars
  package.json                                                 664 chars
  tsconfig.json                                                563 chars
  vite.config.ts                                               585 chars
  index.html                                                 8,369 chars
  index.css                                                 18,297 chars
  src/index.tsx                                                360 chars
  src/types.ts                                               2,100 chars
  src/constants/index.ts                                        80 chars
  src/constants/theme.ts                                       298 chars
  src/constants/layout.ts                                      142 chars
  src/config/index.ts                                           86 chars
  src/config/categories.tsx                                  3,982 chars
  src/config/navigation.ts                                   1,572 chars
  src/contexts/ThemeContext.tsx                              1,968 chars
  src/contexts/SectionStateContext.tsx                       1,607 chars
  src/contexts/ArticleContext.tsx                            1,572 chars
  src/contexts/SecondBrainHubContext.tsx                       692 chars
  src/hooks/index.ts                                            59 chars
  src/hooks/useKeyboardShortcuts.ts                          1,717 chars
  src/hooks/useNavigationTrail.ts                            1,452 chars
  src/hooks/useSecondBrain.ts                                2,651 chars
  src/hooks/useSecondBrainHub.ts                            14,986 chars
  src/lib/index.ts                                             164 chars
  src/lib/content.ts                                         1,559 chars
  src/lib/date.ts                                            1,734 chars
  src/lib/addressToId.ts                                       232 chars
  src/lib/brainIndex.ts                                      2,425 chars
  src/lib/wikilinks.ts                                       1,427 chars
  src/data/data.ts                                             384 chars
  src/components/layout/index.ts                               222 chars
  src/components/layout/Sidebar.tsx                          4,644 chars
  src/components/layout/MobileNav.tsx                        5,851 chars
  src/components/layout/Footer.tsx                           4,972 chars
  src/components/layout/DualGrid.tsx                         2,197 chars
  src/components/layout/Starfield.tsx                        1,933 chars
  src/components/layout/TopoBackground.tsx                   6,634 chars
  src/components/layout/SecondBrainSidebar.tsx              19,382 chars
  src/components/ui/index.ts                                   127 chars
  src/components/ui/SearchBar.tsx                              853 chars
  src/components/ui/Highlight.tsx                              689 chars
  src/components/ui/StatusBadge.tsx                          1,852 chars
  src/components/sections/index.ts                             488 chars
  src/components/sections/ProjectsList.tsx                   8,480 chars
  src/components/sections/ThreadsList.tsx                    5,665 chars
  src/components/sections/Bits2BricksGrid.tsx                4,941 chars
  src/components/App.tsx                                     6,782 chars
  src/components/SearchPalette.tsx                          12,772 chars
  src/components/NavigationTrail.tsx                         1,911 chars
  src/components/RotatingTitle.tsx                           3,372 chars
  src/components/WikiContent.tsx                             6,870 chars
  src/components/WikiLinkPreview.tsx                         1,417 chars
  src/components/icons/index.tsx                            23,805 chars
  src/views/index.ts                                           272 chars
  src/views/HomeView.tsx                                    16,580 chars
  src/views/AboutView.tsx                                    9,479 chars
  src/views/ContactView.tsx                                  7,208 chars
  src/views/ThanksView.tsx                                     868 chars
  src/views/SectionView.tsx                                 14,980 chars
  src/views/PostView.tsx                                     1,457 chars
  src/views/ArticlePostView.tsx                             24,606 chars
  src/views/SecondBrainView.tsx                             15,371 chars
  src/styles/article.css                                    37,608 chars
  scripts/build-content.js                                  20,524 chars
  scripts/compiler.config.js                                 2,401 chars
  src/data/pages/projects/compiler-pipeline-demo.md          1,610 chars
  src/data/pages/threads/anatomy-of-a-markdown-compiler.md   1,865 chars
  src/data/pages/bits2bricks/custom-syntax-pcb.md            1,446 chars
  src/data/pages/home/_home-featured.yaml                      567 chars

================================================================
# FILE: CLAUDE.md  (54 lines)
================================================================
# InfraPhysics — Development Guide

## Stack
- React 19 + TypeScript, Vite 6, React Router DOM 7
- Tailwind CSS via CDN (NOT npm) — config is inline in `index.html`
- No build-time Tailwind — classes are generated at runtime by the CDN script

## Theme System (CRITICAL)

All colors are centralized. **Never use hardcoded Tailwind color classes** like `text-white`, `text-gray-400`, `bg-white/10`, `border-white/10`, etc.

**Before touching any color or style**, read the cascade: CSS vars in `index.html` → Tailwind tokens in the inline config → `th-*` classes in components. The smooth dark/light transition depends on every color going through this chain. Using a raw color (e.g. `text-white`, `bg-gray-900`) bypasses the CSS vars and will flash or jump on theme toggle. When in doubt, check `index.html` `:root` and `[data-theme="light"]` blocks for what's already defined before inventing a new value.

### Architecture
1. **CSS custom properties** defined in `index.html` under `:root` (dark default) and `[data-theme="light"]`
2. **Tailwind semantic tokens** (`th-*`) mapped to those CSS vars in the inline Tailwind config
3. **ThemeContext** (`src/contexts/ThemeContext.tsx`) provides `useTheme()` hook with `theme` and `toggleTheme`

### What stays hardcoded (theme-constant)
- **Category accent colors**: `text-emerald-400`, `text-amber-400`, `text-blue-400`, `text-violet-400` — these are identity colors, same in both themes
- **Status colors**: emerald for active, amber for in-progress, red for errors
- **Accent interactions**: `hover:text-blue-400` for links is fine

### Adding new CSS variables
If you need a new semantic color:
1. Add the variable to `:root` AND `[data-theme="light"]` in `index.html`
2. Add the Tailwind token mapping in the inline `tailwind.config` colors object
3. Use the `th-*` class in components

### Theme transition
When toggling themes, `ThemeContext` temporarily adds `.theme-transitioning` to `<html>` for a smooth fade. The transition properties are defined in `index.css`. If you add new animated properties during theme change, add them to that rule.

### Sidebar colors
The sidebar uses CSS vars directly via `style={{ color: 'var(--sidebar-text)' }}` since it's a single component. Category accent hex values live in `src/constants/theme.ts` (`CATEGORY_ACCENTS`).

## CSS Files
- `index.html` — All CSS custom properties, Tailwind config, fonts, scrollbar
- `index.css` — Content/markdown styles, wiki-link styles, animations, chips, theme transition
- Both files use `var(--*)` references, never hardcoded colors

## Routes
- Personal pages: `/home`, `/about`, `/contact`, `/thanks`
- Lab sections: `/lab/projects`, `/lab/threads`, `/lab/bits2bricks`
- Second Brain: `/second-brain`, `/second-brain/:id`
- Post detail: `/:category/:id`

## Backgrounds
- **Starfield** — personal pages, dark mode only (fades via opacity on theme toggle)
- **DualGrid** — lab/wiki pages, adapts via CSS vars (`--grid-small`, `--grid-large`)
- **Clean** — post detail pages, just `bg-th-base`

## Context Dump (`scripts/dump-context.sh`)

This script compacts all relevant source files into a single `context-dump.txt` for passing to an LLM. **Whenever you create or delete a source file**, check if it should be added to or removed from the `FILES` array in `scripts/dump-context.sh`. Include any file that contributes to understanding the app's structure or behavior (components, views, hooks, contexts, lib, config, constants, types, styles, build scripts). Exclude generated files, assets, tests/templates, docs, and dependencies.


================================================================
# FILE: package.json  (28 lines)
================================================================
{
  "name": "infraphysics",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "content": "node scripts/build-content.js",
    "dev": "npm run content && vite",
    "build": "npm run content && vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^19.2.3",
    "react-dom": "^19.2.3",
    "react-router-dom": "^7.12.0",
    "shiki": "^3.22.0"
  },
  "devDependencies": {
    "@types/js-yaml": "^4.0.9",
    "@types/node": "^22.14.0",
    "@vitejs/plugin-react": "^5.0.0",
    "gray-matter": "^4.0.3",
    "js-yaml": "^4.1.1",
    "marked": "^17.0.1",
    "typescript": "~5.8.2",
    "vite": "^6.2.0"
  }
}


================================================================
# FILE: tsconfig.json  (29 lines)
================================================================
{
  "compilerOptions": {
    "target": "ES2022",
    "experimentalDecorators": true,
    "useDefineForClassFields": false,
    "module": "ESNext",
    "lib": [
      "ES2022",
      "DOM",
      "DOM.Iterable"
    ],
    "skipLibCheck": true,
    "types": [
      "node",
      "vite/client"
    ],
    "moduleResolution": "bundler",
    "isolatedModules": true,
    "moduleDetection": "force",
    "allowJs": true,
    "jsx": "react-jsx",
    "paths": {
      "@/*": [
        "./*"
      ]
    },
    "allowImportingTsExtensions": true,
    "noEmit": true
  }
}

================================================================
# FILE: vite.config.ts  (23 lines)
================================================================
import path from 'path';
import { defineConfig, loadEnv } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig(({ mode }) => {
    const env = loadEnv(mode, '.', '');
    return {
      server: {
        port: 3000,
        host: '0.0.0.0',
      },
      plugins: [react()],
      define: {
        'process.env.API_KEY': JSON.stringify(env.GEMINI_API_KEY),
        'process.env.GEMINI_API_KEY': JSON.stringify(env.GEMINI_API_KEY),
      },
      resolve: {
        alias: {
          '@': path.resolve(__dirname, './src'),
        }
      }
    };
});


================================================================
# FILE: index.html  (223 lines)
================================================================
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <title>InfraPhysics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'],
              mono: ['JetBrains Mono', 'ui-monospace', 'monospace'],
            },
            colors: {
              'th-base':        'var(--bg-base)',
              'th-blog':        'var(--bg-blog)',
              'th-surface':     'var(--bg-surface)',
              'th-surface-alt': 'var(--bg-surface-alt)',
              'th-elevated':    'var(--bg-elevated)',
              'th-active':      'var(--bg-active)',
              'th-active-hover':'var(--bg-active-hover)',
              'th-heading':     'var(--text-heading)',
              'th-primary':     'var(--text-primary)',
              'th-secondary':   'var(--text-secondary)',
              'th-tertiary':    'var(--text-tertiary)',
              'th-muted':       'var(--text-muted)',
              'th-border':      'var(--border-default)',
              'th-border-hover':'var(--border-hover)',
              'th-border-active':'var(--border-active)',
              'th-sidebar':     'var(--sidebar-bg)',
              'th-hub-sidebar': 'var(--hub-sidebar-bg)',
              'th-hub-border':  'var(--hub-sidebar-border)',
              'th-overlay':     'var(--overlay-bg)',
            },
          },
        },
      };
    </script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap');

      /* ─── Theme tokens ─── */
      :root {
        color-scheme: dark;
        --font-mono: 'JetBrains Mono', ui-monospace, monospace;
        --font-sans: 'Inter', ui-sans-serif, system-ui, sans-serif;

        /* Backgrounds */
        --bg-base:        #000000;
        --bg-blog:        #0a0a0a;
        --bg-surface:     rgba(255,255,255,0.02);
        --bg-surface-alt: rgba(255,255,255,0.04);
        --bg-elevated:    rgba(255,255,255,0.06);
        --bg-active:      rgba(255,255,255,0.10);
        --bg-active-hover:rgba(255,255,255,0.15);

        /* Text */
        --text-heading:   #ffffff;
        --text-primary:   #e8eaed;
        --text-secondary: #9ca3af;
        --text-tertiary:  #6b7280;
        --text-muted:     #4b5563;

        /* Borders */
        --border-default: rgba(255,255,255,0.10);
        --border-hover:   rgba(255,255,255,0.20);
        --border-active:  rgba(255,255,255,0.25);

        /* Grid */
        --grid-small: rgba(255,255,255,0.03);
        --grid-large: rgba(255,255,255,0.06);

        /* Sidebar */
        --hub-sidebar-bg:      #1a1a1a;
        --hub-sidebar-border:  rgba(255,255,255,0.08);
        --sidebar-bg:          #2D2D2D;
        --sidebar-text:        #E8EAED;
        --sidebar-text-active: #FFFFFF;
        --sidebar-icon:        #9AA0A6;
        --sidebar-section:     #6B7280;

        /* Project pills (topic tags) */
        --pill-topic-text:     #94a3b8;
        --pill-topic-border:   rgba(148,163,184,0.3);

        /* Content (markdown) */
        --content-text:              #D1D5DB;
        --content-heading:           #F3F4F6;
        --content-link:              #60A5FA;
        --content-link-hover:        #93BBFD;
        --content-code-bg:           rgba(255,255,255,0.06);
        --content-code-text:         #E8EAED;
        --content-pre-bg:            rgba(255,255,255,0.05);
        --content-pre-border:        rgba(255,255,255,0.08);
        --content-blockquote-border: rgba(255,255,255,0.15);
        --content-blockquote-text:   #9CA3AF;
        --content-table-border:      rgba(255,255,255,0.10);
        --content-table-header:      rgba(255,255,255,0.05);
        --content-img-border:        rgba(255,255,255,0.10);
        --content-img-bg:            rgba(255,255,255,0.03);

        /* Wiki links */
        --wiki-link:            #A78BFA;
        --wiki-link-hover:      #C4B5FD;
        --wiki-preview-bg:      #111111;
        --wiki-preview-border:  rgba(255,255,255,0.10);
        --wiki-preview-title:   #E8EAED;
        --wiki-preview-desc:    #9CA3AF;
        --wiki-preview-hint:    #6B7280;
        --wiki-unresolved:      #6B7280;

        /* Misc */
        --scrollbar-thumb:  #333333;
        --highlight-bg:     rgba(252,211,77,0.15);
        --highlight-text:   #fcd34d;
        --overlay-bg:       rgba(0,0,0,0.60);
        --selection-bg:     rgba(59,130,246,0.20);
        --focus-ring:       rgba(59,130,246,0.15);
      }

      [data-theme="light"] {
        color-scheme: light;

        --bg-base:        #ffffff;
        --bg-blog:        #fafaf9;
        --bg-surface:     #f9fafb;
        --bg-surface-alt: #f3f4f6;
        --bg-elevated:    #e5e7eb;
        --bg-active:      rgba(0,0,0,0.06);
        --bg-active-hover:rgba(0,0,0,0.10);

        --text-heading:   #111827;
        --text-primary:   #1f2937;
        --text-secondary: #4b5563;
        --text-tertiary:  #6b7280;
        --text-muted:     #9ca3af;

        --border-default: rgba(0,0,0,0.10);
        --border-hover:   rgba(0,0,0,0.20);
        --border-active:  rgba(0,0,0,0.30);

        --grid-small: rgba(0,0,0,0.05);
        --grid-large: rgba(0,0,0,0.09);

        --hub-sidebar-bg:      #f9fafb;
        --hub-sidebar-border:  #e5e7eb;
        --sidebar-bg:          #eaecef;
        --sidebar-text:        #374151;
        --sidebar-text-active: #111827;
        --sidebar-icon:        #6B7280;
        --sidebar-section:     #9CA3AF;

        --pill-topic-text:     #475569;
        --pill-topic-border:   rgba(71,85,105,0.35);

        --content-text:              #374151;
        --content-heading:           #111827;
        --content-link:              #2563EB;
        --content-link-hover:        #1D4ED8;
        --content-code-bg:           #f3f4f6;
        --content-code-text:         #1f2937;
        --content-pre-bg:            #1f2937;
        --content-pre-border:        #374151;
        --content-blockquote-border: #d1d5db;
        --content-blockquote-text:   #6b7280;
        --content-table-border:      #e5e7eb;
        --content-table-header:      #f9fafb;
        --content-img-border:        #e5e7eb;
        --content-img-bg:            #f9fafb;

        --wiki-link:            #7C3AED;
        --wiki-link-hover:      #6D28D9;
        --wiki-preview-bg:      #ffffff;
        --wiki-preview-border:  #e5e7eb;
        --wiki-preview-title:   #1F2937;
        --wiki-preview-desc:    #6B7280;
        --wiki-preview-hint:    #9CA3AF;
        --wiki-unresolved:      #9CA3AF;

        --scrollbar-thumb:  #d1d5db;
        --highlight-bg:     rgba(252,211,77,0.30);
        --highlight-text:   #92400e;
        --overlay-bg:       rgba(0,0,0,0.20);
        --selection-bg:     rgba(59,130,246,0.15);
        --focus-ring:       rgba(59,130,246,0.10);
      }

      body {
        font-family: var(--font-mono);
        background-color: var(--bg-base);
        color: var(--text-primary);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      * { font-family: inherit; }
      .font-mono { font-family: var(--font-mono); }
      .font-sans { font-family: var(--font-sans); }

      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); }
    </style>
  <script type="importmap">
{
  "imports": {
    "react/": "https://esm.sh/react@^19.2.3/",
    "react": "https://esm.sh/react@^19.2.3",
    "react-router-dom": "https://esm.sh/react-router-dom@^7.12.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
  <body>
    <div id="root"></div>
  <script type="module" src="/src/index.tsx"></script>
</body>
</html>


================================================================
# FILE: index.css  (803 lines)
================================================================
/* Register custom properties as <color> so Chrome can interpolate
   them during transitions instead of treating them as opaque strings. */

@property --section-accent {
  syntax: '<color>';
  inherits: true;
  initial-value: #a3e635;
}

@property --card-accent {
  syntax: '<color>';
  inherits: true;
  initial-value: #a3e635;
}

/* Dual-range slider - make thumbs clickable while track doesn't interfere */
.dual-range-input {
  pointer-events: none;
}

.dual-range-input::-webkit-slider-thumb {
  pointer-events: auto;
}

.dual-range-input::-moz-range-thumb {
  pointer-events: auto;
}

/* Image positioning classes for markdown content */

.img-float-right {
  float: right;
  margin-left: 1.5rem;
  margin-bottom: 1rem;
  max-width: 100%;
}

.img-float-left {
  float: left;
  margin-right: 1.5rem;
  margin-bottom: 1rem;
  max-width: 100%;
}

.img-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
  margin-top: 1.5rem;
  margin-bottom: 1.5rem;
  max-width: 100%;
}

.img-full {
  width: 100%;
  display: block;
  margin-top: 1.5rem;
  margin-bottom: 1.5rem;
}

/* Side-by-side image layout with vertical centering */
.img-side-layout {
  display: flex;
  align-items: center;
  gap: 1.5rem;
  margin: 1.5rem 0;
}

.img-side-left {
  flex-direction: row;
}

.img-side-right {
  flex-direction: row-reverse;
}

.img-side-img {
  flex-shrink: 0;
  max-width: 50%;
  height: auto;
  border-radius: 0.125rem;
  border: 1px solid var(--content-img-border);
  background-color: var(--content-img-bg);
}

.img-side-content {
  flex: 1;
}

.img-side-content p {
  margin-bottom: 0.5rem;
  text-align: justify;
  line-height: 1.625;
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.img-side-content p:last-child {
  margin-bottom: 0;
}

/* ============================================================
   Markdown content styling — theme-aware
   ============================================================ */
.content-html {
  font-family: var(--font-sans);
  color: var(--content-text);
}

.content-html h1,
.content-html h2,
.content-html h3,
.content-html h4 {
  font-family: var(--font-mono);
  color: var(--content-heading);
}

.content-html h1 {
  font-size: 1.25rem;
  font-weight: 700;
  margin-top: 2rem;
  margin-bottom: 1rem;
  letter-spacing: -0.025em;
}

.content-html h1:first-child {
  margin-top: 0;
}

.content-html h2 {
  font-size: 1.125rem;
  font-weight: 600;
  margin-top: 1.5rem;
  margin-bottom: 0.75rem;
}

.content-html p {
  margin-bottom: 0.5rem;
  text-align: justify;
  line-height: 1.625;
  font-size: 0.875rem;
  color: var(--content-text);
}

.content-html ul,
.content-html ol {
  margin-left: 1rem;
  margin-bottom: 1rem;
}

.content-html li {
  margin-left: 1rem;
  list-style-type: disc;
  font-size: 0.875rem;
  color: var(--content-text);
  line-height: 1.625;
  padding-left: 0.25rem;
}

.content-html img {
  border-radius: 0.125rem;
  border: 1px solid var(--content-img-border);
  background-color: var(--content-img-bg);
}

.content-html img:not([class]) {
  width: 100%;
  max-height: 450px;
  object-fit: contain;
  margin-top: 1.5rem;
  margin-bottom: 1.5rem;
}

.content-html blockquote {
  border-left: 3px solid var(--content-blockquote-border);
  padding-left: 1rem;
  margin: 1rem 0;
  color: var(--content-blockquote-text);
  font-style: italic;
}

.content-html code {
  background-color: var(--content-code-bg);
  color: var(--content-code-text);
  padding: 0.125rem 0.25rem;
  border-radius: 0.25rem;
  font-family: var(--font-mono);
  font-size: 0.875em;
}

.content-html pre {
  background-color: var(--content-pre-bg);
  color: var(--content-code-text);
  padding: 1rem;
  border-radius: 0.25rem;
  overflow-x: auto;
  margin: 1rem 0;
  border: 1px solid var(--content-pre-border);
  transition: background-color 0.95s ease, color 0.95s ease, border-color 0.95s ease;
}

.content-html pre code {
  background-color: transparent;
  padding: 0;
  color: inherit;
}

.content-html a {
  color: var(--content-link);
  text-decoration: none;
  border-bottom: 1px solid transparent;
  transition: border-color 0.2s ease;
}

.content-html a:hover {
  border-bottom-color: var(--content-link);
  color: var(--content-link-hover);
}

.content-html table {
  width: 100%;
  border-collapse: collapse;
  margin: 1rem 0;
}

.content-html th,
.content-html td {
  border: 1px solid var(--content-table-border);
  padding: 0.5rem;
  text-align: left;
}

.content-html th {
  background-color: var(--content-table-header);
  font-weight: 600;
  color: var(--content-heading);
}

/* Clear floats after content */
.content-html::after {
  content: "";
  display: table;
  clear: both;
}

/* Responsive adjustments */
@media (max-width: 640px) {
  .img-float-right,
  .img-float-left {
    float: none;
    margin-left: auto;
    margin-right: auto;
    display: block;
  }

  .img-side-layout {
    flex-direction: column;
  }

  .img-side-img {
    max-width: 100%;
  }
}

@media (min-width: 768px) {
  .content-html h1 {
    font-size: 1.5rem;
  }

  .content-html p,
  .content-html li {
    font-size: 1rem;
  }
}

/* ============================================================
   Section accent — CSS-driven category accent for listing views
   Values aligned 1:1 with --art-accent in article.css
   ============================================================ */

.section-projects  { --section-accent: #a3e635; }
.section-threads   { --section-accent: #fb7185; }
.section-bits2bricks { --section-accent: #3B82F6; }

[data-theme="light"] .section-projects    { --section-accent: #4d7c0f; }
[data-theme="light"] .section-threads     { --section-accent: #e11d48; }
[data-theme="light"] .section-bits2bricks { --section-accent: #2563eb; }

/* card-accent inherits from section-accent — no inline styles needed */
.section-projects .project-card { --card-accent: var(--section-accent); }
.section-threads  .thread-card  { --card-accent: var(--section-accent); }

/* Tech pills in project cards — CSS-driven accent color */
.section-projects .pill-tech {
  color: var(--section-accent);
  border-color: color-mix(in srgb, var(--section-accent) 35%, transparent);
}

/* ============================================================
   Theme transition — smooth pulse on toggle, no interference otherwise
   ============================================================ */

html.theme-transitioning,
html.theme-transitioning *,
html.theme-transitioning *::before,
html.theme-transitioning *::after {
  transition: background-color 0.95s ease, color 0.95s ease,
              border-color 0.95s ease, box-shadow 0.95s ease,
              fill 0.95s ease, stroke 0.95s ease,
              opacity 0.95s ease,
              --section-accent 0.95s ease,
              --card-accent 0.95s ease !important;
}

/* ============================================================
   Wiki-link styles — theme-aware
   ============================================================ */

.wiki-ref-resolved {
  color: var(--wiki-link) !important;
  text-decoration: none !important;
  border-bottom: 1px dashed var(--wiki-link) !important;
  transition: border-bottom-style 0.15s ease, color 0.15s ease;
  cursor: pointer;
}

.wiki-ref-resolved:hover {
  border-bottom-style: solid !important;
  color: var(--wiki-link-hover) !important;
}

.wiki-ref-icon {
  font-size: 0.7em;
  color: var(--wiki-link);
  opacity: 0.8;
  transition: opacity 0.15s ease;
  margin-left: 0.8px;
  vertical-align: baseline;
  position: relative;
  top: -0.4em;
  line-height: 1;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  transform: translateZ(0);
}

.wiki-ref-resolved:hover .wiki-ref-icon {
  opacity: 1;
}

.wiki-ref-unresolved {
  color: var(--wiki-unresolved);
  border-bottom: 1px dotted var(--wiki-unresolved);
  cursor: not-allowed;
}

.wiki-ref-unresolved .wiki-ref-icon {
  color: #EF4444;
  opacity: 0.8;
}

/* Wiki-link hover preview card */
.wiki-preview-card {
  position: fixed;
  z-index: 9999;
  pointer-events: none;
  max-width: 320px;
  min-width: 220px;
  background: var(--wiki-preview-bg);
  border: 1px solid var(--wiki-preview-border);
  border-left: 1.5px solid var(--wiki-link);
  border-bottom: 1.5px solid var(--wiki-link);
  border-radius: 4px;
  padding: 12px 14px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
  animation: wikiPreviewFadeIn 0.15s ease-out forwards;
}

@keyframes wikiPreviewFadeIn {
  from {
    opacity: 0;
    transform: translateY(4px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.wiki-preview-title {
  font-weight: 600;
  font-size: 0.875rem;
  color: var(--wiki-preview-title);
  text-transform: none;
  margin-bottom: 2px;
}

.wiki-preview-address {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  color: var(--wiki-link);
  margin-bottom: 6px;
  opacity: 0.8;
}

.wiki-preview-description {
  font-size: 0.8rem;
  color: var(--wiki-preview-desc);
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
  margin-bottom: 6px;
}

.wiki-preview-hint {
  font-size: 0.65rem;
  color: var(--wiki-preview-hint);
  font-family: var(--font-mono);
  text-transform: uppercase;
  letter-spacing: 0.03em;
}

/* ============================================================
   Shiki syntax highlighting — dual theme (dark default)
   ============================================================ */

.code-terminal pre code span {
  color: var(--shiki-dark);
  transition: color 0.95s ease;
}

[data-theme="light"] .code-terminal pre code span {
  color: var(--shiki-light);
}

/* ============================================================
   Animations
   ============================================================ */

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-fade-in {
  animation: fadeIn 0.4s ease-out forwards;
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

.animate-pulse {
  animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

/* ============================================================
   Focus & Selection — theme-aware
   ============================================================ */

input:focus,
select:focus,
button:focus {
  outline: none;
  box-shadow: none;
}

::selection {
  background-color: var(--selection-bg);
  color: inherit;
}

/* ============================================================
   Industrial Design Elements
   ============================================================ */

.industrial-grid {
  background-image:
    linear-gradient(to right, var(--grid-small) 1px, transparent 1px),
    linear-gradient(to bottom, var(--grid-small) 1px, transparent 1px);
  background-size: 20px 20px;
}

.tech-label {
  font-family: var(--font-mono);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-tertiary);
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
}

.status-dot.active {
  background-color: #10b981;
  box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
}

.status-dot.inactive {
  background-color: #6b7280;
}

/* Card hover effect */
.card-hover {
  transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
}

.card-hover:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

/* Line clamp utilities */
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.line-clamp-3 {
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* ============================================================
   Filter Tags & Chips — theme-aware
   ============================================================ */

.chip {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  font-size: 11px;
  font-family: var(--font-mono);
  border-radius: 2px;
  transition: all 0.2s ease;
  cursor: pointer;
}

.chip-outline {
  border: 1px solid var(--border-default);
  background: transparent;
  color: var(--text-secondary);
}

.chip-outline:hover {
  border-color: #3b82f6;
  color: #60A5FA;
}

.chip-filled {
  background: var(--bg-active);
  color: var(--text-heading);
  border: 1px solid var(--border-hover);
}

/* ============================================================
   Smooth Scrollbar for Content Areas
   ============================================================ */

.smooth-scroll {
  scroll-behavior: smooth;
}

.custom-scrollbar::-webkit-scrollbar {
  width: 4px;
}

.custom-scrollbar::-webkit-scrollbar-track {
  background: transparent;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
  background: var(--scrollbar-thumb);
  border-radius: 2px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background: var(--text-tertiary);
}

/* Hub sidebar scrollbar */
.hub-scrollbar::-webkit-scrollbar {
  width: 3px;
}

.hub-scrollbar::-webkit-scrollbar-track {
  background: transparent;
}

.hub-scrollbar::-webkit-scrollbar-thumb {
  background: var(--hub-sidebar-border);
  border-radius: 2px;
}

.hub-scrollbar::-webkit-scrollbar-thumb:hover {
  background: var(--text-tertiary);
}

/* Main sidebar scrollbar — only visible when zoomed in */
.sidebar-scrollbar::-webkit-scrollbar {
  width: 3px;
}

.sidebar-scrollbar::-webkit-scrollbar-track {
  background: transparent;
}

.sidebar-scrollbar::-webkit-scrollbar-thumb {
  background: var(--sidebar-section);
  border-radius: 2px;
}

.sidebar-scrollbar::-webkit-scrollbar-thumb:hover {
  background: var(--sidebar-text);
}

/* ============================================================
   Tooltip styling — theme-aware
   ============================================================ */

.tooltip {
  position: relative;
}

.tooltip::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  padding: 4px 8px;
  background: var(--bg-elevated);
  color: var(--text-primary);
  font-size: 10px;
  font-family: var(--font-mono);
  white-space: nowrap;
  border-radius: 2px;
  border: 1px solid var(--border-default);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
}

.tooltip:hover::after {
  opacity: 1;
}

/* ============================================================
   Photo L-corner frame — lime bracket accents at inner corners
   ============================================================ */

.photo-l-frame {
  position: relative;
}

.photo-l-frame::before,
.photo-l-frame::after {
  content: '';
  position: absolute;
  z-index: 1;
  pointer-events: none;
}

/* Top-left L bracket */
.photo-l-frame::before {
  top: 6px;
  left: 6px;
  width: 20px;
  height: 20px;
  border-top: 2px solid #a3e635;
  border-left: 2px solid #a3e635;
}

/* Bottom-right L bracket */
.photo-l-frame::after {
  bottom: 6px;
  right: 6px;
  width: 20px;
  height: 20px;
  border-bottom: 2px solid #a3e635;
  border-right: 2px solid #a3e635;
}

/* Light mode — darken lime brackets for readability */
[data-theme="light"] .photo-l-frame::before {
  border-top-color: #3f6212;
  border-left-color: #3f6212;
}
[data-theme="light"] .photo-l-frame::after {
  border-bottom-color: #3f6212;
  border-right-color: #3f6212;
}

/* ============================================================
   Project thumbnail — grayscale + L-corner expand on hover
   ============================================================ */

.project-thumb {
  position: relative;
}

.project-thumb img {
  filter: grayscale(100%);
  transition: filter 0.5s ease, transform 0.5s ease;
}

.project-card:has(.project-title-link:hover) .project-thumb img {
  filter: grayscale(0%);
  transform: scale(1.05);
}

.project-card:has(.project-title-link:hover) .project-card-title {
  color: var(--card-accent);
}

.project-thumb img {
  border: none;
  outline: none;
  color: transparent;
}

/* ============================================================
   Thread thumbnail — rose-tinted desaturation + hover cascade
   ============================================================ */

.thread-thumb img {
  filter: saturate(0.3) brightness(0.9);
  transition: filter 0.5s ease, transform 0.5s ease;
}

.thread-card:has(.thread-title-link:hover, .thread-thumb:hover) .thread-thumb img {
  filter: saturate(1) brightness(1);
  transform: scale(1.05);
}

.thread-card:has(.thread-title-link:hover, .thread-thumb:hover) .thread-card-title {
  color: var(--card-accent);
}

.thread-excerpt {
  border-left: 2px solid var(--card-accent);
  padding-left: 0.75rem;
  font-style: italic;
}

/* ============================================================
   Title L-corner frame — brackets framing a text heading
   Padding keeps text clear of the bracket arms.
   ============================================================ */

.title-l-frame {
  position: relative;
  display: inline-block;
  padding: 10px 20px 12px;
}

.title-l-frame::before,
.title-l-frame::after {
  content: '';
  position: absolute;
  width: 18px;
  height: 18px;
  pointer-events: none;
}

/* Top-left L bracket */
.title-l-frame::before {
  top: 0;
  left: 0;
  border-top: 2px solid currentColor;
  border-left: 2px solid currentColor;
}

/* Bottom-right L bracket */
.title-l-frame::after {
  bottom: 0;
  right: 0;
  border-bottom: 2px solid currentColor;
  border-right: 2px solid currentColor;
}


================================================================
# FILE: src/index.tsx  (14 lines)
================================================================
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './components/App';

const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);

================================================================
# FILE: src/types.ts  (58 lines)
================================================================
export type Category = 'main' | 'projects' | 'threads' | 'bits2bricks' | 'fieldnotes';

export type PostStatus = 'ongoing' | 'implemented' | 'active' | 'in-progress' | 'completed' | 'archived';

export interface Post {
  id: string;
  title: string;
  displayTitle?: string; // Human readable title without dashes
  category: Category;
  content: string;
  date: string;
  description: string;
  thumbnail?: string; // Optional image URL for list view
  thumbnailAspect?: string | null; // How much of the image to show: 'full' | 'wide' | 'banner' | 'strip'
  thumbnailShading?: string | null; // Image shading level: 'none' | 'light' | 'heavy' (default: heavy)
  // Extended metadata for case studies
  status?: PostStatus;
  github?: string; // GitHub repository URL
  demo?: string; // Live demo URL
  caseStudy?: string; // External case study URL
  technologies?: string[]; // Tech stack used
  duration?: string; // Project duration
  featured?: boolean; // Whether to feature this post
  tags?: string[] | null; // Concept/topic tags (rendered as pills)
  author?: string | null; // Post author name
  subtitle?: string | null; // Subtitle shown below displayTitle
  notes?: string[] | string | null; // Author notes / commentary (array of lines or single string)
  context?: string | null; // Short context blurb for blog posts (threads, bits2bricks)
  related?: string[] | null; // Explicit related post IDs (from target category)
  // Fieldnotes-specific (only present for category === 'fieldnotes')
  address?: string;
  addressParts?: string[];
  references?: string[];      // outgoing [[...]] addresses
  trailingRefs?: string[];    // trailing [[...]] for "Related" section
}

export interface NavigationItem {
  label: string;
  path: string;
  colorClass: string;
}

// Author/Profile information
export interface AuthorProfile {
  name: string;
  role: string;
  bio: string;
  shortBio: string;
  avatar?: string;
  social: {
    github?: string;
    linkedin?: string;
    twitter?: string;
    email?: string;
    website?: string;
  };
  skills: string[];
  location?: string;
}

================================================================
# FILE: src/constants/index.ts  (4 lines)
================================================================
// Constants barrel exports

export * from './layout';
export * from './theme';


================================================================
# FILE: src/constants/theme.ts  (8 lines)
================================================================
// Accent colors for non-category navigation items (constant across themes).
// Category accents (projects, threads, bits2bricks) are now fully theme-aware
// via getThemedColor() in config/categories.tsx.

export const CATEGORY_ACCENTS = {
  secondBrain: '#8B5CF6',
  meta: '#9AA0A6',
} as const;


================================================================
# FILE: src/constants/layout.ts  (4 lines)
================================================================
// Layout dimensions and breakpoints

export const SIDEBAR_WIDTH = 144; // w-36 = 9rem = 144px
export const SECOND_BRAIN_SIDEBAR_WIDTH = 260;


================================================================
# FILE: src/config/index.ts  (4 lines)
================================================================
// Config barrel exports

export * from './categories';
export * from './navigation';


================================================================
# FILE: src/config/categories.tsx  (120 lines)
================================================================
// Category metadata with associated icons and colors — dark theme

import React from 'react';
import { GearIcon, ThreadIcon, GradCapIcon } from '../components/icons';
import { Category } from '../types';

export interface CategoryDisplayConfig {
  title: string;
  description: string;
  icon: React.ReactNode;
  color: string;
  lightColor?: string;
  colorClass: string;
  bgClass: string;
  borderClass: string;
  accent: string;
  lightAccent?: string;
  darkBadge: string;
  backLabel: string;
  relatedLabel: string;
  relatedCategory: string; // Target category for "Related" section
  breadcrumbLabel?: string;
}

function categoryColors(color: string) {
  return {
    colorClass: `text-${color}`,
    bgClass: `bg-${color}/10`,
    borderClass: `border-${color}/20`,
    darkBadge: `text-${color} border-${color}/30 bg-${color}/10`,
  };
}

export const CATEGORY_CONFIG: Record<string, CategoryDisplayConfig> = {
  projects: {
    title: 'Projects',
    description: "What I've built, why, and what broke along the way.",
    icon: <GearIcon />,
    color: 'lime-400',
    lightColor: 'lime-700',
    accent: '#a3e635',
    lightAccent: '#4d7c0f',
    backLabel: 'RETURN_TO_ARCHIVES',
    relatedLabel: 'Related Lessons',
    relatedCategory: 'bits2bricks',
    ...categoryColors('lime-400'),
  },
  threads: {
    title: 'Threads',
    description: 'Long-form thinking on engineering, systems, and how things work.',
    icon: <ThreadIcon />,
    color: 'rose-400',
    lightColor: 'rose-600',
    accent: '#fb7185',
    lightAccent: '#e11d48',
    backLabel: 'RETURN_TO_THREADS',
    relatedLabel: 'Related Threads',
    relatedCategory: 'threads',
    breadcrumbLabel: 'threads',
    ...categoryColors('rose-400'),
  },
  bits2bricks: {
    title: 'Bits2Bricks',
    description: 'Where code meets atoms. Hardware, fabrication, physical computing.',
    icon: <GradCapIcon />,
    color: 'blue-400',
    lightColor: 'blue-600',
    accent: '#3B82F6',
    lightAccent: '#2563eb',
    backLabel: 'RETURN_TO_BITS2BRICKS',
    relatedLabel: 'Related Projects',
    relatedCategory: 'projects',
    breadcrumbLabel: 'bits2bricks',
    ...categoryColors('blue-400'),
  },
};

export const BLOG_CATEGORIES = new Set(['threads', 'bits2bricks']);

/** Whether a category uses the blog layout (threads, bits2bricks) */
export const isBlogCategory = (cat: string): boolean => BLOG_CATEGORIES.has(cat);

/** Route group for a category — 'blog' or 'lab' */
export const categoryGroup = (category: string): 'lab' | 'blog' =>
  BLOG_CATEGORIES.has(category) ? 'blog' : 'lab';

/** Full path to a post detail page, e.g. /lab/projects/my-id */
export const postPath = (category: string, id: string): string =>
  `/${categoryGroup(category)}/${category}/${id}`;

/** Full path to a section listing, e.g. /blog/threads */
export const sectionPath = (category: string): string =>
  `/${categoryGroup(category)}/${category}`;

/**
 * Get theme-aware color/accent for a category.
 * Falls back to dark values when no light override exists.
 */
export const getThemedColor = (cat: string, theme: 'dark' | 'light'): { color: string; accent: string } => {
  const cfg = CATEGORY_CONFIG[cat];
  if (!cfg) return { color: 'gray-400', accent: '#9ca3af' };
  if (theme === 'light' && (cfg.lightColor || cfg.lightAccent)) {
    return { color: cfg.lightColor || cfg.color, accent: cfg.lightAccent || cfg.accent };
  }
  return { color: cfg.color, accent: cfg.accent };
};

/**
 * Get category color class (text color)
 */
export const getCategoryColor = (cat: Category): string =>
  CATEGORY_CONFIG[cat]?.colorClass || 'text-gray-400';

/**
 * Get category background classes (bg + border)
 */
export const getCategoryBg = (cat: Category): string => {
  const cfg = CATEGORY_CONFIG[cat];
  return cfg ? `${cfg.bgClass} ${cfg.borderClass}` : 'bg-white/5 border-white/10';
};


================================================================
# FILE: src/config/navigation.ts  (34 lines)
================================================================
// Navigation items and social links

import { CATEGORY_CONFIG } from './categories';

export interface NavItem {
  path: string;
  label: string;
  colorClass: string;
  activeAccent?: string;
}

export interface SocialLink {
  href: string;
  label: string;
  hoverClass: string;
}

export const NAV_ITEMS: NavItem[] = [
  { path: '/home', label: 'home', colorClass: 'text-blue-400', activeAccent: '#3B82F6' },
  { path: '/about', label: 'about', colorClass: 'text-gray-200' },
  { path: '/lab/projects', label: 'projects', colorClass: CATEGORY_CONFIG.projects.colorClass, activeAccent: CATEGORY_CONFIG.projects.accent },
  { path: '/blog/threads', label: 'threads', colorClass: CATEGORY_CONFIG.threads.colorClass, activeAccent: CATEGORY_CONFIG.threads.accent },
  { path: '/blog/bits2bricks', label: 'bits2bricks', colorClass: CATEGORY_CONFIG.bits2bricks.colorClass, activeAccent: CATEGORY_CONFIG.bits2bricks.accent },
  { path: '/lab/second-brain', label: '2\u207F\u1D48 Brain', colorClass: 'text-violet-400', activeAccent: '#8B5CF6' },
  { path: '/contact', label: 'contact', colorClass: 'text-gray-200' },
];

export const SOCIAL_LINKS: SocialLink[] = [
  { href: 'https://github.com/yago-mendoza', label: 'GitHub', hoverClass: 'hover:text-white hover:bg-white/10' },
  { href: 'https://linkedin.com/in/yago-mendoza', label: 'LinkedIn', hoverClass: 'hover:text-blue-400 hover:bg-blue-400/10' },
  { href: 'https://x.com/ymdatweets', label: 'Twitter/X', hoverClass: 'hover:text-white hover:bg-white/10' },
];

export const CONTACT_EMAIL = 'contact@infraphysics.net';


================================================================
# FILE: src/contexts/ThemeContext.tsx  (60 lines)
================================================================
// Theme context — dark/light toggle with persistence

import React, { createContext, useContext, useEffect, useState } from 'react';

type Theme = 'dark' | 'light';

interface ThemeContextType {
  theme: Theme;
  toggleTheme: () => void;
}

const ThemeContext = createContext<ThemeContextType>({ theme: 'dark', toggleTheme: () => {} });

export const useTheme = () => useContext(ThemeContext);

export const ThemeProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [theme, setTheme] = useState<Theme>(() => {
    try {
      const saved = localStorage.getItem('theme') as Theme | null;
      if (saved === 'dark' || saved === 'light') return saved;
    } catch {}
    return window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
  });

  useEffect(() => {
    document.documentElement.setAttribute('data-theme', theme);
    try { localStorage.setItem('theme', theme); } catch {}
  }, [theme]);

  const toggleTheme = () => {
    const next: Theme = theme === 'dark' ? 'light' : 'dark';

    // 1. Declare transitions on every element
    document.documentElement.classList.add('theme-transitioning');

    // 2. Force reflow so the browser registers the transition properties
    //    BEFORE any values change.
    void document.documentElement.offsetHeight;

    // 3. Flip data-theme synchronously — CSS vars update in the same frame,
    //    transitions kick in immediately for all elements.
    document.documentElement.setAttribute('data-theme', next);

    // 4. Delay React re-render to next frame so Chrome commits to the
    //    CSS transition before React touches any DOM attributes/styles.
    requestAnimationFrame(() => {
      setTheme(next);
    });

    setTimeout(() => {
      document.documentElement.classList.remove('theme-transitioning');
    }, 1100);
  };

  return (
    <ThemeContext.Provider value={{ theme, toggleTheme }}>
      {children}
    </ThemeContext.Provider>
  );
};


================================================================
# FILE: src/contexts/SectionStateContext.tsx  (50 lines)
================================================================
import React, { createContext, useContext, useState, useCallback } from 'react';

type SectionState = {
  query: string;
  sortBy: 'newest' | 'oldest' | 'title';
  showFilters: boolean;
  selectedTopics: string[];
  selectedTechs: string[];
  selectedStatuses: string[];
  visibleCount: number;
};

const DEFAULT_STATE: SectionState = { query: '', sortBy: 'newest', showFilters: true, selectedTopics: [], selectedTechs: [], selectedStatuses: [], visibleCount: 0 };

type SectionStateContextType = {
  getState: (category: string) => SectionState;
  setState: (category: string, patch: Partial<SectionState>) => void;
};

const SectionStateContext = createContext<SectionStateContextType | null>(null);

export const SectionStateProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [store, setStore] = useState<Record<string, SectionState>>({});

  const getState = useCallback(
    (category: string): SectionState => store[category] ?? DEFAULT_STATE,
    [store],
  );

  const setState = useCallback(
    (category: string, patch: Partial<SectionState>) =>
      setStore(prev => ({
        ...prev,
        [category]: { ...(prev[category] ?? DEFAULT_STATE), ...patch },
      })),
    [],
  );

  return (
    <SectionStateContext.Provider value={{ getState, setState }}>
      {children}
    </SectionStateContext.Provider>
  );
};

export const useSectionState = () => {
  const ctx = useContext(SectionStateContext);
  if (!ctx) throw new Error('useSectionState must be used within SectionStateProvider');
  return ctx;
};


================================================================
# FILE: src/contexts/ArticleContext.tsx  (58 lines)
================================================================
// Article context — bridges article data up to SearchPalette and global shortcuts

import React, { createContext, useContext, useState, useCallback } from 'react';
import { Post } from '../types';

export interface HeadingInfo {
  level: number;
  text: string;
  id: string;
  number: string;
  depth: number;
}

export interface ArticleState {
  post: Post;
  headings: HeadingInfo[];
  activeHeadingId: string;
  nextPost: Post | null;
  prevPost: Post | null;
}

interface ArticleContextType {
  article: ArticleState | null;
  setArticleState: (state: ArticleState) => void;
  clearArticleState: () => void;
  updateActiveHeading: (id: string) => void;
}

const ArticleContext = createContext<ArticleContextType>({
  article: null,
  setArticleState: () => {},
  clearArticleState: () => {},
  updateActiveHeading: () => {},
});

export const useArticleContext = () => useContext(ArticleContext);

export const ArticleContextProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [article, setArticle] = useState<ArticleState | null>(null);

  const setArticleState = useCallback((state: ArticleState) => {
    setArticle(state);
  }, []);

  const clearArticleState = useCallback(() => {
    setArticle(null);
  }, []);

  const updateActiveHeading = useCallback((id: string) => {
    setArticle(prev => prev ? { ...prev, activeHeadingId: id } : null);
  }, []);

  return (
    <ArticleContext.Provider value={{ article, setArticleState, clearArticleState, updateActiveHeading }}>
      {children}
    </ArticleContext.Provider>
  );
};


================================================================
# FILE: src/contexts/SecondBrainHubContext.tsx  (21 lines)
================================================================
// Second Brain Hub Context — shared state between hub sidebar and view

import React, { createContext, useContext } from 'react';
import { useSecondBrainHub } from '../hooks/useSecondBrainHub';

type HubContextType = ReturnType<typeof useSecondBrainHub>;

const SecondBrainHubContext = createContext<HubContextType | null>(null);

export const SecondBrainHubProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const hub = useSecondBrainHub();
  return (
    <SecondBrainHubContext.Provider value={hub}>
      {children}
    </SecondBrainHubContext.Provider>
  );
};

export const useHub = (): HubContextType | null => {
  return useContext(SecondBrainHubContext);
};


================================================================
# FILE: src/hooks/index.ts  (3 lines)
================================================================
// Hooks barrel exports

export * from './useSecondBrain';


================================================================
# FILE: src/hooks/useKeyboardShortcuts.ts  (50 lines)
================================================================
// Keyboard shortcut hook — registers keydown listener with input/modal guards

import { useEffect } from 'react';

export interface ShortcutDef {
  key: string;        // e.g. 'g', 't', '.'
  shift?: boolean;    // require shift held
  label: string;      // human-readable label for UI
  action: () => void;
  enabled?: boolean;  // default true
}

/**
 * Registers a `keydown` listener that matches against the given shortcut definitions.
 * Suppressed when focus is in an input/textarea/contentEditable, or when Ctrl/Meta/Alt are held.
 * `disabled` flag globally disables all shortcuts (e.g. when SearchPalette is open).
 */
export function useKeyboardShortcuts(shortcuts: ShortcutDef[], disabled?: boolean) {
  useEffect(() => {
    const handler = (e: KeyboardEvent) => {
      if (disabled) return;

      // Don't fire inside inputs, textareas, or contentEditable
      const target = e.target as HTMLElement;
      if (
        target.tagName === 'INPUT' ||
        target.tagName === 'TEXTAREA' ||
        target.tagName === 'SELECT' ||
        target.isContentEditable
      ) return;

      // Don't fire when Ctrl/Meta/Alt are held (those are browser shortcuts)
      if (e.ctrlKey || e.metaKey || e.altKey) return;

      for (const def of shortcuts) {
        if (def.enabled === false) continue;
        const wantShift = def.shift ?? false;
        if (e.shiftKey !== wantShift) continue;
        if (e.key.toLowerCase() === def.key.toLowerCase()) {
          e.preventDefault();
          def.action();
          return;
        }
      }
    };

    document.addEventListener('keydown', handler);
    return () => document.removeEventListener('keydown', handler);
  }, [shortcuts, disabled]);
}


================================================================
# FILE: src/hooks/useNavigationTrail.ts  (45 lines)
================================================================
// Navigation trail hook — tracks the user's click path through Second Brain concepts

import { useState, useCallback } from 'react';

export interface TrailItem {
  id: string;
  label: string;
}

const MAX_TRAIL = 25;

export const useNavigationTrail = () => {
  const [trail, setTrail] = useState<TrailItem[]>([]);

  /** Clear trail and set to a single item. Grid/search card clicks. */
  const resetTrail = useCallback((item: TrailItem) => {
    setTrail([item]);
  }, []);

  /** Remove existing duplicate if any, append to end. Trim from front if > MAX. Wiki-link/backlink/related clicks. */
  const extendTrail = useCallback((item: TrailItem) => {
    setTrail(prev => {
      const filtered = prev.filter(t => t.id !== item.id);
      const next = [...filtered, item];
      return next.length > MAX_TRAIL ? next.slice(next.length - MAX_TRAIL) : next;
    });
  }, []);

  /** Keep items 0..index inclusive. Breadcrumb clicks. */
  const truncateTrail = useCallback((index: number) => {
    setTrail(prev => prev.slice(0, index + 1));
  }, []);

  /** Set trail to []. "All Concepts" click. */
  const clearTrail = useCallback(() => {
    setTrail([]);
  }, []);

  /** Set to [item] ONLY if trail is empty. Page refresh seed. */
  const initTrail = useCallback((item: TrailItem) => {
    setTrail(prev => (prev.length === 0 ? [item] : prev));
  }, []);

  return { trail, resetTrail, extendTrail, truncateTrail, clearTrail, initTrail };
};


================================================================
# FILE: src/hooks/useSecondBrain.ts  (91 lines)
================================================================
// Second Brain logic hook - concept wiki with address-based navigation

import { useState, useMemo, useCallback } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { Post } from '../types';
import {
  allFieldNotes,
  noteById,
  backlinksMap,
  relatedConceptsMap,
  resolvedHtmlMap,
  globalStats,
} from '../lib/brainIndex';

export const useSecondBrain = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const [query, setQuery] = useState('');

  // Active Post from URL — O(1) lookup
  const activePost = useMemo(() => {
    if (id) return noteById.get(id) || null;
    return null;
  }, [id]);

  // Backlinks — O(1) lookup
  const backlinks = useMemo(() => {
    if (!activePost) return [];
    return (backlinksMap.get(activePost.id) || []).filter(n => n.id !== activePost.id);
  }, [activePost]);

  // Related concepts — O(1) lookup
  const relatedConcepts = useMemo(() => {
    if (!activePost) return [];
    return relatedConceptsMap.get(activePost.id) || [];
  }, [activePost]);

  // Outgoing reference count
  const outgoingRefCount = useMemo(() => {
    return activePost?.references?.length || 0;
  }, [activePost]);

  // Pre-resolved HTML
  const resolvedHtml = useMemo(() => {
    if (!activePost) return '';
    return resolvedHtmlMap.get(activePost.id) || activePost.content;
  }, [activePost]);

  // Smart search: address matches first, then content matches
  const filteredNotes = useMemo(() => {
    if (!query) return allFieldNotes;
    const q = query.toLowerCase();

    const addressMatches: Post[] = [];
    const contentMatches: Post[] = [];

    allFieldNotes.forEach(note => {
      const address = (note.address || note.title).toLowerCase();
      const displayTitle = (note.displayTitle || note.title).toLowerCase();

      if (address.includes(q) || displayTitle.includes(q)) {
        addressMatches.push(note);
      } else if (note.description.toLowerCase().includes(q) || note.content.toLowerCase().includes(q)) {
        contentMatches.push(note);
      }
    });

    return [...addressMatches, ...contentMatches];
  }, [query]);

  // Navigation
  const navigateToNote = useCallback((noteId: string) => {
    navigate(`/lab/second-brain/${noteId}`);
  }, [navigate]);

  return {
    id,
    query,
    setQuery,
    allFieldNotes,
    filteredNotes,
    activePost,
    backlinks,
    relatedConcepts,
    outgoingRefCount,
    resolvedHtml,
    totalLinks: globalStats.totalLinks,
    orphanCount: globalStats.orphanCount,
    navigateToNote,
  };
};


================================================================
# FILE: src/hooks/useSecondBrainHub.ts  (467 lines)
================================================================
// Second Brain Hub hook — tree building, multi-mode search, filters, sorts, stats

import { useState, useMemo, useCallback, useRef } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { Post } from '../types';
import {
  allFieldNotes,
  noteById,
  backlinksMap,
  relatedConceptsMap,
  resolvedHtmlMap,
} from '../lib/brainIndex';
import { addressToId } from '../lib/addressToId';

export type SearchMode = 'name' | 'content' | 'backlinks';
export type SortMode = 'a-z' | 'most-links' | 'fewest-links' | 'depth' | 'shuffle';

export interface FilterState {
  orphans: boolean;
  leaf: boolean;
  hubThreshold: number;  // 0 = off
  depthMin: number;      // 1-based
  depthMax: number;      // Infinity = no upper bound
}

const DEFAULT_FILTER_STATE: FilterState = {
  orphans: false,
  leaf: false,
  hubThreshold: 0,
  depthMin: 1,
  depthMax: Infinity,
};

export interface TreeNode {
  label: string;
  path: string;           // full path e.g. "LAPTOP//UI//SCROLLING"
  concept: Post | null;
  children: TreeNode[];
  childCount: number;     // total descendants (concepts only)
}

export interface HubStats {
  totalConcepts: number;
  totalLinks: number;
  orphanCount: number;
  avgRefs: number;
  maxDepth: number;
  density: number;        // links as % of possible connections
  mostConnectedHub: Post | null;
}

// Seeded Fisher-Yates shuffle for stable random ordering
function seededShuffle<T>(arr: T[], seed: number): T[] {
  const result = [...arr];
  let s = seed;
  const random = () => {
    s = (s * 1664525 + 1013904223) & 0xffffffff;
    return (s >>> 0) / 0xffffffff;
  };
  for (let i = result.length - 1; i > 0; i--) {
    const j = Math.floor(random() * (i + 1));
    [result[i], result[j]] = [result[j], result[i]];
  }
  return result;
}

export const useSecondBrainHub = () => {
  const location = useLocation();
  const navigate = useNavigate();
  const [query, setQuery] = useState('');

  // Parse ID from pathname since this hook runs outside <Routes>
  const id = useMemo(() => {
    const match = location.pathname.match(/^\/lab\/second-brain\/(.+)$/);
    return match ? match[1] : undefined;
  }, [location.pathname]);
  const [searchMode, setSearchMode] = useState<SearchMode>('name');
  const [sortMode, setSortMode] = useState<SortMode>('a-z');
  const [filterState, setFilterState] = useState<FilterState>(DEFAULT_FILTER_STATE);
  const [directoryScope, setDirectoryScope] = useState<string | null>(null); // tree path
  const [directoryQuery, setDirectoryQuery] = useState('');
  const [shuffleSeed, setShuffleSeed] = useState(() => Math.floor(Math.random() * 0xffffffff));

  // Active post from URL — O(1) lookup
  const activePost = useMemo(() => {
    if (id) return noteById.get(id) || null;
    return null;
  }, [id]);

  // Track which concept we were viewing before searching, so we can return to it
  const savedIdRef = useRef<string | undefined>(undefined);

  const handleSetQuery = useCallback((q: string) => {
    if (q && !query && id) {
      savedIdRef.current = id;
    }
    if (!q && query && savedIdRef.current) {
      const restoreId = savedIdRef.current;
      savedIdRef.current = undefined;
      navigate(`/lab/second-brain/${restoreId}`);
    }
    if (!q) {
      savedIdRef.current = undefined;
    }
    setQuery(q);
  }, [query, id, navigate]);

  // Backlinks for active post — O(1) lookup
  const backlinks = useMemo(() => {
    if (!activePost) return [];
    return (backlinksMap.get(activePost.id) || []).filter(n => n.id !== activePost.id);
  }, [activePost]);

  // Related concepts — O(1) lookup
  const relatedConcepts = useMemo(() => {
    if (!activePost) return [];
    return relatedConceptsMap.get(activePost.id) || [];
  }, [activePost]);

  // Outgoing ref count
  const outgoingRefCount = useMemo(() => activePost?.references?.length || 0, [activePost]);

  // Pre-resolved HTML — O(1) lookup
  const resolvedHtml = useMemo(() => {
    if (!activePost) return '';
    return resolvedHtmlMap.get(activePost.id) || activePost.content;
  }, [activePost]);

  // --- Stats ---
  const stats: HubStats = useMemo(() => {
    const totalLinks = allFieldNotes.reduce((sum, n) => sum + (n.references?.length || 0), 0);

    const linkedToSet = new Set<string>();
    allFieldNotes.forEach(n => {
      (n.references || []).forEach(ref => {
        linkedToSet.add(addressToId(ref));
      });
    });

    const orphanCount = allFieldNotes.filter(n => {
      const hasOutgoing = (n.references?.length || 0) > 0;
      const hasIncoming = linkedToSet.has(n.id);
      return !hasOutgoing && !hasIncoming;
    }).length;

    const avgRefs = allFieldNotes.length > 0
      ? Math.round((totalLinks / allFieldNotes.length) * 10) / 10
      : 0;

    // Max depth
    const maxDepth = allFieldNotes.reduce((max, n) => {
      const d = (n.addressParts || [n.title]).length;
      return d > max ? d : max;
    }, 0);

    // Density: links / possible connections (n*(n-1))
    const n = allFieldNotes.length;
    const possibleConnections = n * (n - 1);
    const density = possibleConnections > 0
      ? Math.round((totalLinks / possibleConnections) * 1000) / 10 // percentage with 1 decimal
      : 0;

    // Most connected = most total connections (outgoing + incoming)
    let mostConnected: Post | null = null;
    let maxConnections = 0;
    allFieldNotes.forEach(n => {
      const outgoing = n.references?.length || 0;
      const incoming = (backlinksMap.get(n.id) || []).length;
      const total = outgoing + incoming;
      if (total > maxConnections) {
        maxConnections = total;
        mostConnected = n;
      }
    });

    return { totalConcepts: allFieldNotes.length, totalLinks, orphanCount, avgRefs, maxDepth, density, mostConnectedHub: mostConnected };
  }, []);

  // --- Directory Tree ---
  const tree = useMemo(() => {
    const roots: TreeNode[] = [];
    const nodeMap = new Map<string, TreeNode>();

    allFieldNotes.forEach(note => {
      const parts = note.addressParts || [note.title];
      let currentPath = '';

      parts.forEach((part, depth) => {
        const parentPath = currentPath;
        currentPath = depth === 0 ? part : `${currentPath}//${part}`;

        if (!nodeMap.has(currentPath)) {
          const isLastPart = depth === parts.length - 1;
          const node: TreeNode = {
            label: part,
            path: currentPath,
            concept: isLastPart ? note : null,
            children: [],
            childCount: 0,
          };
          nodeMap.set(currentPath, node);

          if (depth === 0) {
            roots.push(node);
          } else {
            const parent = nodeMap.get(parentPath);
            if (parent) {
              parent.children.push(node);
            }
          }
        } else if (depth === parts.length - 1) {
          const existing = nodeMap.get(currentPath)!;
          if (!existing.concept) existing.concept = note;
        }
      });
    });

    // Count descendants
    const countDescendants = (node: TreeNode): number => {
      let count = node.concept ? 1 : 0;
      node.children.forEach(child => {
        count += countDescendants(child);
      });
      node.childCount = count;
      return count;
    };

    roots.forEach(countDescendants);
    roots.sort((a, b) => a.label.localeCompare(b.label));

    return roots;
  }, []);

  // --- Filtered tree (by directoryQuery) ---
  const filteredTree = useMemo(() => {
    if (!directoryQuery) return tree;
    const q = directoryQuery.toLowerCase();

    const filterNodes = (nodes: TreeNode[]): TreeNode[] => {
      return nodes.reduce<TreeNode[]>((acc, node) => {
        const labelMatch = node.label.toLowerCase().includes(q);
        const filteredChildren = filterNodes(node.children);

        if (labelMatch || filteredChildren.length > 0) {
          acc.push({
            ...node,
            children: labelMatch ? node.children : filteredChildren,
          });
        }
        return acc;
      }, []);
    };

    return filterNodes(tree);
  }, [tree, directoryQuery]);

  // --- Multi-mode search ---
  const searchResults = useMemo(() => {
    if (!query) return allFieldNotes;
    const q = query.toLowerCase();

    if (searchMode === 'name') {
      return allFieldNotes.filter(note => {
        const address = (note.address || note.title).toLowerCase();
        const displayTitle = (note.displayTitle || note.title).toLowerCase();
        return address.includes(q) || displayTitle.includes(q);
      });
    }

    if (searchMode === 'content') {
      return allFieldNotes.filter(note =>
        note.content.toLowerCase().includes(q) ||
        note.description.toLowerCase().includes(q)
      );
    }

    if (searchMode === 'backlinks') {
      return allFieldNotes.filter(note => {
        const bl = backlinksMap.get(note.id) || [];
        return bl.some(linker => {
          const addr = (linker.address || linker.title).toLowerCase();
          const dt = (linker.displayTitle || linker.title).toLowerCase();
          return addr.includes(q) || dt.includes(q);
        });
      });
    }

    return allFieldNotes;
  }, [query, searchMode]);

  // --- Directory scope filter ---
  const scopedResults = useMemo(() => {
    if (!directoryScope) return searchResults;
    // Include concepts whose address path starts with the scope path
    return searchResults.filter(note => {
      const parts = note.addressParts || [note.title];
      const notePath = parts.join('//');
      return notePath === directoryScope || notePath.startsWith(directoryScope + '//');
    });
  }, [searchResults, directoryScope]);

  // --- Filters ---
  const filteredNotes = useMemo(() => {
    const { orphans, leaf, hubThreshold, depthMin, depthMax } = filterState;
    const hasAnyFilter = orphans || leaf || hubThreshold > 0 || depthMin > 1 || depthMax < Infinity;
    if (!hasAnyFilter) return scopedResults;

    return scopedResults.filter(note => {
      const depth = (note.addressParts || [note.title]).length;
      const outgoing = note.references?.length || 0;
      const incoming = (backlinksMap.get(note.id) || []).length;
      const totalConnections = outgoing + incoming;

      if (orphans && (outgoing > 0 || incoming > 0)) return false;

      if (leaf) {
        // leaf = no children in the tree (no concepts with this address as prefix)
        const hasChild = allFieldNotes.some(other =>
          other.id !== note.id &&
          other.addressParts &&
          note.addressParts &&
          other.addressParts.length > note.addressParts.length &&
          (other.address || '').startsWith(note.address || '\0')
        );
        if (hasChild) return false;
      }

      if (hubThreshold > 0 && totalConnections < hubThreshold) return false;
      if (depth < depthMin) return false;
      if (depthMax < Infinity && depth > depthMax) return false;

      return true;
    });
  }, [scopedResults, filterState]);

  // --- Sort ---
  const sortedResults = useMemo(() => {
    if (sortMode === 'shuffle') {
      return seededShuffle(filteredNotes, shuffleSeed);
    }

    const sorted = [...filteredNotes];
    switch (sortMode) {
      case 'a-z':
        sorted.sort((a, b) => (a.address || a.title).localeCompare(b.address || b.title));
        break;
      case 'most-links':
        sorted.sort((a, b) => {
          const aLinks = (a.references?.length || 0) + (backlinksMap.get(a.id) || []).length;
          const bLinks = (b.references?.length || 0) + (backlinksMap.get(b.id) || []).length;
          return bLinks - aLinks;
        });
        break;
      case 'fewest-links':
        sorted.sort((a, b) => {
          const aLinks = (a.references?.length || 0) + (backlinksMap.get(a.id) || []).length;
          const bLinks = (b.references?.length || 0) + (backlinksMap.get(b.id) || []).length;
          return aLinks - bLinks;
        });
        break;
      case 'depth':
        sorted.sort((a, b) => {
          const aDepth = (a.addressParts || [a.title]).length;
          const bDepth = (b.addressParts || [b.title]).length;
          return aDepth - bDepth;
        });
        break;
    }
    return sorted;
  }, [filteredNotes, sortMode, shuffleSeed]);

  // --- Reshuffle ---
  const reshuffle = useCallback(() => {
    setShuffleSeed(Math.floor(Math.random() * 0xffffffff));
  }, []);

  // Handle sort mode changes — clicking shuffle when already shuffled re-randomizes
  const handleSetSortMode = useCallback((mode: SortMode) => {
    if (mode === 'shuffle' && sortMode === 'shuffle') {
      reshuffle();
    } else {
      setSortMode(mode);
    }
  }, [sortMode, reshuffle]);

  // --- Reset filters ---
  const resetFilters = useCallback(() => {
    setFilterState(DEFAULT_FILTER_STATE);
  }, []);

  // Check if any filter is active
  const hasActiveFilters = useMemo(() => {
    const { orphans, leaf, hubThreshold, depthMin, depthMax } = filterState;
    return orphans || leaf || hubThreshold > 0 || depthMin > 1 || depthMax < Infinity;
  }, [filterState]);

  // Navigation
  const navigateToNote = useCallback((noteId: string) => {
    navigate(`/lab/second-brain/${noteId}`);
  }, [navigate]);

  // Signal from sidebar directory: "this click should reset the trail"
  const directoryNavRef = useRef(false);
  const signalDirectoryNav = useCallback(() => {
    directoryNavRef.current = true;
  }, []);

  // Search is active = has query text (used to force list view in the main view)
  const searchActive = query.length > 0;

  // Lightweight clear — just wipe the query without the restore-navigate logic
  const clearSearch = useCallback(() => {
    setQuery('');
    savedIdRef.current = undefined;
  }, []);

  return {
    // URL state
    id,
    activePost,

    // Search
    query,
    setQuery: handleSetQuery,
    clearSearch,
    searchActive,
    searchMode,
    setSearchMode,

    // Sort
    sortMode,
    setSortMode: handleSetSortMode,

    // Filters
    filterState,
    setFilterState,
    hasActiveFilters,
    resetFilters,

    // Directory
    directoryScope,
    setDirectoryScope,
    directoryQuery,
    setDirectoryQuery,
    filteredTree,

    // Data
    allFieldNotes,
    sortedResults,
    tree,
    stats,

    // Detail view data
    backlinks,
    relatedConcepts,
    outgoingRefCount,
    resolvedHtml,
    backlinksMap,

    // Navigation
    navigateToNote,

    // Directory nav signal (sidebar → view trail reset)
    directoryNavRef,
    signalDirectoryNav,
  };
};


================================================================
# FILE: src/lib/index.ts  (7 lines)
================================================================
// Lib barrel exports

export * from './date';
export * from './content';
export * from './wikilinks';
export * from './addressToId';
export * from './brainIndex';


================================================================
# FILE: src/lib/content.ts  (46 lines)
================================================================
// Content processing utilities

/**
 * Strip HTML tags from a string, returning plain text
 */
export const stripHtml = (html: string): string =>
  html.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();

/**
 * Calculate reading time in minutes based on word count
 */
export const calculateReadingTime = (content: string): number => {
  const wordsPerMinute = 200;
  const words = content.trim().split(/\s+/).length;
  return Math.ceil(words / wordsPerMinute);
};

/**
 * Extract keywords/tags from content for interconnections
 */
export const extractKeywords = (content: string): string[] => {
  const commonWords = [
    'the', 'a', 'an', 'is', 'are', 'was', 'were', 'to', 'of', 'and', 'in',
    'for', 'on', 'with', 'as', 'by', 'at', 'from', 'or', 'be', 'this', 'that',
    'it', 'not', 'but', 'what', 'all', 'when', 'we', 'can', 'there', 'use',
    'each', 'which', 'do', 'how', 'if', 'will', 'way', 'about', 'many', 'then',
    'them', 'would', 'like', 'so', 'these', 'her', 'him', 'has', 'more', 'could',
    'up', 'out', 'go', 'see', 'no', 'its', 'i'
  ];

  const words = content.toLowerCase()
    .replace(/<[^>]*>/g, ' ')
    .replace(/[^a-z0-9\s]/g, ' ')
    .split(/\s+/)
    .filter(w => w.length > 3 && !commonWords.includes(w));

  // Count occurrences and return top keywords
  const counts: Record<string, number> = {};
  words.forEach(w => { counts[w] = (counts[w] || 0) + 1; });

  return Object.entries(counts)
    .filter(([_, count]) => count >= 1)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5)
    .map(([word]) => word);
};


================================================================
# FILE: src/lib/date.ts  (61 lines)
================================================================
// Date formatting utilities

/**
 * Format date to readable format (Jan 15, 2024)
 */
export const formatDate = (dateStr: string): string => {
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric'
  });
};

/**
 * Format date to compact format (Jan 15)
 */
export const formatDateCompact = (dateStr: string): string => {
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric'
  });
};

/**
 * Format relative time (2 days ago, etc.)
 */
export const formatRelativeTime = (dateStr: string): string => {
  const date = new Date(dateStr);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

  if (diffDays === 0) return 'today';
  if (diffDays === 1) return 'yesterday';
  if (diffDays < 7) return `${diffDays} days ago`;
  if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
  if (diffDays < 365) return `${Math.floor(diffDays / 30)} months ago`;
  return `${Math.floor(diffDays / 365)} years ago`;
};

/**
 * Format date for terminal display (YYYY/MM/DD)
 */
export const formatDateTerminal = (dateStr: string): string => {
  if (!dateStr) return '';
  const cleaned = String(dateStr).split('T')[0];
  return cleaned.replace(/-/g, '/');
};

/**
 * Format date for timeline display (// DATE 2025.05.22)
 */
export const formatDateTimeline = (dateStr: string): string => {
  const date = new Date(dateStr);
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const d = String(date.getDate()).padStart(2, '0');
  return `// DATE ${y}.${m}.${d}`;
};


================================================================
# FILE: src/lib/addressToId.ts  (5 lines)
================================================================
// Shared normalization: convert a wiki-link address to the concept's post ID

export function addressToId(address: string): string {
  return address.toLowerCase().replace(/\/\//g, '--').replace(/\//g, '-').replace(/\s+/g, '-');
}


================================================================
# FILE: src/lib/brainIndex.ts  (71 lines)
================================================================
// Precomputed Second Brain index — runs once at import time, zero React overhead

import { posts } from '../data/data';
import { Post } from '../types';
import { addressToId } from './addressToId';
import { resolveWikiLinks } from './wikilinks';

// All field notes (stable reference)
export const allFieldNotes: Post[] = posts.filter(p => p.category === 'fieldnotes');

// O(1) lookup by id
export const noteById: Map<string, Post> = new Map(allFieldNotes.map(n => [n.id, n]));

// Backlinks: conceptId -> list of concepts that reference it (deduplicated per source note)
export const backlinksMap: Map<string, Post[]> = (() => {
  const map = new Map<string, Post[]>();
  allFieldNotes.forEach(note => {
    const seen = new Set<string>();
    (note.references || []).forEach(ref => {
      const refId = addressToId(ref);
      if (seen.has(refId)) return;
      seen.add(refId);
      if (!map.has(refId)) map.set(refId, []);
      map.get(refId)!.push(note);
    });
  });
  return map;
})();

// Related concepts: conceptId -> resolved Post[] from trailingRefs
export const relatedConceptsMap: Map<string, Post[]> = (() => {
  const map = new Map<string, Post[]>();
  allFieldNotes.forEach(note => {
    if (!note.trailingRefs || note.trailingRefs.length === 0) return;
    const related = note.trailingRefs
      .map(ref => noteById.get(addressToId(ref)))
      .filter((n): n is Post => n !== undefined);
    if (related.length > 0) map.set(note.id, related);
  });
  return map;
})();

// Pre-resolved HTML for every field note (wiki-links already resolved)
export const resolvedHtmlMap: Map<string, string> = (() => {
  const map = new Map<string, string>();
  allFieldNotes.forEach(note => {
    const { html } = resolveWikiLinks(note.content, allFieldNotes, noteById);
    map.set(note.id, html);
  });
  return map;
})();

// Global stats (computed once)
export const globalStats = (() => {
  const totalLinks = allFieldNotes.reduce((sum, n) => sum + (n.references?.length || 0), 0);

  const linkedToSet = new Set<string>();
  allFieldNotes.forEach(n => {
    (n.references || []).forEach(ref => {
      linkedToSet.add(addressToId(ref));
    });
  });

  const orphanCount = allFieldNotes.filter(n => {
    const hasOutgoing = (n.references?.length || 0) > 0;
    const hasIncoming = linkedToSet.has(n.id);
    return !hasOutgoing && !hasIncoming;
  }).length;

  return { totalLinks, orphanCount };
})();


================================================================
# FILE: src/lib/wikilinks.ts  (33 lines)
================================================================
// Shared utility for resolving wiki-links at runtime

import { Post } from '../types';
import { addressToId } from './addressToId';

export function resolveWikiLinks(
  html: string,
  allFieldNotes: Post[],
  noteMap?: Map<string, Post>,
): { html: string; resolvedRefs: string[]; unresolvedRefs: string[] } {
  const resolvedRefs: string[] = [];
  const unresolvedRefs: string[] = [];

  const processed = html.replace(
    /<a class="wiki-ref" data-address="([^"]+)">([^<]+)<\/a>/g,
    (_match, address: string, displayText: string) => {
      const targetId = addressToId(address);
      const target = noteMap ? noteMap.get(targetId) : allFieldNotes.find(n => n.id === targetId);

      if (target) {
        resolvedRefs.push(address);
        const title = encodeURIComponent(target.displayTitle || displayText);
        const desc = encodeURIComponent(target.description || '');
        return `<a class="wiki-ref wiki-ref-resolved" href="/lab/second-brain/${target.id}" data-address="${address}" data-title="${title}" data-description="${desc}">${displayText}<sup class="wiki-ref-icon">\u25C7</sup></a>`;
      } else {
        unresolvedRefs.push(address);
        return `<span class="wiki-ref wiki-ref-unresolved" data-address="${address}">${displayText}<sup class="wiki-ref-icon">?</sup></span>`;
      }
    }
  );

  return { html: processed, resolvedRefs, unresolvedRefs };
}


================================================================
# FILE: src/data/data.ts  (12 lines)
================================================================
import { Post } from '../types';
import postsData from './posts.generated.json';
import categoriesData from './categories.generated.json';

export interface CategoryConfig {
  name: string;
  displayName: string;
  description: string;
  color: string;
}

export const posts: Post[] = postsData as Post[];
export const categoryConfigs: Record<string, CategoryConfig> = categoriesData;

================================================================
# FILE: src/components/layout/index.ts  (8 lines)
================================================================
// Layout components barrel exports

export * from './DualGrid';
export * from './Starfield';
export * from './Sidebar';
export * from './SecondBrainSidebar';
export * from './MobileNav';
export * from './Footer';


================================================================
# FILE: src/components/layout/Sidebar.tsx  (126 lines)
================================================================
// Desktop sidebar navigation component — theme-aware

import React from 'react';
import { Link, useLocation } from 'react-router-dom';
import { useTheme } from '../../contexts/ThemeContext';
import {
  Logo,
  UserIcon,
  GearIcon,
  ThreadIcon,
  GradCapIcon,
  DiamondIcon,
  MailIcon,
  SunIcon,
  MoonIcon,
  SearchIcon,
} from '../icons';
import { CATEGORY_ACCENTS } from '../../constants/theme';
import { getThemedColor } from '../../config/categories';

export const Sidebar: React.FC<{ onOpenSearch?: () => void }> = ({ onOpenSearch }) => {
  const location = useLocation();
  const { theme, toggleTheme } = useTheme();
  const isActive = (path: string) => location.pathname === path || location.pathname.startsWith(path + '/');

  const navLink = (
    basePath: string,
    icon: React.ReactNode,
    label: React.ReactNode,
    accent: string,
    to?: string,
  ) => {
    const active = isActive(basePath);
    return (
      <Link
        to={active ? basePath : (to ?? basePath)}
        className={`flex flex-col items-center gap-1.5 py-3 rounded-sm transition-all ${
          active ? 'font-medium' : 'opacity-80 hover:opacity-100'
        }`}
        style={{
          color: active ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)',
          backgroundColor: active ? `${accent}26` : 'transparent',
        }}
      >
        <span style={{ color: active ? accent : 'var(--sidebar-icon)' }}>{icon}</span>
        <span className="text-[11px]">{label}</span>
      </Link>
    );
  };

  const sectionLabel = (text: string) => (
    <div
      className="flex items-center gap-2 mt-4 mb-1 select-none px-2"
    >
      <span className="flex-1 h-px opacity-20" style={{ backgroundColor: 'var(--sidebar-section)' }} />
      <span
        className="text-[9px] uppercase tracking-[0.2em]"
        style={{ color: 'var(--sidebar-section)' }}
      >
        {text}
      </span>
      <span className="flex-1 h-px opacity-20" style={{ backgroundColor: 'var(--sidebar-section)' }} />
    </div>
  );

  return (
    <aside
      className="hidden md:flex flex-col w-36 flex-shrink-0 sticky top-0 h-screen py-6 px-3 z-40 bg-th-sidebar"
      style={{ transform: 'translateZ(0)', backfaceVisibility: 'hidden' }}
    >
      {/* Logo */}
      <Link
        to="/home"
        className="flex justify-center mb-6 mt-6 group flex-shrink-0"
      >
        <div className="w-10 h-10 transition-transform group-hover:scale-110">
          <Logo color="var(--sidebar-text)" />
        </div>
      </Link>

      {/* Nav + theme toggle — scrollable when viewport is short (e.g. browser zoom) */}
      <div className="flex-1 overflow-y-auto overflow-x-hidden overscroll-contain sidebar-scrollbar">
        {/* LAB */}
        {sectionLabel('lab')}
        <nav className="flex flex-col gap-1">
          {navLink('/lab/projects', <GearIcon />, 'projects', getThemedColor('projects', theme as 'dark' | 'light').accent)}
          {navLink('/lab/second-brain', <DiamondIcon />, <span>2<sup>nd</sup> brain</span>, CATEGORY_ACCENTS.secondBrain)}
        </nav>

        {/* BLOG */}
        {sectionLabel('blog')}
        <nav className="flex flex-col gap-1">
          {navLink('/blog/threads', <ThreadIcon />, 'threads', getThemedColor('threads', theme as 'dark' | 'light').accent)}
          {navLink('/blog/bits2bricks', <GradCapIcon />, 'bits2bricks', getThemedColor('bits2bricks', theme as 'dark' | 'light').accent)}
        </nav>

        {/* META */}
        {sectionLabel('meta')}
        <nav className="flex flex-col gap-1">
          {navLink('/about', <UserIcon />, 'about', CATEGORY_ACCENTS.meta)}
          {navLink('/contact', <MailIcon />, 'contact', CATEGORY_ACCENTS.meta)}
        </nav>

        {/* Theme Toggle + Search */}
        <div className="mt-6 flex justify-center gap-1">
          <button
            onClick={onOpenSearch}
            className="flex items-center justify-center p-2 rounded-sm transition-all"
            style={{ color: 'var(--sidebar-icon)' }}
            aria-label="Search"
          >
            <SearchIcon />
          </button>
          <button
            onClick={toggleTheme}
            className="flex items-center justify-center p-2 rounded-sm transition-all"
            style={{ color: 'var(--sidebar-icon)' }}
            aria-label={`Switch to ${theme === 'dark' ? 'light' : 'dark'} mode`}
          >
            {theme === 'dark' ? <SunIcon /> : <MoonIcon />}
          </button>
        </div>
      </div>
    </aside>
  );
};


================================================================
# FILE: src/components/layout/MobileNav.tsx  (140 lines)
================================================================
// Mobile hamburger menu navigation component — theme-aware

import React, { useState } from 'react';
import { Link, useLocation, useNavigate } from 'react-router-dom';
import { posts } from '../../data/data';
import { useTheme } from '../../contexts/ThemeContext';
import {
  Logo,
  UserIcon,
  GearIcon,
  ThreadIcon,
  GradCapIcon,
  DiamondIcon,
  MailIcon,
  MenuIcon,
  CloseIcon,
  SunIcon,
  MoonIcon,
  SearchIcon,
} from '../icons';
import { getThemedColor } from '../../config/categories';


export const MobileNav: React.FC<{ onOpenSearch?: () => void }> = ({ onOpenSearch }) => {
  const location = useLocation();
  const [isOpen, setIsOpen] = useState(false);
  const navigate = useNavigate();
  const { theme, toggleTheme } = useTheme();


  const handleRandom = () => {
    const validPosts = posts.filter(p => p.category !== 'fieldnotes');
    if (validPosts.length === 0) return;
    const randomIndex = Math.floor(Math.random() * validPosts.length);
    const randomPost = validPosts[randomIndex];
    navigate(`/${randomPost.category}/${randomPost.id}`);
    setIsOpen(false);
  };

  const isActive = (path: string) => location.pathname === path || location.pathname.startsWith(path + '/');

  const NavLink = ({ to, basePath, colorClass, icon, children }: { to: string, basePath?: string, colorClass: string, icon: React.ReactNode, children: React.ReactNode }) => {
    const active = isActive(basePath ?? to);
    return (
      <Link
        to={active && basePath ? basePath : to}
        onClick={() => setIsOpen(false)}
        className={`flex items-center gap-3 py-3 px-4 rounded-sm transition-all ${
          active ? colorClass + ' bg-th-elevated font-medium' : 'text-th-secondary hover:bg-th-surface-alt'
        }`}
      >
        <span className={active ? colorClass : 'text-th-tertiary'}>{icon}</span>
        <span>{children}</span>
      </Link>
    );
  };

  const SectionLabel = ({ children }: { children: React.ReactNode }) => (
    <div className="text-[9px] uppercase tracking-[0.2em] text-th-tertiary px-4 pt-4 pb-1 select-none">
      {children}
    </div>
  );

  return (
    <div className="md:hidden fixed top-0 left-0 right-0 z-50">
      {/* Mobile Header */}
      <div className="flex items-center justify-between px-4 py-3 bg-th-base backdrop-blur-sm border-b border-th-border">
        <Link to="/home" className="flex items-center gap-2">
          <div className="w-8 h-8 bg-th-active rounded-sm flex items-center justify-center">
            <Logo className="w-5 h-5" color="var(--text-primary)" />
          </div>
          <span className="font-bold text-sm text-th-primary">InfraPhysics</span>
        </Link>
        <div className="flex items-center gap-2">
          <button
            onClick={onOpenSearch}
            className="p-2 hover:bg-th-active rounded-sm transition-colors text-th-secondary"
            aria-label="Search"
          >
            <SearchIcon />
          </button>
          <button
            onClick={toggleTheme}
            className="p-2 hover:bg-th-active rounded-sm transition-colors text-th-secondary"
            aria-label={`Switch to ${theme === 'dark' ? 'light' : 'dark'} mode`}
          >
            {theme === 'dark' ? <SunIcon /> : <MoonIcon />}
          </button>
          <button
            onClick={() => setIsOpen(!isOpen)}
            className="p-2 hover:bg-th-active rounded-sm transition-colors text-th-secondary"
            aria-label="Toggle menu"
          >
            {isOpen ? <CloseIcon /> : <MenuIcon />}
          </button>
        </div>
      </div>

      {/* Mobile Menu Overlay */}
      {isOpen && (
        <>
          <div
            className="fixed inset-0 bg-th-overlay z-40"
            onClick={() => setIsOpen(false)}
          ></div>
          <div className="absolute top-14 left-0 right-0 bg-th-sidebar border-b border-th-border z-50 shadow-lg animate-fade-in">
            <nav className="flex flex-col p-4 gap-1">
              {/* LAB */}
              <SectionLabel>lab</SectionLabel>
              <NavLink to="/lab/projects" basePath="/lab/projects" colorClass={`text-${getThemedColor('projects', theme as 'dark' | 'light').color}`} icon={<GearIcon />}>Projects</NavLink>
              <NavLink to="/lab/second-brain" colorClass="text-violet-400" icon={<DiamondIcon />}>2<sup>nd</sup> brain</NavLink>

              {/* BLOG */}
              <SectionLabel>blog</SectionLabel>
              <NavLink to="/blog/threads" basePath="/blog/threads" colorClass={`text-${getThemedColor('threads', theme as 'dark' | 'light').color}`} icon={<ThreadIcon />}>Threads</NavLink>
              <NavLink to="/blog/bits2bricks" basePath="/blog/bits2bricks" colorClass={`text-${getThemedColor('bits2bricks', theme as 'dark' | 'light').color}`} icon={<GradCapIcon />}>Bits2Bricks</NavLink>

              {/* META */}
              <SectionLabel>meta</SectionLabel>
              <NavLink to="/about" colorClass="text-th-primary" icon={<UserIcon />}>About</NavLink>
              <NavLink to="/contact" colorClass="text-th-primary" icon={<MailIcon />}>Contact</NavLink>

              {/* Divider */}
              <div className="my-3 border-t border-th-border"></div>

              {/* Random Button */}
              <button
                onClick={handleRandom}
                className="flex items-center gap-2 px-4 py-2 text-xs text-th-tertiary hover:text-th-secondary transition-colors"
              >
                <span className="w-4 h-4 flex items-center justify-center bg-th-elevated rounded-sm text-[10px]">?</span>
                Random post
              </button>
            </nav>
          </div>
        </>
      )}
    </div>
  );
};


================================================================
# FILE: src/components/layout/Footer.tsx  (101 lines)
================================================================
// Site footer component — theme-aware

import React from 'react';
import { Link, useLocation } from 'react-router-dom';
import { Logo, GitHubIcon, ExternalLinkIcon } from '../icons';
import { getThemedColor } from '../../config/categories';
import { useTheme } from '../../contexts/ThemeContext';

export const Footer: React.FC = () => {
  const { pathname } = useLocation();
  const { theme } = useTheme();
  const isBlog = pathname.startsWith('/blog');

  return (
    <footer className={`w-full py-14 mt-18 border-t border-th-border relative z-20 ${isBlog ? 'bg-th-blog' : 'bg-th-base'}`}>
      <div className="max-w-4xl mx-auto px-6">
        {/* Main Footer Content */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
          {/* Brand */}
          <div className="md:col-span-2">
            <div className="flex items-center gap-3 mb-4">
              <Logo className="w-6 h-6 text-th-secondary" />
              <span className="font-bold text-sm text-th-primary">InfraPhysics</span>
            </div>
            <p className="text-xs text-th-tertiary leading-relaxed mb-4 max-w-sm font-sans">
              An engineer's working journal. Everything here is interconnected.
            </p>
            {/* Social Icons */}
            <div className="flex items-center gap-3">
              <a
                href="https://github.com/yago-mendoza"
                target="_blank"
                rel="noopener noreferrer"
                className="p-2 text-th-tertiary hover:text-th-heading hover:bg-th-active rounded-sm transition-all"
                aria-label="GitHub"
              >
                <GitHubIcon />
              </a>
              <a
                href="https://linkedin.com/in/yago-mendoza"
                target="_blank"
                rel="noopener noreferrer"
                className="p-2 text-th-tertiary hover:text-blue-400 hover:bg-blue-400/10 rounded-sm transition-all"
                aria-label="LinkedIn"
              >
                <ExternalLinkIcon />
              </a>
              <a
                href="https://x.com/ymdatweets"
                target="_blank"
                rel="noopener noreferrer"
                className="p-2 text-th-tertiary hover:text-th-heading hover:bg-th-active rounded-sm transition-all"
                aria-label="Twitter/X"
              >
                <ExternalLinkIcon />
              </a>
            </div>
          </div>

          {/* Navigation */}
          <div>
            <h4 className="text-[10px] uppercase tracking-wider text-th-tertiary mb-4">Explore</h4>
            <nav className="flex flex-col gap-2">
              <Link to="/lab/projects" className={`text-xs text-th-secondary hover:text-${getThemedColor('projects', theme as 'dark' | 'light').color} transition-colors`}>Projects</Link>
              <Link to="/blog/threads" className={`text-xs text-th-secondary hover:text-${getThemedColor('threads', theme as 'dark' | 'light').color} transition-colors`}>Threads</Link>
              <Link to="/blog/bits2bricks" className={`text-xs text-th-secondary hover:text-${getThemedColor('bits2bricks', theme as 'dark' | 'light').color} transition-colors`}>Bits2Bricks</Link>
              <Link to="/lab/second-brain" className="text-xs text-th-secondary hover:text-violet-400 transition-colors">Second Brain</Link>
              <Link to="/contact" className="text-xs text-th-secondary hover:text-th-heading transition-colors">Contact</Link>
            </nav>
          </div>

          {/* Contact */}
          <div>
            <h4 className="text-[10px] uppercase tracking-wider text-th-tertiary mb-4">Contact</h4>
            <nav className="flex flex-col gap-2">
              <a href="mailto:contact@infraphysics.net" className="text-xs text-th-secondary hover:text-th-heading transition-colors">
                contact@infraphysics.net
              </a>
              <a href="https://github.com/yago-mendoza" target="_blank" rel="noopener noreferrer" className="text-xs text-th-secondary hover:text-th-heading transition-colors flex items-center gap-1">
                GitHub <ExternalLinkIcon />
              </a>
            </nav>
          </div>
        </div>

        {/* Bottom Bar */}
        <div className="pt-6 border-t border-th-border flex flex-col md:flex-row justify-between items-center gap-4">
          <div className="text-[10px] text-th-tertiary">
            &copy; {new Date().getFullYear()} InfraPhysics. Built for the bricks.
          </div>
          <div className="flex items-center gap-4 text-[10px] text-th-tertiary">
            <span className="flex items-center gap-1">
              <span className="w-2 h-2 rounded-full bg-emerald-500"></span>
              React, Typescript & Vite
            </span>
          </div>
        </div>
      </div>
    </footer>
  );
};


================================================================
# FILE: src/components/layout/DualGrid.tsx  (65 lines)
================================================================
// Background grid pattern component — theme-aware via CSS custom properties

import React, { useState, useEffect } from 'react';

interface DualGridProps {
  sidebarWidth: number;
}

export const DualGrid: React.FC<DualGridProps> = ({ sidebarWidth }) => {
  const [gridSize, setGridSize] = useState({ largeCellW: 80, smallCellW: 8, largeCellH: 80, smallCellH: 8 });

  useEffect(() => {
    const calculateGrid = () => {
      const targetCellSize = 80;

      const availableWidth = window.innerWidth - sidebarWidth;
      const cellsInWidth = Math.round(availableWidth / targetCellSize);
      const largeCellW = availableWidth / cellsInWidth;
      const smallCellW = largeCellW / 10;

      const availableHeight = window.innerHeight;
      const cellsInHeight = Math.round(availableHeight / targetCellSize);
      const largeCellH = availableHeight / cellsInHeight;
      const smallCellH = largeCellH / 10;

      setGridSize({ largeCellW, smallCellW, largeCellH, smallCellH });
    };

    calculateGrid();
    window.addEventListener('resize', calculateGrid);
    return () => window.removeEventListener('resize', calculateGrid);
  }, [sidebarWidth]);

  return (
    <div
      className="fixed top-0 bottom-0 right-0 pointer-events-none z-0"
      style={{ left: sidebarWidth }}
    >
      {/* Small grid (fine rhythm) */}
      <div
        className="absolute inset-0"
        style={{
          backgroundImage: `
            linear-gradient(to right, var(--grid-small) 1px, transparent 1px),
            linear-gradient(to bottom, var(--grid-small) 1px, transparent 1px)
          `,
          backgroundSize: `${gridSize.smallCellW}px ${gridSize.smallCellH}px`,
          backgroundPosition: '0 0',
        }}
      />
      {/* Large grid (main rhythm) */}
      <div
        className="absolute inset-0"
        style={{
          backgroundImage: `
            linear-gradient(to right, var(--grid-large) 1px, transparent 1px),
            linear-gradient(to bottom, var(--grid-large) 1px, transparent 1px)
          `,
          backgroundSize: `${gridSize.largeCellW}px ${gridSize.largeCellH}px`,
          backgroundPosition: '0 0',
        }}
      />
    </div>
  );
};


================================================================
# FILE: src/components/layout/Starfield.tsx  (64 lines)
================================================================
// Starfield background component — CSS box-shadow technique

import React, { useMemo } from 'react';

interface StarfieldProps {
  sidebarWidth: number;
  visible?: boolean;
}

function generateStars(count: number, maxW: number, maxH: number, opacityMin: number, opacityMax: number): string {
  const shadows: string[] = [];
  for (let i = 0; i < count; i++) {
    const x = Math.floor(Math.random() * maxW);
    const y = Math.floor(Math.random() * maxH);
    const opacity = opacityMin + Math.random() * (opacityMax - opacityMin);
    shadows.push(`${x}px ${y}px rgba(255,255,255,${opacity.toFixed(2)})`);
  }
  return shadows.join(', ');
}

export const Starfield: React.FC<StarfieldProps> = ({ sidebarWidth, visible = true }) => {
  // Generate stars once — spread across a large canvas so they work with scrolling
  const W = 2560;
  const H = 5000;

  const layer1 = useMemo(() => generateStars(200, W, H, 0.55, 1.0), []);
  const layer2 = useMemo(() => generateStars(250, W, H, 0.35, 0.7), []);
  const layer3 = useMemo(() => generateStars(200, W, H, 0.15, 0.5), []);

  return (
    <div
      className="fixed top-0 bottom-0 right-0 pointer-events-none z-0"
      style={{ left: sidebarWidth, backgroundColor: '#000', opacity: visible ? 1 : 0, transition: 'opacity 0.95s ease' }}
    >
      {/* Layer 1: bright stars — 1px */}
      <div
        style={{
          width: 1,
          height: 1,
          background: 'transparent',
          boxShadow: layer1,
        }}
      />
      {/* Layer 2: medium stars — 1px, dimmer */}
      <div
        style={{
          width: 1,
          height: 1,
          background: 'transparent',
          boxShadow: layer2,
        }}
      />
      {/* Layer 3: faint stars — 1px, faintest */}
      <div
        style={{
          width: 1,
          height: 1,
          background: 'transparent',
          boxShadow: layer3,
        }}
      />
    </div>
  );
};


================================================================
# FILE: src/components/layout/TopoBackground.tsx  (207 lines)
================================================================
// Topographic contour-line background — static canvas generated with Perlin noise

import React, { useRef, useEffect } from 'react';

interface TopoBackgroundProps {
  sidebarWidth: number;
  visible?: boolean;
}

// --- Perlin noise implementation ---

const PERM = (() => {
  const p = [
    151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,
    140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,
    247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,
    57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,
    74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,
    60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,
    65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,
    200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,
    52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,
    207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,
    119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,
    129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,
    218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,
    81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,
    184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,
    222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180,
  ];
  const perm = new Uint8Array(512);
  for (let i = 0; i < 512; i++) perm[i] = p[i & 255];
  return perm;
})();

function fade(t: number) { return t * t * t * (t * (t * 6 - 15) + 10); }
function lerp(a: number, b: number, t: number) { return a + t * (b - a); }

function grad(hash: number, x: number, y: number) {
  const h = hash & 3;
  const u = h < 2 ? x : y;
  const v = h < 2 ? y : x;
  return ((h & 1) === 0 ? u : -u) + ((h & 2) === 0 ? v : -v);
}

function perlin(x: number, y: number): number {
  const xi = Math.floor(x) & 255;
  const yi = Math.floor(y) & 255;
  const xf = x - Math.floor(x);
  const yf = y - Math.floor(y);
  const u = fade(xf);
  const v = fade(yf);

  const aa = PERM[PERM[xi] + yi];
  const ab = PERM[PERM[xi] + yi + 1];
  const ba = PERM[PERM[xi + 1] + yi];
  const bb = PERM[PERM[xi + 1] + yi + 1];

  return lerp(
    lerp(grad(aa, xf, yf), grad(ba, xf - 1, yf), u),
    lerp(grad(ab, xf, yf - 1), grad(bb, xf - 1, yf - 1), u),
    v,
  );
}

// Fractal Brownian Motion for richer terrain
function fbm(x: number, y: number, octaves: number): number {
  let value = 0;
  let amplitude = 1;
  let frequency = 1;
  let max = 0;
  for (let i = 0; i < octaves; i++) {
    value += perlin(x * frequency, y * frequency) * amplitude;
    max += amplitude;
    amplitude *= 0.5;
    frequency *= 2;
  }
  return value / max;
}

// --- Marching squares contour extraction ---

function drawContours(
  ctx: CanvasRenderingContext2D,
  field: Float64Array,
  cols: number,
  rows: number,
  cellW: number,
  cellH: number,
  threshold: number,
) {
  for (let j = 0; j < rows - 1; j++) {
    for (let i = 0; i < cols - 1; i++) {
      const tl = field[j * cols + i] >= threshold ? 1 : 0;
      const tr = field[j * cols + i + 1] >= threshold ? 1 : 0;
      const br = field[(j + 1) * cols + i + 1] >= threshold ? 1 : 0;
      const bl = field[(j + 1) * cols + i] >= threshold ? 1 : 0;
      const code = (tl << 3) | (tr << 2) | (br << 1) | bl;

      if (code === 0 || code === 15) continue;

      const x = i * cellW;
      const y = j * cellH;

      // Interpolation helpers
      const vTL = field[j * cols + i];
      const vTR = field[j * cols + i + 1];
      const vBR = field[(j + 1) * cols + i + 1];
      const vBL = field[(j + 1) * cols + i];

      const interpTop = (threshold - vTL) / (vTR - vTL);
      const interpBottom = (threshold - vBL) / (vBR - vBL);
      const interpLeft = (threshold - vTL) / (vBL - vTL);
      const interpRight = (threshold - vTR) / (vBR - vTR);

      const top = { x: x + interpTop * cellW, y };
      const bottom = { x: x + interpBottom * cellW, y: y + cellH };
      const left = { x, y: y + interpLeft * cellH };
      const right = { x: x + cellW, y: y + interpRight * cellH };

      const segments: [{ x: number; y: number }, { x: number; y: number }][] = [];

      switch (code) {
        case 1: case 14: segments.push([left, bottom]); break;
        case 2: case 13: segments.push([bottom, right]); break;
        case 3: case 12: segments.push([left, right]); break;
        case 4: case 11: segments.push([top, right]); break;
        case 5: segments.push([top, left], [bottom, right]); break;
        case 6: case 9: segments.push([top, bottom]); break;
        case 7: case 8: segments.push([top, left]); break;
        case 10: segments.push([top, right], [left, bottom]); break;
      }

      for (const [a, b] of segments) {
        ctx.moveTo(a.x, a.y);
        ctx.lineTo(b.x, b.y);
      }
    }
  }
}

// --- Component ---

export const TopoBackground: React.FC<TopoBackgroundProps> = ({ sidebarWidth, visible = true }) => {
  const canvasRef = useRef<HTMLCanvasElement>(null);

  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;

    const W = canvas.width = window.innerWidth - sidebarWidth;
    const H = canvas.height = window.innerHeight;

    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    // Random offset so the pattern is unique on every reload
    const offsetX = Math.random() * 1000;
    const offsetY = Math.random() * 1000;

    // Noise field sampling
    const cellSize = 6;
    const cols = Math.ceil(W / cellSize) + 1;
    const rows = Math.ceil(H / cellSize) + 1;
    const scale = 0.004;
    const octaves = 4;

    const field = new Float64Array(cols * rows);
    for (let j = 0; j < rows; j++) {
      for (let i = 0; i < cols; i++) {
        field[j * cols + i] = fbm(offsetX + i * cellSize * scale, offsetY + j * cellSize * scale, octaves);
      }
    }

    // Draw contour lines
    const levels = 80;
    ctx.clearRect(0, 0, W, H);

    for (let l = 1; l < levels; l++) {
      const t = -1 + (2 / levels) * l;
      const opacity = 0.05 + 0.01 * Math.sin((l / levels) * Math.PI);

      ctx.beginPath();
      ctx.strokeStyle = `rgba(0, 0, 0, ${opacity.toFixed(3)})`;
      ctx.lineWidth = 0.7;
      drawContours(ctx, field, cols, rows, cellSize, cellSize, t);
      ctx.stroke();
    }
  }, [sidebarWidth]);

  return (
    <div
      className="fixed top-0 bottom-0 right-0 pointer-events-none z-0"
      style={{
        left: sidebarWidth,
        opacity: visible ? 1 : 0,
        transition: 'opacity 0.95s ease',
      }}
    >
      <canvas
        ref={canvasRef}
        className="w-full h-full"
        style={{ display: 'block' }}
      />
    </div>
  );
};


================================================================
# FILE: src/components/layout/SecondBrainSidebar.tsx  (508 lines)
================================================================
// Second Brain Manager Sidebar — data exploration dashboard for /second-brain* routes

import React, { useState, useRef, useEffect } from 'react';
import { Link } from 'react-router-dom';
import { useHub } from '../../contexts/SecondBrainHubContext';
import {
  SearchIcon,
  ChevronIcon,
  FolderIcon,
  BarChartIcon,
  SlidersIcon,
  CloseIcon,
} from '../icons';
import { SECOND_BRAIN_SIDEBAR_WIDTH } from '../../constants/layout';
import type { TreeNode, SearchMode, FilterState } from '../../hooks/useSecondBrainHub';

// --- Collapsible Section ---
const Section: React.FC<{
  title: React.ReactNode;
  icon: React.ReactNode;
  defaultOpen?: boolean;
  children: React.ReactNode;
}> = ({ title, icon, defaultOpen = true, children }) => {
  const [open, setOpen] = useState(defaultOpen);
  return (
    <div className="border-b border-th-hub-border">
      <button
        onClick={() => setOpen(!open)}
        className="w-full flex items-center gap-1.5 px-3 py-2 text-[10px] uppercase tracking-wider text-th-tertiary hover:text-th-secondary transition-colors"
      >
        <span className="text-th-muted">{icon}</span>
        <span className="flex-1 text-left">{title}</span>
        <ChevronIcon isOpen={open} />
      </button>
      {open && <div className="px-3 pb-3">{children}</div>}
    </div>
  );
};

// --- StepperInput ---
const StepperInput: React.FC<{
  value: number;
  displayValue?: string;
  onDecrement: () => void;
  onIncrement: () => void;
  min?: number;
  max?: number;
}> = ({ value, displayValue, onDecrement, onIncrement, min = -Infinity, max = Infinity }) => {
  return (
    <span className="inline-flex items-center border border-th-hub-border text-[10px] tabular-nums">
      <button
        onClick={onDecrement}
        disabled={value <= min}
        className="px-1 py-0.5 text-th-muted hover:text-th-secondary disabled:opacity-30 transition-colors"
      >
        &minus;
      </button>
      <span className="px-1 py-0.5 text-th-primary min-w-[20px] text-center">
        {displayValue ?? value}
      </span>
      <button
        onClick={onIncrement}
        disabled={value >= max}
        className="px-1 py-0.5 text-th-muted hover:text-th-secondary disabled:opacity-30 transition-colors"
      >
        +
      </button>
    </span>
  );
};

// --- Scope Icon (for concept+folder nodes) ---
const ScopeIcon: React.FC<{ onClick: (e: React.MouseEvent) => void }> = ({ onClick }) => (
  <button
    onClick={onClick}
    className="opacity-0 group-hover:opacity-100 text-th-muted hover:text-violet-400 transition-all flex-shrink-0"
    title="Scope to this folder"
  >
    <svg width="10" height="10" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.5">
      <circle cx="8" cy="8" r="5" />
      <circle cx="8" cy="8" r="2" />
    </svg>
  </button>
);

// --- Tree Node ---
const TreeNodeItem: React.FC<{
  node: TreeNode;
  depth?: number;
  activeScope: string | null;
  onScope: (path: string) => void;
  onConceptClick?: () => void;
  forceExpanded?: boolean;
}> = ({ node, depth = 0, activeScope, onScope, onConceptClick, forceExpanded = false }) => {
  const [expanded, setExpanded] = useState(false);
  const hasChildren = node.children.length > 0;
  const isExpanded = forceExpanded || expanded;
  const isScoped = activeScope === node.path;
  const isConceptAndFolder = node.concept && hasChildren;

  return (
    <div>
      <div
        className={`flex items-center gap-1 py-0.5 group ${
          isScoped ? 'bg-violet-400/10' : ''
        }`}
        style={{ paddingLeft: `${depth * 12}px` }}
      >
        {hasChildren ? (
          <button
            onClick={() => setExpanded(!isExpanded)}
            className="w-3 h-3 flex items-center justify-center text-th-muted hover:text-th-secondary transition-colors flex-shrink-0"
          >
            <ChevronIcon isOpen={isExpanded} />
          </button>
        ) : (
          <span className="w-3 h-3 flex-shrink-0" />
        )}

        {node.concept ? (
          isConceptAndFolder ? (
            // Concept + folder: label links to detail, scope icon on hover
            <>
              <Link
                to={`/lab/second-brain/${node.concept.id}`}
                onClick={onConceptClick}
                className="text-[11px] text-th-secondary hover:text-violet-400 transition-colors truncate flex-1"
              >
                {node.label}
              </Link>
              <ScopeIcon onClick={(e) => { e.preventDefault(); onScope(node.path); }} />
            </>
          ) : (
            // Pure concept leaf: link to detail
            <Link
              to={`/lab/second-brain/${node.concept.id}`}
              onClick={onConceptClick}
              className="text-[11px] text-th-secondary hover:text-violet-400 transition-colors truncate flex-1"
            >
              {node.label}
            </Link>
          )
        ) : hasChildren ? (
          // Pure folder: click label to scope
          <button
            onClick={() => onScope(node.path)}
            className={`text-[11px] truncate flex-1 text-left transition-colors ${
              isScoped ? 'text-violet-400' : 'text-th-muted hover:text-th-secondary'
            }`}
          >
            {node.label}
          </button>
        ) : (
          <span className="text-[11px] text-th-muted truncate flex-1">{node.label}</span>
        )}

        {hasChildren && (
          <span className="text-[9px] text-th-muted tabular-nums flex-shrink-0">{node.childCount}</span>
        )}
      </div>

      {isExpanded && hasChildren && (
        <div>
          {node.children
            .sort((a, b) => a.label.localeCompare(b.label))
            .map(child => (
              <TreeNodeItem
                key={child.label}
                node={child}
                depth={depth + 1}
                activeScope={activeScope}
                onScope={onScope}
                onConceptClick={onConceptClick}
                forceExpanded={forceExpanded}
              />
            ))}
        </div>
      )}
    </div>
  );
};

// --- Search Mode Chips ---
const SEARCH_MODES: { value: SearchMode; label: string }[] = [
  { value: 'name', label: 'name' },
  { value: 'content', label: 'content' },
  { value: 'backlinks', label: 'backlinks' },
];


// --- Main Sidebar ---
export const SecondBrainSidebar: React.FC = () => {
  const hub = useHub();
  const [mobileOpen, setMobileOpen] = useState(false);
  const searchInputRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    const handler = (e: KeyboardEvent) => {
      if (e.ctrlKey && e.shiftKey && e.key === 'H') {
        e.preventDefault();
        searchInputRef.current?.focus();
      }
    };
    window.addEventListener('keydown', handler);
    return () => window.removeEventListener('keydown', handler);
  }, []);

  if (!hub) return null;

  const {
    query, setQuery,
    searchMode, setSearchMode,
    filterState, setFilterState, hasActiveFilters, resetFilters,
    directoryScope, setDirectoryScope,
    directoryQuery, setDirectoryQuery,
    filteredTree,
    stats,
    signalDirectoryNav,
  } = hub;

  const handleScope = (path: string) => {
    // Toggle: clicking already-scoped folder clears scope
    setDirectoryScope(directoryScope === path ? null : path);
  };

  const updateFilter = <K extends keyof FilterState>(key: K, value: FilterState[K]) => {
    setFilterState(prev => ({ ...prev, [key]: value }));
  };

  // Format scope path for display: "LAPTOP // UI" → "LAPTOP / UI"
  const scopeDisplay = directoryScope ? directoryScope.replace(/\/\//g, ' / ') : null;

  const sections = (
    <>
      {/* Search */}
      <Section title={<>search <kbd className="normal-case tracking-normal text-th-muted text-[8px] opacity-60">Ctrl+Shift+H</kbd></>} icon={<SearchIcon />} defaultOpen={true}>
        <div className="flex items-center border border-th-hub-border px-2 py-1.5 bg-th-surface focus-within:border-th-border-active transition-colors mb-2">
          <input
            ref={searchInputRef}
            type="text"
            placeholder="Search..."
            value={query}
            onChange={(e) => setQuery(e.target.value)}
            onKeyDown={(e) => { if (e.key === 'Escape') { setQuery(''); searchInputRef.current?.blur(); } }}
            className="w-full text-[11px] focus:outline-none placeholder-th-muted bg-transparent text-th-primary"
          />
          {query && (
            <button
              onClick={() => setQuery('')}
              className="text-th-muted hover:text-th-secondary text-[10px] ml-1 flex-shrink-0"
            >
              &times;
            </button>
          )}
        </div>
        <div className="flex gap-1 flex-wrap">
          {SEARCH_MODES.map(mode => (
            <button
              key={mode.value}
              onClick={() => setSearchMode(mode.value)}
              className={`text-[9px] px-1.5 py-0.5 transition-colors ${
                searchMode === mode.value
                  ? 'bg-violet-400/20 text-violet-400 border border-violet-400/30'
                  : 'text-th-muted border border-th-hub-border hover:text-th-secondary hover:border-th-border-hover'
              }`}
            >
              {mode.label}
            </button>
          ))}
        </div>
      </Section>

      {/* Stats */}
      <Section title="stats" icon={<BarChartIcon />} defaultOpen={true}>
        <div className="grid grid-cols-2 gap-x-3 gap-y-1.5">
          <div>
            <div className="text-[9px] text-th-muted">concepts</div>
            <div className="text-[11px] text-th-primary tabular-nums">{stats.totalConcepts}</div>
          </div>
          <div>
            <div className="text-[9px] text-th-muted">links</div>
            <div className="text-[11px] text-th-primary tabular-nums">{stats.totalLinks}</div>
          </div>
          <div>
            <div className="text-[9px] text-th-muted">orphans</div>
            <div className="text-[11px] text-th-primary tabular-nums">{stats.orphanCount}</div>
          </div>
          <div>
            <div className="text-[9px] text-th-muted">avg refs</div>
            <div className="text-[11px] text-th-primary tabular-nums">{stats.avgRefs}</div>
          </div>
          <div>
            <div className="text-[9px] text-th-muted">max depth</div>
            <div className="text-[11px] text-th-primary tabular-nums">{stats.maxDepth}</div>
          </div>
          <div>
            <div className="text-[9px] text-th-muted">density</div>
            <div className="text-[11px] text-th-primary tabular-nums">{stats.density}%</div>
          </div>
        </div>
      </Section>

      {/* Directory Tree */}
      <Section title="directory" icon={<FolderIcon />} defaultOpen={true}>
        {/* Tree search */}
        <div className="flex items-center border border-th-hub-border px-2 py-1 bg-th-surface focus-within:border-th-border-active transition-colors mb-2">
          <input
            type="text"
            placeholder="Filter tree..."
            value={directoryQuery}
            onChange={(e) => setDirectoryQuery(e.target.value)}
            onKeyDown={(e) => { if (e.key === 'Escape') { setDirectoryQuery(''); (e.target as HTMLInputElement).blur(); } }}
            className="w-full text-[10px] focus:outline-none placeholder-th-muted bg-transparent text-th-primary"
          />
          {directoryQuery && (
            <button
              onClick={() => setDirectoryQuery('')}
              className="text-th-muted hover:text-th-secondary text-[9px] ml-1 flex-shrink-0"
            >
              &times;
            </button>
          )}
        </div>

        {/* Scope indicator */}
        {directoryScope && (
          <div className="flex items-center gap-1 mb-2 px-1 py-1 bg-violet-400/10 border border-violet-400/20 text-[9px]">
            <span className="text-th-muted">scope:</span>
            <span className="text-violet-400 truncate flex-1">{scopeDisplay}</span>
            <button
              onClick={() => setDirectoryScope(null)}
              className="text-th-muted hover:text-th-secondary flex-shrink-0"
            >
              &times;
            </button>
          </div>
        )}

        <div className="space-y-0.5 max-h-60 overflow-y-auto hub-scrollbar">
          {filteredTree.map(node => (
            <TreeNodeItem
              key={node.label}
              node={node}
              activeScope={directoryScope}
              onScope={handleScope}
              onConceptClick={signalDirectoryNav}
              forceExpanded={directoryQuery.length > 0}
            />
          ))}
        </div>
      </Section>

      {/* Filters */}
      <Section title="filters" icon={<SlidersIcon />} defaultOpen={false}>
        <div className="space-y-2">
          {/* Toggle chips */}
          <div className="flex gap-1 flex-wrap">
            <button
              onClick={() => updateFilter('orphans', !filterState.orphans)}
              className={`text-[9px] px-1.5 py-0.5 transition-colors ${
                filterState.orphans
                  ? 'bg-violet-400/20 text-violet-400 border border-violet-400/30'
                  : 'text-th-muted border border-th-hub-border hover:text-th-secondary hover:border-th-border-hover'
              }`}
            >
              orphans
            </button>
            <button
              onClick={() => updateFilter('leaf', !filterState.leaf)}
              className={`text-[9px] px-1.5 py-0.5 transition-colors ${
                filterState.leaf
                  ? 'bg-violet-400/20 text-violet-400 border border-violet-400/30'
                  : 'text-th-muted border border-th-hub-border hover:text-th-secondary hover:border-th-border-hover'
              }`}
            >
              leaf nodes
            </button>
          </div>

          {/* Depth range */}
          <div className="flex items-center gap-1.5 text-[10px] text-th-muted">
            <span>depth</span>
            <StepperInput
              value={filterState.depthMin}
              onDecrement={() => updateFilter('depthMin', Math.max(1, filterState.depthMin - 1))}
              onIncrement={() => updateFilter('depthMin', filterState.depthMin + 1)}
              min={1}
            />
            <span>to</span>
            <StepperInput
              value={filterState.depthMax}
              displayValue={filterState.depthMax === Infinity ? '\u221e' : String(filterState.depthMax)}
              onDecrement={() => updateFilter('depthMax', filterState.depthMax === Infinity ? stats.maxDepth : Math.max(1, filterState.depthMax - 1))}
              onIncrement={() => {
                if (filterState.depthMax === Infinity) return;
                if (filterState.depthMax >= stats.maxDepth) {
                  updateFilter('depthMax', Infinity);
                } else {
                  updateFilter('depthMax', filterState.depthMax + 1);
                }
              }}
            />
          </div>

          {/* Hub threshold */}
          <div className="flex items-center gap-1.5 text-[10px] text-th-muted">
            <span>hubs &ge;</span>
            <StepperInput
              value={filterState.hubThreshold}
              onDecrement={() => updateFilter('hubThreshold', Math.max(0, filterState.hubThreshold - 1))}
              onIncrement={() => updateFilter('hubThreshold', filterState.hubThreshold + 1)}
              min={0}
            />
            {filterState.hubThreshold === 0 && (
              <span className="text-[9px] text-th-muted">off</span>
            )}
          </div>

          {/* Reset */}
          {hasActiveFilters && (
            <button
              onClick={resetFilters}
              className="text-[9px] text-th-muted hover:text-violet-400 transition-colors"
            >
              reset filters
            </button>
          )}
        </div>
      </Section>
    </>
  );

  return (
    <>
      {/* Mobile toggle button */}
      <button
        onClick={() => setMobileOpen(true)}
        className="md:hidden fixed bottom-4 right-4 z-40 w-10 h-10 rounded-full bg-violet-500/90 text-white shadow-lg flex items-center justify-center active:scale-95 transition-transform"
        aria-label="Open manager sidebar"
      >
        <SlidersIcon />
      </button>

      {/* Mobile drawer */}
      {mobileOpen && (
        <div className="md:hidden fixed inset-0 z-50">
          <div
            className="absolute inset-0 bg-black/60"
            onClick={() => setMobileOpen(false)}
          />
          <aside
            className="absolute left-0 top-0 bottom-0 w-72 flex flex-col overflow-hidden"
            style={{ backgroundColor: 'var(--hub-sidebar-bg)' }}
          >
            {/* Header with close */}
            <div className="px-3 py-3 border-b border-th-hub-border flex-shrink-0 flex items-center justify-between">
              <div>
                <div className="text-[11px] lowercase tracking-wide">
                  <span className="font-semibold text-violet-400">second brain</span>{' '}
                  <span className="text-th-muted font-normal">manager</span>
                </div>
                <div className="text-[9px] text-th-muted mt-0.5">
                  {stats.totalConcepts} concepts
                </div>
              </div>
              <button
                onClick={() => setMobileOpen(false)}
                className="p-1 text-th-muted hover:text-th-secondary transition-colors"
                aria-label="Close sidebar"
              >
                <CloseIcon />
              </button>
            </div>
            {/* Scrollable sections */}
            <div className="flex-1 overflow-y-auto hub-scrollbar">
              {sections}
            </div>
          </aside>
        </div>
      )}

      {/* Desktop sidebar */}
      <aside
        className="hidden md:flex flex-col sticky top-0 h-screen border-r border-th-hub-border overflow-hidden"
        style={{
          width: SECOND_BRAIN_SIDEBAR_WIDTH,
          minWidth: SECOND_BRAIN_SIDEBAR_WIDTH,
          backgroundColor: 'var(--hub-sidebar-bg)',
        }}
      >
        {/* Header */}
        <div className="px-3 py-3 border-b border-th-hub-border flex-shrink-0">
          <div className="text-[11px] lowercase tracking-wide">
            <span className="font-semibold text-violet-400">second brain</span>{' '}
            <span className="text-th-muted font-normal">manager</span>
          </div>
          <div className="text-[9px] text-th-muted mt-0.5">
            {stats.totalConcepts} concepts
          </div>
        </div>
        {/* Scrollable sections */}
        <div className="flex-1 overflow-y-auto hub-scrollbar">
          {sections}
        </div>
      </aside>
    </>
  );
};


================================================================
# FILE: src/components/ui/index.ts  (5 lines)
================================================================
// UI components barrel exports

export * from './StatusBadge';
export * from './SearchBar';
export * from './Highlight';


================================================================
# FILE: src/components/ui/SearchBar.tsx  (31 lines)
================================================================
// Reusable search input component

import React from 'react';
import { SearchIcon } from '../icons';

interface SearchBarProps {
  onSearch: (query: string) => void;
  placeholder?: string;
  autoFocus?: boolean;
}

export const SearchBar: React.FC<SearchBarProps> = ({
  onSearch,
  placeholder = "search...",
  autoFocus = true
}) => {
  return (
    <div className="mb-8">
      <div className="group flex items-center border border-gray-200 px-3 py-2.5 focus-within:border-gray-400 transition-colors">
        <SearchIcon />
        <input
          type="text"
          onChange={(e) => onSearch(e.target.value)}
          placeholder={placeholder}
          className="w-full bg-transparent border-none ml-2.5 text-sm focus:outline-none placeholder-gray-400 text-black"
          autoFocus={autoFocus}
        />
      </div>
    </div>
  );
};


================================================================
# FILE: src/components/ui/Highlight.tsx  (25 lines)
================================================================
// Text highlighting for search results

import React from 'react';

interface HighlightProps {
  text: string;
  query: string;
  className?: string;
}

export const Highlight: React.FC<HighlightProps> = ({ text, query, className }) => {
  if (!query) return <span className={className}>{text}</span>;

  const parts = text.split(new RegExp(`(${query})`, 'gi'));

  return (
    <span className={className}>
      {parts.map((part, i) =>
        part.toLowerCase() === query.toLowerCase() ?
          <span key={i} style={{ backgroundColor: 'var(--highlight-bg)', color: 'var(--highlight-text)' }} className="px-0.5 rounded-sm">{part}</span> :
          part
      )}
    </span>
  );
};


================================================================
# FILE: src/components/ui/StatusBadge.tsx  (38 lines)
================================================================
// Status indicator with icon and label

import React from 'react';
import { CircleIcon, CheckCircleIcon } from '../icons';
import { PostStatus } from '../../types';
import { useTheme } from '../../contexts/ThemeContext';

interface StatusBadgeProps {
  status: PostStatus;
  label?: string;
}

const statusConfig: Record<PostStatus, {
  dark: string;
  light: string;
  text: string;
  icon: React.ReactNode;
}> = {
  'ongoing':     { dark: 'bg-amber-700 text-white', light: 'border border-amber-600/40 text-amber-700 bg-amber-50', text: 'Ongoing', icon: <CircleIcon /> },
  'completed':   { dark: 'bg-blue-600 text-white', light: 'border border-blue-500/40 text-blue-700 bg-blue-50', text: 'Completed', icon: <CheckCircleIcon /> },
  'implemented': { dark: 'bg-violet-500 text-white', light: 'border border-violet-500/40 text-violet-700 bg-violet-50', text: 'Implemented', icon: <CheckCircleIcon /> },
  'active':      { dark: 'bg-emerald-600 text-white', light: 'border border-emerald-500/40 text-emerald-700 bg-emerald-50', text: 'Active', icon: <CircleIcon /> },
  'in-progress': { dark: 'bg-amber-500 text-white', light: 'border border-amber-500/40 text-amber-700 bg-amber-50', text: 'In Progress', icon: <CircleIcon /> },
  'archived':    { dark: 'bg-gray-500 text-white', light: 'border border-gray-400/40 text-gray-600 bg-gray-50', text: 'Archived', icon: <CheckCircleIcon /> },
};

export const StatusBadge: React.FC<StatusBadgeProps> = ({ status, label }) => {
  const config = statusConfig[status] || statusConfig['ongoing'];
  const { theme } = useTheme();
  const colorClass = theme === 'light' ? config.light : config.dark;

  return (
    <span className={`inline-flex items-center gap-1.5 px-2 py-0.5 text-[10px] uppercase tracking-wider rounded-sm ${colorClass}`}>
      {config.icon}
      {label || config.text}
    </span>
  );
};


================================================================
# FILE: src/components/sections/index.ts  (16 lines)
================================================================
// Section renderer barrel exports + shared types

import { Post } from '../../types';

export interface SectionRendererProps {
  posts: Post[];
  query: string;
  getExcerpt: (content: string, query: string) => string | null;
  getMatchCount: (content: string, query: string) => number;
  color: string;
  accent?: string;
}

export { Bits2BricksGrid } from './Bits2BricksGrid';
export { ProjectsList } from './ProjectsList';
export { ThreadsList } from './ThreadsList';


================================================================
# FILE: src/components/sections/ProjectsList.tsx  (173 lines)
================================================================
// Projects section — single-column timeline with L-corner photos

import React from 'react';
import { Link } from 'react-router-dom';
import { formatDateTimeline } from '../../lib/date';
import { Highlight, StatusBadge } from '../ui';
import { GitHubIcon, FileTextIcon, PlayCircleIcon } from '../icons';
import { postPath } from '../../config/categories';
import type { SectionRendererProps } from './index';

const STATUS_LABELS: Record<string, string> = {
  'ongoing': 'ONGOING',
  'implemented': 'IMPLEMENTED',
};

export const ProjectsList: React.FC<SectionRendererProps> = ({ posts, query, getExcerpt, getMatchCount, color, accent }) => {
  if (posts.length === 0) {
    return (
      <div className="py-16 text-center">
        <div className="text-th-muted text-4xl mb-4">&empty;</div>
        <p className="text-th-tertiary text-sm">No entries found{query ? ` matching "${query}"` : ''}</p>
      </div>
    );
  }

  return (
    <div className="max-w-3xl mx-auto">
      {posts.map((post, index) => {
        const contentExcerpt = getExcerpt(post.content, query);
        const techs = post.technologies || [];
        const statusLabel = post.status ? STATUS_LABELS[post.status] || post.status.toUpperCase() : null;

        return (
          <div key={post.id} className="project-card relative flex gap-6">
            {/* Timeline rail */}
            <div className="hidden sm:flex flex-col items-center flex-shrink-0 w-7">
              {/* Line above node */}
              {index > 0 && <div className="w-px flex-grow bg-th-border" />}
              {index === 0 && <div className="flex-grow" />}
              {/* Node */}
              <div className={`w-3.5 h-3.5 rounded-full border-2 border-${color} bg-th-base flex-shrink-0`} />
              {/* Line below node */}
              {index < posts.length - 1 && <div className="w-px flex-grow bg-th-border" />}
              {index === posts.length - 1 && <div className="flex-grow" />}
            </div>

            {/* Card content */}
            <div className={`flex-grow pb-10 ${index === posts.length - 1 ? 'pb-0' : ''}`}>
              <div className="flex flex-col md:flex-row gap-6">
                {/* Photo */}
                {post.thumbnail && (
                  <Link to={postPath(post.category, post.id)} className="project-thumb project-title-link relative w-full md:w-72 h-64 overflow-hidden flex-shrink-0 self-start block">
                    <img
                      src={post.thumbnail}
                      alt=""
                      className="w-full h-full object-cover"
                    />
                  </Link>
                )}

                {/* Text */}
                <div className="flex-grow min-w-0">
                  {/* Status + date */}
                  <div className="flex flex-wrap items-center gap-3 mb-3">
                    {post.status && <StatusBadge status={post.status} label={statusLabel || undefined} />}
                    <span className="text-xs text-th-tertiary font-mono">{formatDateTimeline(post.date)}</span>
                  </div>

                  {/* Title */}
                  <Link to={postPath(post.category, post.id)} className="group project-title-link">
                    <h3 className="project-card-title text-xl font-bold uppercase tracking-wide text-th-primary transition-colors leading-tight mb-3">
                      <Highlight text={post.displayTitle || post.title} query={query} />
                    </h3>
                  </Link>

                  {/* Description */}
                  <p className="text-sm text-th-secondary font-sans leading-relaxed mb-4 line-clamp-3">
                    <Highlight text={post.description} query={query} />
                  </p>

                  {/* Pills — topics (purple) + technologies (lime), sorted alphabetically */}
                  {(() => {
                    const topics = (post.tags || []).map(t => ({ label: t, type: 'topic' as const }));
                    const technologies = techs.map(t => ({ label: t, type: 'tech' as const }));
                    const pills = [...topics, ...technologies].sort((a, b) => a.label.localeCompare(b.label));
                    if (pills.length === 0) return null;
                    return (
                      <div className="flex flex-wrap gap-2 mb-4">
                        {pills.map(pill => (
                          <span
                            key={`${pill.type}-${pill.label}`}
                            className={`text-xs px-2.5 py-0.5 border rounded-sm ${pill.type === 'tech' ? 'pill-tech' : ''}`}
                            style={pill.type === 'topic'
                              ? { borderColor: 'var(--pill-topic-border)', color: 'var(--pill-topic-text)' }
                              : undefined
                            }
                          >
                            {pill.label}
                          </span>
                        ))}
                      </div>
                    );
                  })()}

                  {/* Search excerpt + match count */}
                  {query && (() => {
                    const count = getMatchCount(post.content, query);
                    if (!contentExcerpt && count === 0) return null;
                    const lq = query.toLowerCase();
                    const visibleMatch = (post.displayTitle || post.title).toLowerCase().includes(lq) || post.description.toLowerCase().includes(lq);
                    return (
                      <div className="mb-4 text-sm p-2.5 animate-fade-in" style={{ backgroundColor: 'var(--highlight-bg)' }}>
                        {contentExcerpt && (
                          <div className="text-th-secondary">
                            <Highlight text={contentExcerpt} query={query} />
                          </div>
                        )}
                        {count > 0 && (
                          <span className={`text-[11px] text-th-tertiary ${contentExcerpt ? 'mt-1.5' : ''} block`} style={{ color: 'var(--highlight-text)', opacity: 0.7 }}>
                            {visibleMatch ? '+' : ''}{count} {count === 1 ? 'match' : 'matches'} in document
                          </span>
                        )}
                      </div>
                    );
                  })()}

                  {/* Divider + links */}
                  {(post.github || post.caseStudy || post.demo) && (
                    <div className="border-t border-th-border pt-3.5 flex items-center gap-5 text-sm">
                      {post.github && (
                        <a
                          href={post.github}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="inline-flex items-center gap-1.5 text-th-tertiary hover:text-th-heading transition-colors"
                          onClick={e => e.stopPropagation()}
                        >
                          <GitHubIcon /> GitHub
                        </a>
                      )}
                      {post.caseStudy && (
                        <a
                          href={post.caseStudy}
                          target="_blank"
                          rel="noopener noreferrer"
                          className={`inline-flex items-center gap-1.5 text-th-tertiary hover:text-${color} transition-colors`}
                          onClick={e => e.stopPropagation()}
                        >
                          <FileTextIcon /> Case Study
                        </a>
                      )}
                      {post.demo && (
                        <a
                          href={post.demo}
                          target="_blank"
                          rel="noopener noreferrer"
                          className={`inline-flex items-center gap-1.5 text-th-tertiary hover:text-${color} transition-colors`}
                          onClick={e => e.stopPropagation()}
                        >
                          <PlayCircleIcon /> Demo
                        </a>
                      )}
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      })}
    </div>
  );
};


================================================================
# FILE: src/components/sections/ThreadsList.tsx  (132 lines)
================================================================
// Threads section — editorial card layout with diamond rail and rose-tinted photos

import React from 'react';
import { Link } from 'react-router-dom';
import { formatDate } from '../../lib/date';
import { calculateReadingTime } from '../../lib/content';
import { Highlight } from '../ui';
import { ClockIcon } from '../icons';
import { postPath } from '../../config/categories';
import type { SectionRendererProps } from './index';

export const ThreadsList: React.FC<SectionRendererProps> = ({ posts, query, getExcerpt, getMatchCount, color, accent }) => {
  if (posts.length === 0) {
    return (
      <div className="py-16 text-center">
        <div className="text-th-muted text-4xl mb-4">&empty;</div>
        <p className="text-th-tertiary text-sm">No entries found{query ? ` matching "${query}"` : ''}</p>
      </div>
    );
  }

  /* ── Search mode: compact horizontal rows ── */
  if (query) {
    return (
      <div className="max-w-3xl mx-auto divide-y divide-th-border">
        {posts.map(post => {
          const count = getMatchCount(post.content, query);
          const tags = post.tags || [];
          const lq = query.toLowerCase();
          const visibleMatch = (post.displayTitle || post.title).toLowerCase().includes(lq) || post.description.toLowerCase().includes(lq);

          return (
            <Link
              key={post.id}
              to={postPath(post.category, post.id)}
              className={`group flex items-center gap-4 py-3 px-2 hover:bg-th-surface-alt transition-colors`}
            >
              <span className="text-[11px] text-th-tertiary font-mono w-14 flex-shrink-0">{formatDate(post.date)}</span>

              <div className="flex-grow min-w-0">
                <span className={`text-sm text-th-primary group-hover:text-${color} transition-colors truncate block`}>
                  <Highlight text={post.displayTitle || post.title} query={query} />
                </span>
                <span className="text-[11px] text-th-tertiary truncate block">
                  <Highlight text={post.description} query={query} />
                </span>
              </div>

              {tags.length > 0 && (
                <div className="hidden sm:flex gap-1.5 flex-shrink-0">
                  {tags.slice(0, 3).map(tag => (
                    <span key={tag} className="text-[11px] px-2 py-0.5 border border-slate-400/30 text-slate-400 rounded-sm">
                      {tag}
                    </span>
                  ))}
                </div>
              )}

              {count > 0 && (
                <span className="text-[11px] text-th-tertiary flex-shrink-0 font-mono" style={{ color: 'var(--highlight-text)', opacity: 0.7 }}>
                  {visibleMatch ? '+' : ''}{count} {count === 1 ? 'match' : 'matches'}
                </span>
              )}
            </Link>
          );
        })}
      </div>
    );
  }

  /* ── Default: editorial card layout ── */
  return (
    <div className="max-w-3xl mx-auto">
      {posts.map((post, index) => {
        const readTime = calculateReadingTime(post.content);
        const tags = post.tags || [];

        return (
          <div key={post.id} className={`thread-card ${index < posts.length - 1 ? 'border-b border-th-border pb-8 mb-8' : ''}`}>
            <div className="flex flex-col md:flex-row gap-6">
              {/* Text — left */}
              <div className="flex-grow min-w-0">
                {/* Reading time + date */}
                <div className="flex flex-wrap items-center gap-3 mb-3">
                  <span className={`inline-flex items-center gap-1.5 text-xs font-mono px-2 py-0.5 border border-${color}/30 text-${color} rounded-sm`}>
                    <ClockIcon /> {readTime} MIN READ
                  </span>
                  <span className="text-xs text-th-tertiary font-mono">{formatDate(post.date)}</span>
                </div>

                {/* Title + Description — both clickable */}
                <Link to={postPath(post.category, post.id)} className="thread-title-link group block mb-3">
                  <h3 className="thread-card-title text-xl font-bold text-th-primary transition-colors leading-tight mb-2">
                    {post.displayTitle || post.title}
                  </h3>
                  <p className="text-sm text-th-secondary font-sans leading-relaxed">
                    {post.description}
                  </p>
                </Link>

                {/* Tag pills */}
                {tags.length > 0 && (
                  <div className="flex flex-wrap gap-2 mb-4">
                    {tags.map(tag => (
                      <span
                        key={tag}
                        className="text-xs px-2.5 py-0.5 border border-slate-400/30 text-slate-400 rounded-sm"
                      >
                        {tag}
                      </span>
                    ))}
                  </div>
                )}
              </div>

              {/* Photo — right, rose-tinted */}
              {post.thumbnail && (
                <Link to={postPath(post.category, post.id)} className="thread-thumb relative w-full md:w-56 h-36 overflow-hidden flex-shrink-0 self-start block">
                  <img
                    src={post.thumbnail}
                    alt=""
                    className="w-full h-full object-cover"
                  />
                </Link>
              )}
            </div>
          </div>
        );
      })}
    </div>
  );
};


================================================================
# FILE: src/components/sections/Bits2BricksGrid.tsx  (121 lines)
================================================================
// Bits2Bricks section — grid cards (default) / compact search rows (when query active)

import React from 'react';
import { Link } from 'react-router-dom';
import { formatDate } from '../../lib/date';
import { Highlight } from '../ui';
import { postPath } from '../../config/categories';
import type { SectionRendererProps } from './index';

export const Bits2BricksGrid: React.FC<SectionRendererProps> = ({ posts, query, getExcerpt, getMatchCount, color }) => {
  if (posts.length === 0) {
    return (
      <div className="py-16 text-center">
        <div className="text-th-muted text-4xl mb-4">&empty;</div>
        <p className="text-th-tertiary text-sm">No entries found{query ? ` matching "${query}"` : ''}</p>
      </div>
    );
  }

  /* ── Search mode: compact horizontal rows ── */
  if (query) {
    return (
      <div className="max-w-3xl mx-auto divide-y divide-th-border">
        {posts.map(post => {
          const count = getMatchCount(post.content, query);
          const tags = post.tags || [];
          const lq = query.toLowerCase();
          const visibleMatch = (post.displayTitle || post.title).toLowerCase().includes(lq) || post.description.toLowerCase().includes(lq);

          return (
            <Link
              key={post.id}
              to={postPath(post.category, post.id)}
              className={`group flex items-center gap-4 py-3 px-2 hover:bg-th-surface-alt transition-colors`}
            >
              {/* Date */}
              <span className="text-[11px] text-th-tertiary font-mono w-14 flex-shrink-0">{formatDate(post.date)}</span>

              {/* Title + Description */}
              <div className="flex-grow min-w-0">
                <span className={`text-sm text-th-primary group-hover:text-${color} transition-colors truncate block`}>
                  <Highlight text={post.displayTitle || post.title} query={query} />
                </span>
                <span className="text-[11px] text-th-tertiary truncate block">
                  <Highlight text={post.description} query={query} />
                </span>
              </div>

              {/* Tags */}
              {tags.length > 0 && (
                <div className="hidden sm:flex gap-1.5 flex-shrink-0">
                  {tags.slice(0, 3).map(tag => (
                    <span key={tag} className="text-[11px] px-2 py-0.5 border border-blue-400/30 text-blue-400 rounded-sm">
                      {tag}
                    </span>
                  ))}
                </div>
              )}

              {/* Match count */}
              {count > 0 && (
                <span className="text-[11px] text-th-tertiary flex-shrink-0 font-mono" style={{ color: 'var(--highlight-text)', opacity: 0.7 }}>
                  {visibleMatch ? '+' : ''}{count} {count === 1 ? 'match' : 'matches'}
                </span>
              )}
            </Link>
          );
        })}
      </div>
    );
  }

  /* ── Default: image card grid ── */
  return (
    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {posts.map(post => {
        const tags = post.tags || [];

        return (
          <Link
            key={post.id}
            to={postPath(post.category, post.id)}
            className="group block border border-th-border rounded-sm bg-th-surface overflow-hidden hover:border-th-border-hover hover:bg-th-surface-alt transition-all"
          >
            {/* Square thumbnail */}
            <div className="aspect-square bg-th-surface-alt overflow-hidden">
              <img
                src={post.thumbnail || 'https://via.placeholder.com/400'}
                alt=""
                className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
              />
            </div>

            {/* Content */}
            <div className="p-4 space-y-2.5">
              <span className="text-[11px] text-th-tertiary font-mono">{formatDate(post.date)}</span>

              <h3 className={`font-bold text-base text-th-primary group-hover:text-${color} transition-colors leading-tight line-clamp-2`}>
                {post.displayTitle || post.title}
              </h3>

              <p className="text-sm text-th-secondary font-sans leading-relaxed line-clamp-2">
                {post.description}
              </p>

              {tags.length > 0 && (
                <div className="flex flex-wrap gap-1.5">
                  {tags.slice(0, 4).map(tag => (
                    <span key={tag} className="text-[11px] px-2 py-0.5 border border-blue-400/30 text-blue-400 rounded-sm">
                      {tag}
                    </span>
                  ))}
                </div>
              )}
            </div>
          </Link>
        );
      })}
    </div>
  );
};


================================================================
# FILE: src/components/App.tsx  (164 lines)
================================================================
// App shell: provides layout structure and top-level routing

import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { BrowserRouter, Routes, Route, Navigate, useLocation, useParams, useNavigate } from 'react-router-dom';
import { ThemeProvider, useTheme } from '../contexts/ThemeContext';
import { ArticleContextProvider } from '../contexts/ArticleContext';
import { SecondBrainHubProvider } from '../contexts/SecondBrainHubContext';
import { SectionStateProvider } from '../contexts/SectionStateContext';
import { categoryGroup, postPath } from '../config/categories';
import { Sidebar, MobileNav, Footer, DualGrid, Starfield, SecondBrainSidebar } from './layout';
import { SearchPalette } from './SearchPalette';
import { HomeView, AboutView, ContactView, ThanksView, SectionView, PostView, SecondBrainView } from '../views';
import { SIDEBAR_WIDTH, SECOND_BRAIN_SIDEBAR_WIDTH } from '../constants/layout';
import { useKeyboardShortcuts, ShortcutDef } from '../hooks/useKeyboardShortcuts';
import { posts } from '../data/data';

/** Redirect old /:category/:id URLs to grouped /lab|blog/:category/:id */
const LegacyPostRedirect: React.FC = () => {
  const { category, id } = useParams();
  if (!category || !id) return <Navigate to="/home" replace />;
  return <Navigate to={`/${categoryGroup(category)}/${category}/${id}`} replace />;
};

const STARFIELD_PAGES = ['/', '/home', '/about', '/contact', '/thanks'];

const AppLayout: React.FC = () => {
  const location = useLocation();
  const { theme, toggleTheme } = useTheme();
  const [searchOpen, setSearchOpen] = useState(false);
  const navigate = useNavigate();

  const openSearch = useCallback(() => setSearchOpen(true), []);

  // Global keyboard shortcuts (. for most recent, Shift+T for theme)
  const globalShortcuts = useMemo<ShortcutDef[]>(() => {
    const mostRecent = [...posts]
      .filter(p => p.category !== 'fieldnotes')
      .sort((a, b) => b.date.localeCompare(a.date))[0];

    return [
      {
        key: '.',
        label: 'Most recent post',
        action: () => {
          if (mostRecent) navigate(postPath(mostRecent.category, mostRecent.id));
        },
        enabled: !!mostRecent,
      },
      {
        key: 't',
        shift: true,
        label: 'Toggle theme',
        action: toggleTheme,
      },
    ];
  }, [navigate, toggleTheme]);

  useKeyboardShortcuts(globalShortcuts, searchOpen);

  // Global Ctrl+K / Cmd+K  +  Ctrl+Shift+F (outside Second Brain)
  useEffect(() => {
    const handler = (e: KeyboardEvent) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        setSearchOpen(prev => !prev);
      }
      if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key.toLowerCase() === 'f') {
        e.preventDefault();
        setSearchOpen(prev => !prev);
      }
    };
    document.addEventListener('keydown', handler);
    return () => document.removeEventListener('keydown', handler);
  }, [location.pathname]);

  // Scroll to top on every route change (standard SPA behavior)
  useEffect(() => {
    window.scrollTo(0, 0);
  }, [location.pathname]);

  const isStarfieldPage = STARFIELD_PAGES.includes(location.pathname);
  const showGrid = location.pathname.startsWith('/lab');
  const isBlog = location.pathname.startsWith('/blog');
  const isSecondBrain = location.pathname.startsWith('/lab/second-brain');

  const gridOffset = isSecondBrain
    ? SIDEBAR_WIDTH + SECOND_BRAIN_SIDEBAR_WIDTH
    : SIDEBAR_WIDTH;

  const content = (
    <div className={`min-h-screen flex relative ${isBlog ? 'bg-th-blog' : 'bg-th-base'}`}>
      {/* Background — Starfield on personal pages (fades with theme), DualGrid on lab/wiki */}
      <div className="hidden md:block">
        {isStarfieldPage && <Starfield sidebarWidth={SIDEBAR_WIDTH} visible={theme === 'dark'} />}
        {showGrid && <DualGrid sidebarWidth={gridOffset} />}
      </div>

      {/* Mobile Navigation */}
      <MobileNav onOpenSearch={openSearch} />

      {/* Desktop Sidebar */}
      <Sidebar onOpenSearch={openSearch} />

      {/* Search Palette */}
      <SearchPalette isOpen={searchOpen} onClose={() => setSearchOpen(false)} />

      {/* Hub Sidebar (second-brain only, desktop only) */}
      {isSecondBrain && <SecondBrainSidebar />}

      {/* Main Content Area */}
      <div className="flex-1 flex flex-col min-h-screen">
        <main className={`flex-grow w-full mx-auto relative z-10 ${isSecondBrain ? 'max-w-6xl px-10 py-10 md:py-12' : 'max-w-4xl px-6 py-10 md:py-16'}`}>
          <Routes>
            <Route path="/" element={<Navigate to="/home" replace />} />
            <Route path="/home" element={<HomeView />} />
            <Route path="/about" element={<AboutView />} />
            <Route path="/contact" element={<ContactView />} />
            <Route path="/thanks" element={<ThanksView />} />

            {/* Lab sections */}
            <Route path="/lab/projects" element={<SectionView category="projects" />} />
            <Route path="/blog/threads" element={<SectionView category="threads" />} />
            <Route path="/blog/bits2bricks" element={<SectionView category="bits2bricks" />} />

            {/* Legacy redirects */}
            <Route path="/projects" element={<Navigate to="/lab/projects" replace />} />
            <Route path="/second-brain" element={<Navigate to="/lab/second-brain" replace />} />
            <Route path="/threads" element={<Navigate to="/blog/threads" replace />} />
            <Route path="/bits2bricks" element={<Navigate to="/blog/bits2bricks" replace />} />

            {/* Second Brain */}
            <Route path="/lab/second-brain" element={<SecondBrainView />} />
            <Route path="/lab/second-brain/:id" element={<SecondBrainView />} />

            {/* Post detail views */}
            <Route path="/lab/:category/:id" element={<PostView />} />
            <Route path="/blog/:category/:id" element={<PostView />} />

            {/* Legacy: old flat /:category/:id → grouped path */}
            <Route path="/:category/:id" element={<LegacyPostRedirect />} />
          </Routes>
        </main>

        {!isSecondBrain && location.pathname !== '/contact' && <Footer />}
      </div>
    </div>
  );

  return <ArticleContextProvider><SecondBrainHubProvider>{content}</SecondBrainHubProvider></ArticleContextProvider>;
};

const App: React.FC = () => {
  return (
    <ThemeProvider>
      <SectionStateProvider>
        <BrowserRouter>
          <AppLayout />
        </BrowserRouter>
      </SectionStateProvider>
    </ThemeProvider>
  );
};

export default App;


================================================================
# FILE: src/components/SearchPalette.tsx  (367 lines)
================================================================
// Command palette triggered by search button or Ctrl+K / Cmd+K

import React, { useState, useEffect, useRef, useCallback, useMemo } from 'react';
import { useNavigate } from 'react-router-dom';
import { posts } from '../data/data';
import { postPath } from '../config/categories';
import { allFieldNotes } from '../lib/brainIndex';
import { useArticleContext } from '../contexts/ArticleContext';
import { useTheme } from '../contexts/ThemeContext';
import {
  HomeIcon,
  GearIcon,
  GitHubIcon,
  DiamondIcon,
  MailIcon,
  SearchIcon,
  ExternalLinkIcon,
  SunIcon,
  MoonIcon,
} from './icons';

interface SearchPaletteProps {
  isOpen: boolean;
  onClose: () => void;
}

interface QuickAction {
  label: string;
  icon: React.ReactNode;
  action: () => void;
  shortcut?: string;
  group?: 'contextual' | 'global' | 'nav' | 'concept';
}

export const SearchPalette: React.FC<SearchPaletteProps> = ({ isOpen, onClose }) => {
  const [query, setQuery] = useState('');
  const [selectedIndex, setSelectedIndex] = useState(0);
  const inputRef = useRef<HTMLInputElement>(null);
  const listRef = useRef<HTMLDivElement>(null);
  const navigate = useNavigate();
  const { article } = useArticleContext();
  const { theme, toggleTheme } = useTheme();

  const executeAndClose = useCallback((fn: () => void) => {
    fn();
    onClose();
  }, [onClose]);

  // Build all actions: contextual (article) → global shortcuts → navigation
  const actions = useMemo<QuickAction[]>(() => {
    const result: QuickAction[] = [];

    // ── Contextual actions (only when viewing an article) ──
    if (article) {
      const { post, nextPost, prevPost } = article;
      if (post.github) {
        result.push({
          label: 'Open GitHub Repo',
          icon: <GitHubIcon size={22} />,
          action: () => executeAndClose(() => window.open(post.github!, '_blank')),
          shortcut: 'G',
          group: 'contextual',
        });
      }
      if (post.demo) {
        result.push({
          label: 'View Live Demo',
          icon: <ExternalLinkIcon />,
          action: () => executeAndClose(() => window.open(post.demo!, '_blank')),
          shortcut: 'D',
          group: 'contextual',
        });
      }
      result.push({
        label: 'Scroll to Top',
        icon: <span className="w-[22px] h-[22px] flex items-center justify-center text-[13px] text-th-secondary">↑</span>,
        action: () => executeAndClose(() => window.scrollTo({ top: 0, behavior: 'smooth' })),
        shortcut: 'T',
        group: 'contextual',
      });
      result.push({
        label: 'Scroll to Bottom',
        icon: <span className="w-[22px] h-[22px] flex items-center justify-center text-[13px] text-th-secondary">↓</span>,
        action: () => executeAndClose(() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' })),
        shortcut: 'B',
        group: 'contextual',
      });
      if (nextPost) {
        result.push({
          label: `Newer: ${nextPost.displayTitle || nextPost.title}`,
          icon: <span className="w-[22px] h-[22px] flex items-center justify-center text-[13px] text-th-secondary">→</span>,
          action: () => executeAndClose(() => navigate(postPath(nextPost.category, nextPost.id))),
          shortcut: 'N',
          group: 'contextual',
        });
      }
      if (prevPost) {
        result.push({
          label: `Older: ${prevPost.displayTitle || prevPost.title}`,
          icon: <span className="w-[22px] h-[22px] flex items-center justify-center text-[13px] text-th-secondary">←</span>,
          action: () => executeAndClose(() => navigate(postPath(prevPost.category, prevPost.id))),
          shortcut: 'P',
          group: 'contextual',
        });
      }
    }

    // ── Global shortcut actions ──
    const mostRecent = [...posts]
      .filter(p => p.category !== 'fieldnotes')
      .sort((a, b) => b.date.localeCompare(a.date))[0];

    if (mostRecent) {
      result.push({
        label: `Most Recent: ${mostRecent.displayTitle || mostRecent.title}`,
        icon: <span className="w-[22px] h-[22px] flex items-center justify-center text-[13px] text-th-secondary">⏎</span>,
        action: () => executeAndClose(() => navigate(postPath(mostRecent.category, mostRecent.id))),
        shortcut: '.',
        group: 'global',
      });
    }

    result.push({
      label: `Toggle Theme (${theme === 'dark' ? 'Light' : 'Dark'})`,
      icon: theme === 'dark' ? <SunIcon /> : <MoonIcon />,
      action: () => executeAndClose(toggleTheme),
      shortcut: '⇧T',
      group: 'global',
    });

    // ── Navigation actions ──
    result.push(
      {
        label: 'Go to Home',
        icon: <HomeIcon />,
        action: () => executeAndClose(() => navigate('/home')),
        group: 'nav',
      },
      {
        label: 'View Projects',
        icon: <GearIcon />,
        action: () => executeAndClose(() => navigate('/lab/projects')),
        group: 'nav',
      },
      {
        label: 'Open Source / GitHub',
        icon: <GitHubIcon size={22} />,
        action: () => executeAndClose(() => window.open('https://github.com/infraphysics', '_blank')),
        group: 'nav',
      },
      {
        label: 'Second Brain',
        icon: <DiamondIcon />,
        action: () => executeAndClose(() => navigate('/lab/second-brain')),
        group: 'nav',
      },
      {
        label: 'Contact',
        icon: <MailIcon />,
        action: () => executeAndClose(() => navigate('/contact')),
        group: 'nav',
      },
      {
        label: 'Random Article',
        icon: (
          <span className="w-[22px] h-[22px] flex items-center justify-center bg-th-elevated rounded-sm text-[11px] text-th-secondary">
            ?
          </span>
        ),
        action: () => {
          const validPosts = posts.filter(p => p.category !== 'fieldnotes');
          if (validPosts.length === 0) return;
          const randomPost = validPosts[Math.floor(Math.random() * validPosts.length)];
          executeAndClose(() => navigate(postPath(randomPost.category, randomPost.id)));
        },
        group: 'nav',
      },
    );

    return result;
  }, [article, theme, navigate, executeAndClose, toggleTheme]);

  // Second Brain concept matches — only exact final-segment matches
  const conceptMatches = useMemo<QuickAction[]>(() => {
    const q = query.trim().toLowerCase();
    if (!q) return [];

    return allFieldNotes
      .filter(note => {
        // Match against the last segment of the address (after final /)
        const addr = note.address || '';
        const lastSeg = addr.includes('/') ? addr.split('/').pop()! : addr;
        return lastSeg.toLowerCase() === q;
      })
      .slice(0, 5)
      .map(note => ({
        label: note.displayTitle || note.title,
        icon: <DiamondIcon />,
        action: () => executeAndClose(() => navigate(`/lab/second-brain/${note.id}`)),
        group: 'concept' as const,
      }));
  }, [query, navigate, executeAndClose]);

  const filtered = useMemo(() => {
    const q = query.trim();
    if (!q) return actions;
    const lower = q.toLowerCase();
    const matchedActions = actions.filter(a => a.label.toLowerCase().includes(lower));
    // Append concept matches after action matches
    return [...matchedActions, ...conceptMatches];
  }, [query, actions, conceptMatches]);

  // Reset state on open/close
  useEffect(() => {
    if (isOpen) {
      setQuery('');
      setSelectedIndex(0);
      // Focus input after animation frame so the element is mounted
      requestAnimationFrame(() => inputRef.current?.focus());
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = '';
    }
    return () => {
      document.body.style.overflow = '';
    };
  }, [isOpen]);

  // Clamp selectedIndex when filtered list changes
  useEffect(() => {
    if (selectedIndex >= filtered.length) {
      setSelectedIndex(Math.max(0, filtered.length - 1));
    }
  }, [filtered.length, selectedIndex]);

  // Scroll selected item into view
  useEffect(() => {
    if (!listRef.current) return;
    const items = listRef.current.querySelectorAll('[data-action-item]');
    items[selectedIndex]?.scrollIntoView({ block: 'nearest' });
  }, [selectedIndex]);

  const handleKeyDown = useCallback((e: React.KeyboardEvent) => {
    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault();
        setSelectedIndex(i => (i + 1) % filtered.length);
        break;
      case 'ArrowUp':
        e.preventDefault();
        setSelectedIndex(i => (i - 1 + filtered.length) % filtered.length);
        break;
      case 'Enter':
        e.preventDefault();
        if (filtered[selectedIndex]) {
          filtered[selectedIndex].action();
        }
        break;
      case 'Escape':
        e.preventDefault();
        onClose();
        break;
    }
  }, [filtered, selectedIndex, onClose]);

  if (!isOpen) return null;

  // Group labels for visual separation
  const groupLabel = (group?: string) => {
    switch (group) {
      case 'contextual': return 'Article';
      case 'global': return 'Shortcuts';
      case 'concept': return 'Second Brain';
      default: return null;
    }
  };

  // Track which groups we've already rendered headers for
  let lastGroup: string | undefined;

  return (
    <div className="fixed inset-0 z-[100] flex items-start justify-center pt-[20vh]">
      {/* Backdrop */}
      <div
        className="absolute inset-0 bg-th-overlay"
        onClick={onClose}
      />

      {/* Panel */}
      <div
        className="relative w-full max-w-lg mx-4 rounded-xl bg-th-sidebar border border-th-border shadow-2xl animate-fade-in overflow-hidden"
        onKeyDown={handleKeyDown}
      >
        {/* Search input row */}
        <div className="flex items-center gap-3 px-4 py-3 border-b border-th-border">
          <span className="text-th-tertiary flex-shrink-0">
            <SearchIcon />
          </span>
          <input
            ref={inputRef}
            type="text"
            value={query}
            onChange={e => {
              setQuery(e.target.value);
              setSelectedIndex(0);
            }}
            placeholder="Type to search..."
            className="flex-1 bg-transparent text-th-primary placeholder:text-th-muted outline-none text-sm"
          />
          <kbd className="hidden sm:inline-flex items-center gap-1 px-1.5 py-0.5 text-[10px] text-th-tertiary bg-th-surface-alt border border-th-border rounded font-mono">
            ESC
          </kbd>
        </div>

        {/* Action list */}
        <div ref={listRef} className="py-2 max-h-[40vh] overflow-y-auto">
          {filtered.length === 0 ? (
            <div className="px-4 py-6 text-sm text-th-tertiary text-center">
              No results found
            </div>
          ) : (
            filtered.map((action, i) => {
              // Show group header when group changes
              let header: React.ReactNode = null;
              if (action.group && action.group !== lastGroup && !query.trim()) {
                const label = groupLabel(action.group);
                if (label) {
                  header = (
                    <div className="px-4 pt-2 pb-1 text-[10px] font-mono uppercase tracking-wider text-th-muted">
                      {label}
                    </div>
                  );
                }
              }
              lastGroup = action.group;

              return (
                <React.Fragment key={`${action.group}-${action.label}`}>
                  {header}
                  <button
                    data-action-item
                    onClick={action.action}
                    className={`w-full flex items-center gap-3 px-4 py-2.5 text-sm transition-colors ${
                      i === selectedIndex
                        ? 'bg-th-elevated text-th-heading'
                        : 'text-th-secondary hover:bg-th-surface-alt'
                    }`}
                  >
                    <span className={i === selectedIndex ? 'text-th-primary' : 'text-th-tertiary'}>
                      {action.icon}
                    </span>
                    <span className="flex-1 text-left truncate">{action.label}</span>
                    {action.shortcut && (
                      <kbd className="hidden sm:inline-flex items-center px-1.5 py-0.5 text-[10px] text-th-tertiary bg-th-surface-alt border border-th-border rounded font-mono ml-auto flex-shrink-0">
                        {action.shortcut}
                      </kbd>
                    )}
                  </button>
                </React.Fragment>
              );
            })
          )}
        </div>
      </div>
    </div>
  );
};


================================================================
# FILE: src/components/NavigationTrail.tsx  (67 lines)
================================================================
// Navigation trail breadcrumb for Second Brain concept browsing

import React from 'react';
import { Link } from 'react-router-dom';
import type { TrailItem } from '../hooks/useNavigationTrail';

interface NavigationTrailProps {
  trail: TrailItem[];
  onItemClick: (index: number) => void;
  onAllConceptsClick: () => void;
  isOverflowing: boolean;
}

export const NavigationTrail: React.FC<NavigationTrailProps> = ({
  trail,
  onItemClick,
  onAllConceptsClick,
  isOverflowing,
}) => {
  const hasTrail = trail.length > 0;

  return (
    <nav className="text-xs flex items-center gap-1 flex-wrap mb-3">
      {/* "all concepts" — link when trail has items, plain span on list view */}
      {hasTrail ? (
        <Link
          to="/lab/second-brain"
          onClick={onAllConceptsClick}
          className="text-violet-400 hover:text-violet-300 transition-colors"
        >
          all concepts
        </Link>
      ) : (
        <span className="text-violet-400">all concepts</span>
      )}

      {/* Overflow indicator */}
      {isOverflowing && (
        <>
          <span className="text-th-muted">&rsaquo;</span>
          <span className="text-th-muted">...</span>
        </>
      )}

      {/* Trail items */}
      {trail.map((item, i) => {
        const isLast = i === trail.length - 1;
        return (
          <React.Fragment key={`${item.id}-${i}`}>
            <span className="text-th-muted">&rsaquo;</span>
            {isLast ? (
              <span className="text-violet-400">{item.label}</span>
            ) : (
              <Link
                to={`/lab/second-brain/${item.id}`}
                onClick={() => onItemClick(i)}
                className="text-th-tertiary hover:text-violet-400 transition-colors"
              >
                {item.label}
              </Link>
            )}
          </React.Fragment>
        );
      })}
    </nav>
  );
};


================================================================
# FILE: src/components/RotatingTitle.tsx  (110 lines)
================================================================
// Rotating subtitle — official fades in/out, creatives typewrite in/out

import React, { useEffect, useRef } from 'react';

const OFFICIAL = 'Industrial engineer, Systems builder';

const creatives = [
  'Software craftsman',
  'Generalist with leverage',
  'Stack explorer',
];

const OFFICIAL_HOLD = 5700;
const FADE_MS = 400;
const TYPE_IN = { min: 40, jitter: 50 };
const TYPE_OUT = { min: 25, jitter: 30 };
const PAUSE_AFTER_TYPE = 500;
const PAUSE_BETWEEN = 200;

export const RotatingTitle: React.FC = () => {
  const spanRef = useRef<HTMLSpanElement>(null);

  useEffect(() => {
    const el = spanRef.current;
    if (!el) return;

    // Each effect invocation gets its own cancel flag object.
    // Stale loops from StrictMode double-mount see their own flag go true
    // and stop, while the fresh loop keeps its own flag false.
    const cancel = { current: false };

    const wait = (ms: number) =>
      new Promise<void>((resolve, reject) => {
        const id = setTimeout(() => {
          if (cancel.current) reject('cancelled');
          else resolve();
        }, ms);
        // If cancelled before timeout fires, we still need cleanup
        // but the reject in the timeout is sufficient
        void id;
      });

    const setFade = (opacity: number, y: number, animate: boolean) => {
      el.style.transition = animate ? `opacity ${FADE_MS}ms ease, transform ${FADE_MS}ms ease` : 'none';
      el.style.opacity = String(opacity);
      el.style.transform = `translateY(${y}px)`;
    };

    const typeIn = async (s: string) => {
      for (let i = 1; i <= s.length; i++) {
        if (cancel.current) return;
        el.textContent = s.slice(0, i);
        await wait(TYPE_IN.min + Math.random() * TYPE_IN.jitter);
      }
    };

    const typeOut = async (s: string) => {
      for (let i = s.length - 1; i >= 0; i--) {
        if (cancel.current) return;
        el.textContent = i === 0 ? '\u200B' : s.slice(0, i);
        await wait(TYPE_OUT.min + Math.random() * TYPE_OUT.jitter);
      }
    };

    const loop = async () => {
      let ci = 0;
      let first = true;
      try {
        while (!cancel.current) {
          // Official: fade in, hold, fade out
          el.textContent = OFFICIAL;
          if (first) {
            // Already visible on mount — skip entrance animation
            setFade(1, 0, false);
            first = false;
          } else {
            setFade(0, 8, false);
            await wait(30);
            setFade(1, 0, true);
            await wait(FADE_MS);
          }
          await wait(OFFICIAL_HOLD);
          setFade(0, -8, true);
          await wait(FADE_MS);
          await wait(PAUSE_BETWEEN);

          // Creative: type in, pause, type out
          setFade(1, 0, false);
          el.textContent = '\u200B';
          await typeIn(creatives[ci % creatives.length]);
          await wait(PAUSE_AFTER_TYPE);
          await typeOut(creatives[ci % creatives.length]);
          await wait(PAUSE_BETWEEN);

          ci++;
        }
      } catch {
        // Cancelled — loop exits silently
      }
    };

    loop();

    return () => {
      cancel.current = true;
    };
  }, []);

  return <span ref={spanRef} className="inline-block">{OFFICIAL}</span>;
};


================================================================
# FILE: src/components/WikiContent.tsx  (184 lines)
================================================================
// Renders HTML content with wiki-link hover preview and click navigation.

import React, { useEffect, useRef, useMemo, useState, useCallback } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { Post } from '../types';
import { resolveWikiLinks } from '../lib/wikilinks';
import { WikiLinkPreview } from './WikiLinkPreview';

interface PreviewState {
  visible: boolean;
  title: string;
  address: string;
  description: string;
  x: number;
  y: number;
}

const INITIAL_PREVIEW: PreviewState = {
  visible: false,
  title: '',
  address: '',
  description: '',
  x: 0,
  y: 0,
};

interface WikiContentProps {
  html: string;
  allFieldNotes?: Post[];
  className?: string;
  onWikiLinkClick?: (conceptId: string) => void;
}

export const WikiContent: React.FC<WikiContentProps> = ({ html, allFieldNotes, className, onWikiLinkClick }) => {
  const location = useLocation();
  const navigate = useNavigate();
  const containerRef = useRef<HTMLDivElement>(null);
  const [preview, setPreview] = useState<PreviewState>(INITIAL_PREVIEW);
  const hideTimer = useRef<ReturnType<typeof setTimeout> | null>(null);

  const resolvedHtml = useMemo(() => {
    if (!allFieldNotes) return html;
    const { html: processed } = resolveWikiLinks(html, allFieldNotes);
    return processed;
  }, [html, allFieldNotes]);

  // Kill preview on route change or content change
  useEffect(() => {
    setPreview(INITIAL_PREVIEW);
  }, [location.pathname, html]);

  useEffect(() => {
    const kill = () => setPreview(INITIAL_PREVIEW);
    window.addEventListener('scroll', kill, true);
    return () => window.removeEventListener('scroll', kill, true);
  }, []);

  const clearHide = useCallback(() => {
    if (hideTimer.current) { clearTimeout(hideTimer.current); hideTimer.current = null; }
  }, []);

  // Keep callbacks in refs so the click handler always has the latest functions
  const navigateRef = useRef(navigate);
  navigateRef.current = navigate;
  const onWikiLinkClickRef = useRef(onWikiLinkClick);
  onWikiLinkClickRef.current = onWikiLinkClick;

  // Track the currently hovered wiki link href + element for click navigation.
  const hoveredLinkRef = useRef<{ el: HTMLElement; href: string } | null>(null);

  // -----------------------------------------------------------------
  // Hover preview + click navigation.
  //   mouseover on a wiki-link  → show preview (once per distinct link)
  //   mouseover on anything else → schedule hide (80 ms debounce)
  //   mouseleave container       → instant hide
  //   click on a wiki-link       → navigate via React Router
  // -----------------------------------------------------------------
  useEffect(() => {
    const el = containerRef.current;
    if (!el) return;

    const onOver = (e: MouseEvent) => {
      const target = e.target as HTMLElement;
      const link = target.closest('a.wiki-ref-resolved') as HTMLElement | null;

      if (link) {
        clearHide();
        const href = link.getAttribute('href') || '';
        // Use string comparison — DOM element identity (?.el !== link) fails here
        // because setPreview triggers re-render → dangerouslySetInnerHTML recreates
        // DOM nodes → stored element reference goes stale → guard always passes →
        // infinite render loop (~150 renders/sec during hover, delays proportional
        // to hover duration). String href is stable across DOM recreations.
        const isNewLink = hoveredLinkRef.current?.href !== href;
        // Always refresh el reference — DOM nodes may be recreated on re-render
        hoveredLinkRef.current = { el: link, href };

        if (isNewLink) {
          const title = decodeURIComponent(link.getAttribute('data-title') || '');
          const address = link.getAttribute('data-address') || '';
          const description = decodeURIComponent(link.getAttribute('data-description') || '');
          setPreview({ visible: true, title, address, description, x: e.clientX, y: e.clientY });
        }
      } else {
        // Mouse is on non-link content — schedule hide
        if (!hideTimer.current) {
          hideTimer.current = setTimeout(() => {
            hoveredLinkRef.current = null;
            setPreview(INITIAL_PREVIEW);
            hideTimer.current = null;
          }, 80);
        }
      }
    };

    const onLeave = () => {
      clearHide();
      hoveredLinkRef.current = null;
      setPreview(INITIAL_PREVIEW);
    };

    const onClick = (e: MouseEvent) => {
      // Copy button (shared class for code blocks + blockquotes)
      const copyBtn = (e.target as HTMLElement).closest('.copy-btn') as HTMLButtonElement | null;
      if (copyBtn) {
        const svgIcon = copyBtn.querySelector('svg')?.outerHTML || '';
        let text = '';
        const terminal = copyBtn.closest('.code-terminal');
        const bkqt = copyBtn.closest('.bkqt');
        if (terminal) {
          text = terminal.querySelector('code')?.textContent || '';
        } else if (bkqt) {
          text = bkqt.querySelector('.bkqt-body')?.textContent || '';
        }
        navigator.clipboard.writeText(text).then(() => {
          copyBtn.innerHTML = `${svgIcon} Copiado`;
          copyBtn.classList.add('copied');
          setTimeout(() => { copyBtn.innerHTML = `${svgIcon} Copiar`; copyBtn.classList.remove('copied'); }, 1500);
        });
        return;
      }

      // Wiki links
      const link = (e.target as HTMLElement).closest('a.wiki-ref-resolved') as HTMLAnchorElement | null;
      if (link) {
        e.preventDefault();
        hoveredLinkRef.current = null;
        const href = link.getAttribute('href');
        if (href) {
          if (onWikiLinkClickRef.current) {
            // Second Brain context — trail management + same-tab navigation
            const match = href.match(/^\/lab\/second-brain\/(.+)$/);
            if (match) onWikiLinkClickRef.current(match[1]);
            navigateRef.current(href);
          } else {
            // Article context — open in new tab
            window.open(href, '_blank');
          }
        }
      }
    };

    el.addEventListener('mouseover', onOver);
    el.addEventListener('mouseleave', onLeave);
    el.addEventListener('click', onClick);
    return () => {
      el.removeEventListener('mouseover', onOver);
      el.removeEventListener('mouseleave', onLeave);
      el.removeEventListener('click', onClick);
      clearHide();
    };
  }, [clearHide]);

  return (
    <>
      <div
        ref={containerRef}
        className={className}
        dangerouslySetInnerHTML={{ __html: resolvedHtml }}
      />
      <WikiLinkPreview {...preview} />
    </>
  );
};


================================================================
# FILE: src/components/WikiLinkPreview.tsx  (54 lines)
================================================================
import React from 'react';
import { createPortal } from 'react-dom';

interface WikiLinkPreviewProps {
  visible: boolean;
  title: string;
  address: string;
  description: string;
  x: number;
  y: number;
}

export const WikiLinkPreview: React.FC<WikiLinkPreviewProps> = ({
  visible,
  title,
  address,
  description,
  x,
  y,
}) => {
  if (!visible) return null;

  const cardWidth = 320;
  const cardHeight = 160;
  const margin = 12;

  // Flip horizontally if too close to right edge
  let left = x + margin;
  if (left + cardWidth > window.innerWidth - margin) {
    left = x - cardWidth - margin;
  }

  // Flip vertically if too close to bottom edge
  let top = y + margin;
  if (top + cardHeight > window.innerHeight - margin) {
    top = y - cardHeight - margin;
  }

  // Clamp to viewport
  left = Math.max(margin, Math.min(left, window.innerWidth - cardWidth - margin));
  top = Math.max(margin, top);

  return createPortal(
    <div className="wiki-preview-card" style={{ left, top, pointerEvents: 'none' }}>
      <div className="wiki-preview-title">{title}</div>
      <div className="wiki-preview-address">{address}</div>
      {description && (
        <div className="wiki-preview-description">{description}</div>
      )}
      <div className="wiki-preview-hint">click to open in second brain</div>
    </div>,
    document.body
  );
};


================================================================
# FILE: src/components/icons/index.tsx  (320 lines)
================================================================
// SVG icon components

import React from 'react';

export const Logo: React.FC<{ className?: string; color?: string }> = ({ className, color }) => (
  <svg
    viewBox="0 0 992 1072"
    xmlns="http://www.w3.org/2000/svg"
    className={className}
    fill={color || "currentColor"}
  >
    <path d="M415.807 89.113 C 431.038 97.975,449.451 108.662,456.725 112.863 L 469.950 120.500 469.975 425.750 C 469.989 593.638,470.298 731.000,470.662 731.000 C 471.026 731.000,473.164 729.942,475.412 728.648 C 512.430 707.353,539.111 691.750,540.889 690.360 C 541.103 690.192,541.192 571.688,541.087 427.016 C 540.982 282.345,541.166 163.540,541.496 163.006 C 541.843 162.446,543.660 163.018,545.798 164.360 C 547.834 165.639,559.625 172.540,572.000 179.697 C 584.375 186.853,599.000 195.313,604.500 198.498 C 621.902 208.573,638.895 218.392,659.000 229.989 C 698.456 252.748,711.324 260.175,750.000 282.514 C 771.725 295.062,799.400 311.031,811.500 318.001 C 823.600 324.971,842.275 335.781,853.000 342.022 C 863.725 348.263,875.754 355.199,879.731 357.435 L 886.962 361.500 886.731 505.850 L 886.500 650.201 868.000 660.952 C 857.825 666.865,838.700 677.914,825.500 685.506 C 812.300 693.098,797.450 701.680,792.500 704.576 C 787.550 707.473,765.950 719.936,744.500 732.274 C 723.050 744.611,701.000 757.376,695.500 760.641 L 685.500 766.578 685.000 810.449 L 684.500 854.320 661.500 867.806 C 648.850 875.222,620.725 891.733,599.000 904.495 C 546.892 935.107,542.992 937.325,542.372 936.705 C 542.081 936.415,541.608 916.900,541.319 893.339 C 541.031 869.777,540.659 850.355,540.493 850.179 C 540.119 849.781,534.574 852.926,495.500 875.696 C 478.450 885.632,450.484 901.892,433.354 911.830 L 402.208 929.898 372.604 912.791 L 343.000 895.684 343.000 854.842 C 343.000 829.508,343.363 814.000,343.957 814.000 C 344.926 814.000,352.101 817.198,386.659 833.030 C 397.197 837.858,406.759 842.106,407.909 842.471 C 409.972 843.126,410.000 842.915,410.002 826.817 C 410.002 817.843,410.300 795.317,410.663 776.760 L 411.323 743.021 400.412 737.908 C 394.410 735.096,379.600 728.294,367.500 722.792 C 355.400 717.290,344.928 712.324,344.230 711.755 C 342.630 710.453,342.894 670.382,344.500 670.695 C 345.050 670.802,355.400 675.449,367.500 681.021 C 395.300 693.823,415.670 703.000,416.286 703.000 C 416.549 703.000,417.066 681.962,417.435 656.250 C 417.805 630.538,418.309 608.015,418.556 606.200 C 418.968 603.173,418.694 602.770,415.252 601.334 C 405.840 597.407,345.364 569.668,344.250 568.767 C 343.328 568.020,343.000 562.660,343.000 548.310 C 343.000 529.003,343.015 528.870,345.103 529.533 C 346.260 529.900,363.878 537.812,384.254 547.116 C 404.630 556.420,421.429 563.905,421.584 563.749 C 421.808 563.525,423.500 477.811,423.500 466.666 C 423.500 463.938,422.636 463.440,400.500 453.399 C 387.850 447.662,373.675 441.201,369.000 439.041 C 364.325 436.882,356.550 433.313,351.722 431.109 L 342.945 427.104 343.001 340.802 C 343.032 293.336,343.045 254.180,343.029 253.789 C 343.002 253.125,325.140 263.241,282.750 287.927 L 265.000 298.264 265.000 344.632 C 265.000 371.470,264.621 391.000,264.099 391.000 C 263.604 391.000,259.216 389.141,254.349 386.869 C 249.482 384.597,221.425 371.749,192.000 358.319 C 162.575 344.889,137.488 333.237,136.250 332.427 L 134.000 330.954 134.000 275.599 C 134.000 232.526,134.277 220.019,135.250 219.226 C 135.938 218.666,152.025 209.222,171.000 198.239 C 189.975 187.256,209.775 175.783,215.000 172.743 C 220.225 169.704,237.550 159.662,253.500 150.428 C 280.963 134.530,294.231 126.868,340.000 100.477 C 350.725 94.293,365.800 85.592,373.500 81.141 C 381.200 76.690,387.638 73.038,387.807 73.024 C 387.975 73.011,400.575 80.251,415.807 89.113 M685.000 502.500 C 685.000 584.656,685.258 605.991,686.250 605.957 C 686.938 605.934,701.450 597.900,718.500 588.105 L 749.500 570.295 749.757 502.737 L 750.014 435.180 733.757 425.753 C 701.753 407.194,687.151 399.000,686.084 399.000 C 685.312 399.000,685.000 428.815,685.000 502.500 M162.650 446.362 C 195.576 461.522,254.964 488.604,260.750 491.098 L 265.000 492.929 265.000 512.464 C 265.000 525.616,264.652 532.000,263.935 532.000 C 261.898 532.000,136.492 474.744,135.318 473.278 C 134.466 472.215,134.262 466.724,134.589 453.651 C 134.839 443.668,135.034 435.163,135.022 434.750 C 135.010 434.337,135.180 434.000,135.400 434.000 C 135.620 434.000,147.882 439.563,162.650 446.362 M338.633 462.630 C 346.317 466.276,349.394 478.266,344.734 486.396 C 337.659 498.737,318.656 494.978,316.352 480.782 C 314.142 467.165,326.674 456.955,338.633 462.630 M387.996 484.118 C 395.320 488.234,398.262 498.992,394.248 506.980 C 388.812 517.801,373.011 517.751,367.196 506.895 C 359.471 492.475,374.189 476.358,387.996 484.118 M184.709 598.103 C 211.544 610.260,240.475 623.447,249.000 627.406 L 264.500 634.606 264.770 655.303 C 264.919 666.686,264.831 676.000,264.575 676.000 C 264.318 676.000,255.872 672.220,245.804 667.601 C 196.486 644.971,166.178 631.158,153.000 625.303 C 131.653 615.818,133.909 619.106,134.411 598.222 C 134.963 575.219,134.926 576.000,135.459 576.000 C 135.711 576.000,157.873 585.947,184.709 598.103 M334.913 602.769 C 341.868 607.918,344.129 617.526,340.148 625.016 C 334.562 635.528,319.495 635.819,313.466 625.532 C 308.052 616.294,312.755 603.360,322.500 600.684 C 325.973 599.731,332.229 600.781,334.913 602.769 M383.913 623.769 C 390.996 629.013,393.349 639.635,389.005 646.759 C 381.226 659.519,361.629 654.444,360.295 639.324 C 359.128 626.096,373.909 616.361,383.913 623.769 M191.500 744.506 C 219.000 757.025,246.450 769.499,252.500 772.226 C 258.550 774.953,263.843 777.509,264.263 777.905 C 264.682 778.301,264.907 794.649,264.763 814.234 L 264.500 849.842 250.000 841.606 C 242.025 837.076,218.400 823.538,197.500 811.521 C 176.600 799.504,154.325 786.762,148.000 783.206 C 141.675 779.649,135.984 776.101,135.354 775.321 C 134.142 773.821,133.350 721.862,134.510 719.985 C 135.246 718.793,131.023 716.976,191.500 744.506 M327.497 741.903 C 332.480 744.739,335.000 749.473,335.000 756.000 C 335.000 765.453,328.753 772.109,319.752 772.245 C 302.097 772.512,297.782 746.420,314.500 740.485 C 318.951 738.904,323.003 739.347,327.497 741.903 M376.802 763.702 C 381.982 767.569,383.500 770.696,383.500 777.500 C 383.500 782.357,383.014 784.504,381.438 786.615 C 376.205 793.624,368.405 795.778,361.329 792.168 C 349.317 786.040,349.995 768.000,362.450 762.352 C 366.388 760.567,373.499 761.236,376.802 763.702 " fillRule="evenodd"/>
  </svg>
);

export const SearchIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
    <circle cx="11" cy="11" r="8"></circle>
    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
  </svg>
);

export const GitHubIcon: React.FC<{ className?: string; size?: number }> = ({ className, size = 16 }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="currentColor" className={className}>
    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
  </svg>
);

export const ExternalLinkIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
    <polyline points="15 3 21 3 21 9"></polyline>
    <line x1="10" y1="14" x2="21" y2="3"></line>
  </svg>
);

export const FilterIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
  </svg>
);

export const TagIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
    <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
    <line x1="7" y1="7" x2="7.01" y2="7"></line>
  </svg>
);

export const ClockIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
    <circle cx="12" cy="12" r="10"></circle>
    <polyline points="12 6 12 12 16 14"></polyline>
  </svg>
);

export const LinkIcon: React.FC<{ size?: number }> = ({ size = 14 }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
  </svg>
);

export const BookmarkIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
  </svg>
);

export const CheckCircleIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
    <polyline points="22 4 12 14.01 9 11.01"></polyline>
  </svg>
);

export const CircleIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
    <circle cx="12" cy="12" r="6"></circle>
  </svg>
);

export const ArrowRightIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <line x1="5" y1="12" x2="19" y2="12"></line>
    <polyline points="12 5 19 12 12 19"></polyline>
  </svg>
);

export const GridIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
    <rect x="3" y="3" width="7" height="7"></rect>
    <rect x="14" y="3" width="7" height="7"></rect>
    <rect x="14" y="14" width="7" height="7"></rect>
    <rect x="3" y="14" width="7" height="7"></rect>
  </svg>
);

export const ListIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
    <line x1="8" y1="6" x2="21" y2="6"></line>
    <line x1="8" y1="12" x2="21" y2="12"></line>
    <line x1="8" y1="18" x2="21" y2="18"></line>
    <line x1="3" y1="6" x2="3.01" y2="6"></line>
    <line x1="3" y1="12" x2="3.01" y2="12"></line>
    <line x1="3" y1="18" x2="3.01" y2="18"></line>
  </svg>
);

export const ChevronIcon: React.FC<{ isOpen: boolean }> = ({ isOpen }) => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="12"
    height="12"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    strokeWidth="2"
    strokeLinecap="round"
    strokeLinejoin="round"
    className={`transition-transform duration-200 ${isOpen ? 'rotate-90' : ''}`}
  >
    <polyline points="9 18 15 12 9 6"></polyline>
  </svg>
);

export const HomeIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
    <polyline points="9 22 9 12 15 12 15 22"></polyline>
  </svg>
);

export const GearIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.25" strokeLinecap="round" strokeLinejoin="round">
    <circle cx="12" cy="12" r="3"></circle>
    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
  </svg>
);

export const ThreadIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.25" strokeLinecap="round" strokeLinejoin="round">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
    <polyline points="14 2 14 8 20 8"></polyline>
    <line x1="16" y1="13" x2="8" y2="13"></line>
    <line x1="16" y1="17" x2="8" y2="17"></line>
    <polyline points="10 9 9 9 8 9"></polyline>
  </svg>
);

export const GradCapIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.25" strokeLinecap="round" strokeLinejoin="round">
    <path d="M22 10v6M2 10l10-5 10 5-10 5z"></path>
    <path d="M6 12v5c0 1.5 2.5 3 6 3s6-1.5 6-3v-5"></path>
  </svg>
);

export const DiamondIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.25" strokeLinecap="round" strokeLinejoin="round">
    <rect x="12" y="1" width="15.56" height="15.56" rx="2" transform="rotate(45 12 1)"></rect>
  </svg>
);

export const LinkedInIcon: React.FC<{ className?: string; size?: number }> = ({ className, size = 16 }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="currentColor" className={className}>
    <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
  </svg>
);

export const TwitterIcon: React.FC<{ size?: number }> = ({ size = 16 }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="currentColor">
    <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
  </svg>
);

export const RedditIcon: React.FC<{ size?: number }> = ({ size = 16 }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="currentColor">
    <path d="M11.102 7.815l.751-3.536 2.176.46a1.5 1.5 0 1 1 1.342.768l-2.062-.436-.485 2.29a8.835 8.835 0 0 1 4.252 2.007 2.5 2.5 0 0 1 3.744 3.343A5.04 5.04 0 0 1 21 14.5C21 18.09 16.97 21 12 21s-9-2.91-9-6.5a5.04 5.04 0 0 1 .18-1.289 2.5 2.5 0 0 1 3.744-3.343 8.836 8.836 0 0 1 4.178-2.053zM9.5 15a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zm5 0a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zm-7.105 1.96a.5.5 0 0 1 .67-.232c.263.132.596.236.99.3.396.063.788.095 1.177.096h.036c.39-.002.783-.034 1.18-.098.394-.064.727-.168.99-.3a.5.5 0 0 1 .437.9c-.371.185-.81.31-1.28.385A9.58 9.58 0 0 1 12 18a9.58 9.58 0 0 1-1.595-.09 4.082 4.082 0 0 1-1.28-.385.5.5 0 0 1-.23-.668z"/>
  </svg>
);

export const HackerNewsIcon: React.FC<{ size?: number }> = ({ size = 16 }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="currentColor">
    <path d="M0 0v24h24V0H0zm12.8 13.4v5.2H11v-5.1L6.7 4.6h2.3l3 6 3-6.1h2.3l-4.5 8.9z"/>
  </svg>
);

export const ClipboardIcon: React.FC<{ size?: number }> = ({ size = 16 }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
  </svg>
);

export const CheckIcon: React.FC<{ size?: number }> = ({ size = 16 }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <polyline points="20 6 9 17 4 12"></polyline>
  </svg>
);

export const MenuIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <line x1="3" y1="6" x2="21" y2="6"></line>
    <line x1="3" y1="12" x2="21" y2="12"></line>
    <line x1="3" y1="18" x2="21" y2="18"></line>
  </svg>
);

export const CloseIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <line x1="18" y1="6" x2="6" y2="18"></line>
    <line x1="6" y1="6" x2="18" y2="18"></line>
  </svg>
);

export const UserIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.25" strokeLinecap="round" strokeLinejoin="round">
    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
    <circle cx="12" cy="7" r="4"></circle>
  </svg>
);

export const MailIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.25" strokeLinecap="round" strokeLinejoin="round">
    <rect x="2" y="4" width="20" height="16" rx="2"></rect>
    <path d="M22 7l-10 7L2 7"></path>
  </svg>
);

export const SunIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
  </svg>
);

export const MoonIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
  </svg>
);

export const FolderIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
  </svg>
);

export const BarChartIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
    <line x1="18" y1="20" x2="18" y2="10"></line>
    <line x1="12" y1="20" x2="12" y2="4"></line>
    <line x1="6" y1="20" x2="6" y2="14"></line>
  </svg>
);

export const SlidersIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
    <line x1="4" y1="21" x2="4" y2="14"></line>
    <line x1="4" y1="10" x2="4" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="12"></line>
    <line x1="12" y1="8" x2="12" y2="3"></line>
    <line x1="20" y1="21" x2="20" y2="16"></line>
    <line x1="20" y1="12" x2="20" y2="3"></line>
    <line x1="1" y1="14" x2="7" y2="14"></line>
    <line x1="9" y1="8" x2="15" y2="8"></line>
    <line x1="17" y1="16" x2="23" y2="16"></line>
  </svg>
);

export const PanelLeftCloseIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
    <rect x="3" y="3" width="18" height="18" rx="2"></rect>
    <path d="M9 3v18"></path>
    <path d="M16 15l-3-3 3-3"></path>
  </svg>
);

export const PanelLeftOpenIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
    <rect x="3" y="3" width="18" height="18" rx="2"></rect>
    <path d="M9 3v18"></path>
    <path d="M14 9l3 3-3 3"></path>
  </svg>
);

export const FileTextIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
    <polyline points="14 2 14 8 20 8"></polyline>
    <line x1="16" y1="13" x2="8" y2="13"></line>
    <line x1="16" y1="17" x2="8" y2="17"></line>
    <line x1="10" y1="9" x2="8" y2="9"></line>
  </svg>
);

export const PlayCircleIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <circle cx="12" cy="12" r="10"></circle>
    <polygon points="10 8 16 12 10 16 10 8"></polygon>
  </svg>
);

export const SortAscIcon: React.FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
    <path d="M11 5h10"></path>
    <path d="M11 9h7"></path>
    <path d="M11 13h4"></path>
    <path d="M3 17l3 3 3-3"></path>
    <path d="M6 18V4"></path>
  </svg>
);



================================================================
# FILE: src/views/index.ts  (10 lines)
================================================================
// Views barrel exports

export * from './HomeView';
export * from './AboutView';
export * from './ContactView';
export * from './ThanksView';
export * from './SectionView';
export * from './PostView';
export * from './ArticlePostView';
export * from './SecondBrainView';


================================================================
# FILE: src/views/HomeView.tsx  (380 lines)
================================================================
// Home page view — minimalist cosmic landing

import React, { useState, useMemo, useRef } from 'react';
import { Link } from 'react-router-dom';
import { posts } from '../data/data';
import { Post } from '../types';
import { ArrowRightIcon, SearchIcon } from '../components/icons';
import { CATEGORY_CONFIG, getThemedColor, postPath, sectionPath } from '../config/categories';
import { useTheme } from '../contexts/ThemeContext';
import { stripHtml } from '../lib';
import homeFeaturedData from '../data/home-featured.generated.json';

// Resolve featured post refs ("category/id") to actual Post objects
type DisplayPost = Post & { highlight?: string };

function resolveFeatured(refs: { ref: string; highlight?: string }[]): DisplayPost[] {
  const resolved: DisplayPost[] = [];
  for (const entry of refs) {
    const [category, id] = entry.ref.split('/');
    const post = posts.find(p => p.category === category && p.id === id);
    if (post) {
      resolved.push({ ...post, highlight: entry.highlight });
    }
  }
  return resolved;
}

const categoryKeys = ['projects', 'threads', 'bits2bricks'] as const;

export const HomeView: React.FC = () => {
  const { theme } = useTheme();
  const featuredPosts = useMemo(() => resolveFeatured(homeFeaturedData.featured), []);

  // Post counts per category
  const categoryCounts = useMemo(() => {
    const counts: Record<string, number> = {};
    for (const key of categoryKeys) {
      counts[key] = posts.filter(p => p.category === key).length;
    }
    return counts;
  }, []);

  // Inject latest non-fieldnotes post if not already featured
  const { displayPosts, latestNewId } = useMemo(() => {
    const nonFieldnotes = posts.filter(p => p.category !== 'fieldnotes');
    const sorted = [...nonFieldnotes].sort(
      (a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()
    );
    const latest = sorted[0];
    if (latest && !featuredPosts.some(fp => fp.id === latest.id && fp.category === latest.category)) {
      return {
        displayPosts: [{ ...latest } as DisplayPost, ...featuredPosts],
        latestNewId: latest.id,
      };
    }
    return { displayPosts: featuredPosts, latestNewId: null as string | null };
  }, [featuredPosts]);

  // Second Brain stats
  const brainStats = useMemo(() => {
    const fieldnotes = posts.filter(p => p.category === 'fieldnotes');
    const totalRefs = fieldnotes.reduce((sum, fn) => sum + (fn.references?.length || 0), 0);
    return { notes: fieldnotes.length, connections: totalRefs };
  }, []);

  // Unified search
  const [searchQuery, setSearchQuery] = useState('');
  const searchRef = useRef<HTMLInputElement>(null);

  // Recent article history from localStorage
  const recentPosts = useMemo(() => {
    try {
      const raw = localStorage.getItem('infraphysics:article-history');
      if (!raw) return [];
      const history: { category: string; id: string }[] = JSON.parse(raw);
      const resolved: Post[] = [];
      for (const h of history) {
        const post = posts.find(p => p.category === h.category && p.id === h.id);
        if (post) resolved.push(post);
      }
      return resolved;
    } catch { return []; }
  }, []);

  const searchResults = useMemo(() => {
    const q = searchQuery.trim().toLowerCase();
    if (!q) return null;

    const getMatchCount = (text: string): number => {
      const plain = stripHtml(text).toLowerCase();
      let count = 0;
      let pos = 0;
      while ((pos = plain.indexOf(q, pos)) !== -1) {
        count++;
        pos += q.length;
      }
      return count;
    };

    const getExcerpt = (content: string): string | null => {
      const plain = stripHtml(content);
      const index = plain.toLowerCase().indexOf(q);
      if (index === -1) return null;
      const start = Math.max(0, index - 50);
      const end = Math.min(plain.length, index + 100);
      return '\u2026' + plain.substring(start, end) + '\u2026';
    };

    const allPosts = posts.filter(p => p.category !== 'fieldnotes');
    const matches: { post: Post; matchCount: number; excerpt: string | null }[] = [];
    const counts: Record<string, number> = { projects: 0, threads: 0, bits2bricks: 0 };

    for (const post of allPosts) {
      const title = (post.displayTitle || post.title || '').toLowerCase();
      const desc = (post.description || '').toLowerCase();
      const content = stripHtml(post.content || '').toLowerCase();

      if (title.includes(q) || desc.includes(q) || content.includes(q)) {
        const mc = getMatchCount(post.displayTitle || post.title || '')
          + getMatchCount(post.description || '')
          + getMatchCount(post.content || '');
        const excerpt = getExcerpt(post.content || '') || getExcerpt(post.description || '');
        matches.push({ post, matchCount: mc, excerpt });
        counts[post.category] = (counts[post.category] || 0) + 1;
      }
    }

    matches.sort((a, b) => b.matchCount - a.matchCount);
    return { matches, counts };
  }, [searchQuery]);

  return (
    <div className="flex flex-col animate-fade-in font-sans">

      {/* Hero */}
      <section className="pt-8 md:pt-20 pb-20">
        <div className="max-w-xl">
          <h1 className="text-4xl md:text-5xl font-bold tracking-tight leading-tight mb-3">
            <span className="text-th-heading">From systems to atoms</span>
            <br />
            <span className="text-th-secondary">and back.</span>
          </h1>

          <p className="text-sm text-th-tertiary italic tracking-wide mb-8">
            Engineering is engineering. The substrate doesn't matter.
          </p>

          <p className="text-th-secondary leading-relaxed text-base max-w-lg">
            Industrial engineer by training. I picked up code because every engineer
            should &mdash; not to become a developer, but to move faster. Now I build at the boundary.
          </p>

          <p className="text-th-secondary leading-relaxed text-base max-w-lg mt-3">
            This is my <span className="text-th-heading font-semibold">lab</span>, my <span className="text-th-heading font-semibold">notebook</span>, and my <span className="text-th-heading font-semibold">proof of work</span>.
          </p>

          <p className="mt-4 text-sm text-th-tertiary">
            by{' '}
            <Link to="/about" className="text-th-secondary hover:text-th-heading transition-colors underline underline-offset-4 decoration-th-border">
              Yago Mendoza
            </Link>
            {' '}&mdash; industrial engineer, systems builder
          </p>
        </div>
      </section>

      {/* Categories */}
      <section className="pb-16 border-t border-th-border pt-12">
        <h2 className="text-xs text-th-tertiary uppercase tracking-wider mb-8">Explore</h2>

        {/* Search input */}
        <div className="flex-1 group flex items-center border border-th-border px-3 py-2.5 focus-within:border-th-border-active transition-colors bg-th-surface-alt mb-6">
          <span className="text-th-tertiary"><SearchIcon /></span>
          <input
            ref={searchRef}
            type="text"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            onKeyDown={(e) => { if (e.key === 'Escape') { setSearchQuery(''); searchRef.current?.blur(); } }}
            placeholder="Search across all categories..."
            spellCheck={false}
            autoComplete="off"
            className="w-full bg-transparent border-none ml-2.5 text-sm focus:outline-none placeholder-th-tertiary text-th-primary"
          />
        </div>

        {searchResults ? (
          <div>
            {/* Category count bar */}
            <div className="flex flex-wrap gap-x-6 gap-y-1 mb-6 text-xs text-th-tertiary">
              {categoryKeys.map(key => {
                const config = CATEGORY_CONFIG[key];
                const tc = getThemedColor(key, theme as 'dark' | 'light');
                const count = searchResults.counts[key] || 0;
                return (
                  <span key={key} className="flex items-center gap-1.5">
                    <span className={`inline-block w-2 h-2 rounded-full bg-${tc.color}`} />
                    <span className="text-th-secondary">{config.title}</span>
                    <span className="text-th-tertiary">&mdash; {count}</span>
                  </span>
                );
              })}
            </div>

            {/* Results list */}
            {searchResults.matches.length > 0 ? (
              <div className="space-y-2 max-h-[60vh] overflow-y-auto pr-1">
                {searchResults.matches.map(({ post, matchCount, excerpt }) => {
                  const tc = getThemedColor(post.category, theme as 'dark' | 'light');
                  return (
                    <Link
                      key={`${post.category}-${post.id}`}
                      to={postPath(post.category, post.id)}
                      className="group flex items-start gap-3 p-3 border border-th-border rounded-sm bg-th-surface hover:border-th-border-active hover:bg-th-surface-alt transition-all"
                    >
                      <span className={`mt-1.5 inline-block w-2 h-2 rounded-full shrink-0 bg-${tc.color}`} />
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2">
                          <span className="text-sm text-th-heading font-medium group-hover:text-blue-400 transition-colors truncate">
                            {post.displayTitle || post.title}
                          </span>
                          <span className={`shrink-0 text-[10px] px-1.5 py-0.5 rounded text-${tc.color} bg-${tc.color}/10`}>
                            &times;{matchCount}
                          </span>
                        </div>
                        {excerpt && (
                          <p className="text-xs text-th-tertiary mt-1 line-clamp-1 font-sans">{excerpt}</p>
                        )}
                      </div>
                    </Link>
                  );
                })}
              </div>
            ) : (
              <p className="text-sm text-th-tertiary py-8 text-center">No results found.</p>
            )}
          </div>
        ) : (
          <>
            {/* Recent articles from history */}
            {recentPosts.length > 0 && (
              <div className="mb-6">
                <h3 className="text-[10px] text-th-tertiary uppercase tracking-wider mb-3">Previous</h3>
                <div className="space-y-1">
                  {recentPosts.map(post => {
                    const tc = getThemedColor(post.category, theme as 'dark' | 'light');
                    return (
                      <Link
                        key={`${post.category}-${post.id}`}
                        to={postPath(post.category, post.id)}
                        className="group flex items-center gap-2.5 px-3 py-2 rounded-sm hover:bg-th-surface-alt transition-all"
                      >
                        <span className={`inline-block w-1.5 h-1.5 rounded-full shrink-0 bg-${tc.color}`} />
                        <span className="text-sm text-th-secondary group-hover:text-th-heading transition-colors truncate">
                          {post.displayTitle || post.title}
                        </span>
                      </Link>
                    );
                  })}
                </div>
              </div>
            )}

            <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
              {categoryKeys.map(key => {
                const config = CATEGORY_CONFIG[key];
                return (
                  <Link
                    key={key}
                    to={sectionPath(key)}
                    className="group p-5 border border-th-border rounded-sm bg-th-surface hover:border-th-border-active hover:bg-th-surface-alt transition-all"
                  >
                    <div className="flex items-center gap-3 mb-3">
                      <span className="text-th-secondary group-hover:text-th-primary transition-colors">{config.icon}</span>
                      <h3 className="text-th-heading font-semibold">{config.title}</h3>
                    </div>
                    <p className="text-th-secondary text-sm leading-relaxed line-clamp-2 mb-3 font-sans">
                      {config.description}
                    </p>
                    <span className="text-xs text-th-tertiary">
                      {categoryCounts[key]} {categoryCounts[key] === 1 ? 'post' : 'posts'}
                    </span>
                  </Link>
                );
              })}
            </div>
          </>
        )}
      </section>

      {/* Latest Work */}
      <section className="pb-16 border-t border-th-border pt-12">
        <h2 className="text-xs text-th-tertiary uppercase tracking-wider mb-8">Latest Work</h2>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
          {displayPosts.map(post => (
            <Link
              key={`${post.category}-${post.id}`}
              to={postPath(post.category, post.id)}
              className="group p-5 border border-th-border rounded-sm bg-th-surface hover:border-th-border-active hover:bg-th-surface-alt transition-all flex flex-col"
            >
              {post.thumbnail && (
                <div className="relative mb-4">
                  <img
                    src={post.thumbnail}
                    alt=""
                    className="w-full h-32 object-cover rounded"
                  />
                  {post.id === latestNewId && (
                    <span className="absolute -top-3 -left-3 z-10 px-2.5 py-1 text-xs font-bold uppercase tracking-wider text-black bg-white rounded-sm shadow-lg">
                      New
                    </span>
                  )}
                </div>
              )}

              <div className="flex items-center gap-2 mb-3">
                <span className={`inline-block px-2 py-0.5 text-[10px] uppercase border rounded-sm ${(() => {
                  const tc = getThemedColor(post.category, theme as 'dark' | 'light');
                  return `text-${tc.color} border-${tc.color}/30 bg-${tc.color}/10`;
                })()}`}>
                  {post.category}
                </span>
              </div>

              <h3 className="text-th-heading font-semibold leading-snug mb-2 group-hover:text-blue-400 transition-colors lowercase">
                {post.displayTitle || post.title}
              </h3>

              <p className="text-th-secondary text-sm leading-relaxed line-clamp-2 font-sans">
                {post.highlight || post.description}
              </p>

              <span className="inline-flex items-center gap-1 mt-auto pt-4 text-xs text-th-tertiary group-hover:text-blue-400 transition-colors">
                Read <ArrowRightIcon />
              </span>
            </Link>
          ))}
        </div>
      </section>

      {/* Second Brain */}
      <section className="pb-16 border-t border-th-border pt-12">
        <div className="max-w-xl">
          <h2 className="text-xs text-violet-400 uppercase tracking-wider mb-4">Second Brain</h2>
          <p className="text-th-secondary leading-relaxed mb-4 font-sans">
            Everything I know, linked together. A growing knowledge graph.
          </p>
          <div className="flex gap-6 mb-6">
            <span className="text-sm text-th-tertiary">
              <span className="text-th-heading font-semibold">{brainStats.notes}</span> notes
            </span>
            <span className="text-sm text-th-tertiary">
              <span className="text-th-heading font-semibold">{brainStats.connections}</span> connections
            </span>
          </div>
          <Link
            to="/lab/second-brain"
            className="inline-flex items-center gap-1 text-sm text-violet-400 hover:text-violet-300 transition-colors"
          >
            Open Second Brain <ArrowRightIcon />
          </Link>
        </div>
      </section>

      {/* CTA */}
      <section className="pb-16 border-t border-th-border pt-12">
        <p className="text-th-secondary text-sm font-sans">
          Interested in collaborating?{' '}
          <Link
            to="/contact"
            className="text-th-heading hover:text-blue-400 transition-colors underline underline-offset-4 decoration-th-border"
          >
            Get in touch
          </Link>.
        </p>
      </section>
    </div>
  );
};


================================================================
# FILE: src/views/AboutView.tsx  (163 lines)
================================================================
// About page — bio, philosophy, and CTA

import React from 'react';
import { Link } from 'react-router-dom';
import { RotatingTitle } from '../components/RotatingTitle';

export const AboutView: React.FC = () => {
  return (
    <div className="flex flex-col animate-fade-in">

      {/* Hero: Photo + Name + Rotating subtitle */}
      <section className="pb-16">
        <div className="relative mb-16 pt-4">
          {/* Photo + Quote row */}
          <div className="flex items-center gap-6 mb-6">
            {/* Photo — large, with subtle glow */}
            <div className="relative w-28 h-28 md:w-36 md:h-36 shrink-0">
              <div className="absolute inset-0 rounded-full bg-violet-400/10 blur-2xl scale-125" />
              <img
                src="https://avatars.githubusercontent.com/yago-mendoza"
                alt="Yago Mendoza"
                className="relative w-full h-full rounded-full border border-th-border object-cover"
              />
            </div>

            {/* Quote beside photo */}
            <blockquote className="relative pl-6 pr-6">
              <span
                className="absolute -left-1 -top-2 text-6xl leading-none text-th-heading select-none font-serif"
                aria-hidden="true"
              >
                &ldquo;
              </span>
              <p className="text-th-secondary text-lg md:text-xl leading-relaxed italic">
                My competitive advantage is<br className="hidden md:inline" /> that I'm having fun.
                <span className="relative inline-block w-0">
                  <span className="absolute left-0 -bottom-9 text-6xl leading-none text-th-heading select-none font-serif" aria-hidden="true">&rdquo;
                  </span>
                </span>
              </p>
            </blockquote>
          </div>

          {/* Name */}
          <h1 className="text-4xl md:text-5xl font-bold tracking-tight text-th-heading mb-2">
            Yago Mendoza
          </h1>

          {/* Rotating subtitle */}
          <p className="text-base text-th-secondary h-6 mb-5">
            <RotatingTitle />
          </p>

          {/* Tagline */}
          <p className="text-th-primary leading-relaxed max-w-xl">
              I'm into building things and making them move faster. I use AI to unlock compute, document everything I learn, and publish it here—because building in public is how I think best.
          </p>
        </div>

        {/* The Journey */}
        <div className="mb-14">
          <h2 className="text-xs text-th-tertiary uppercase tracking-wider mb-6">The Journey</h2>

          <div className="space-y-8 max-w-2xl font-sans">
            <div>
              <h3 className="text-th-heading font-semibold mb-2">The Convergence</h3>
              <p className="text-th-secondary leading-relaxed">
                I learned to build by watching systems fail. My industrial engineering training: design from the failure point backward: find the bottleneck, then architect around it. Hardware and software aren't separate worlds to me; they're two sides of the same constraint. The critical problems live where bits meet atoms.
              </p>
              
            </div>

            <div>
              <h3 className="text-th-heading font-semibold mb-2">The Work</h3>
              <p className="text-th-secondary leading-relaxed">
              Those worlds are converging faster than anyone expected. AI, infrastructure, distributed systems. This is where I build. I'm drawn to problems where software meets physical limits. Whether it's in a hyperscale data center or a constrained edge device, I want to understand the physics, not just abstract it away.
              </p>
            </div>

            <div>
              <h3 className="text-th-heading font-semibold mb-2">The Record</h3>
              <p className="text-th-secondary leading-relaxed">
                This site is a living, interconnected record. I document the process because clear thinking requires writing it down.
              </p>
            </div>
          </div>
        </div>

        {/* What I Believe */}
        <div className="mb-14">
          <h2 className="text-xs text-th-tertiary uppercase tracking-wider mb-6">What I Believe</h2>

          <div className="space-y-4 max-w-2xl font-sans">
            <div className="flex gap-3">
              <span className="text-th-tertiary shrink-0 mt-0.5">—</span>
              <p className="text-th-secondary leading-relaxed">To truly build, it seems essential to move beyond narrow specialization and understand the entire stack. Removing black boxes—from the bare metal to the reasoning model—allows for genuine agency over the system.</p>
            </div>
            <div className="flex gap-3">
              <span className="text-th-tertiary shrink-0 mt-0.5">—</span>
              <p className="text-th-secondary leading-relaxed">The rate-limiting step for progress often isn't software; it is atoms. We cannot cheat thermodynamics. We can only build the missing infrastructure to bridge the gap. The faster we deploy reliable, production-grade substrate that satisfies real constraints at scale—from data centers to edge devices—the faster humanity accelerates.</p>
            </div>
            <div className="flex gap-3">
              <span className="text-th-tertiary shrink-0 mt-0.5">—</span>
              <p className="text-th-secondary leading-relaxed">Intelligence should arguably be as ubiquitous and invisible as electricity. As capabilities expand, so do the problems we attempt to solve with them. Building the rigorous infrastructure to make compute a silent, fundamental resource becomes the priority.</p>
            </div>
            <div className="flex gap-3">
              <span className="text-th-tertiary shrink-0 mt-0.5">—</span>
              <p className="text-th-secondary leading-relaxed">The patterns that scale are the ones that transfer. Good principles don't know what domain they're solving for—they work because they're indifferent to it. What looks like separate problems often shares the same structure.</p>
            </div>
            <div className="flex gap-3">
              <span className="text-th-tertiary shrink-0 mt-0.5">—</span>
              <p className="text-th-secondary leading-relaxed">Optimism is perhaps a necessary, pragmatic stance. It suggests that by solving the hard physical constraints today, we might unlock the freedom to pursue a better future tomorrow.</p>
            </div>
            <div className="flex gap-3">
              <span className="text-th-tertiary shrink-0 mt-0.5">—</span>
              <p className="text-th-secondary leading-relaxed">In a world of infinite problems and finite time, passion is the only sustainable filter. I work on what I can't stop thinking about—not because it's strategic, but because it's the only sustainable way to outlast hard problems. Obsession compounds.</p>
            </div>
            <div className="flex gap-3">
              <span className="text-th-tertiary shrink-0 mt-0.5">—</span>
              <p className="text-th-secondary leading-relaxed">The future is bright.</p>
            </div>
          </div>
        </div>

        {/* Beyond the Stack */}
        <div className="mb-14">
          <h2 className="text-xs text-th-tertiary uppercase tracking-wider mb-6">Beyond the Stack</h2>

          <div className="space-y-6 max-w-2xl font-sans">
            <p className="text-th-secondary leading-relaxed">
              I study how organizations scale, how technologies fail, and how to make hard things feel simple. It turns out patterns surface everywhere. The best engineers I know aren't just good at code—they're good at understanding why systems exist the way they do.
            </p>
            <p className="text-th-secondary leading-relaxed">
              Outside of engineering, I try to keep things simple. I read because good writing forces clear thinking, and I write to figure out what I actually believe. Most of what I learn gets documented because patterns are easier to catch when they're on paper. Memory is terrible at version control.
            </p>
            <p className="text-th-secondary leading-relaxed">
              I lift weights, eat well, sleep enough. Boring fundamentals, but they work. The goal in all of it is the same: understand better, need less.
            </p>
          </div>
        </div>

        {/* CTA */}
        <div className="pt-8 border-t border-th-border">
          <p className="text-th-secondary text-sm font-sans">
            Want to connect? Head to the{' '}
            <Link to="/contact" className="text-th-heading hover:text-blue-400 transition-colors underline underline-offset-4 decoration-th-border">
              contact page
            </Link>
            {' '}or find me on{' '}
            <a
              href="https://x.com/ymdatweets"
              target="_blank"
              rel="noopener noreferrer"
              className="text-th-heading hover:text-blue-400 transition-colors underline underline-offset-4 decoration-th-border"
            >
              &#x1D54F;
            </a>.
          </p>
        </div>
      </section>
    </div>
  );
};


================================================================
# FILE: src/views/ContactView.tsx  (178 lines)
================================================================
// Contact page — form, social links, theme-aware

import React, { useState } from 'react';
import { GitHubIcon, LinkedInIcon, TwitterIcon } from '../components/icons';

export const ContactView: React.FC = () => {
  const [status, setStatus] = useState<'idle' | 'submitting' | 'error'>('idle');

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setStatus('submitting');

    const form = e.currentTarget;
    const data = new FormData(form);

    try {
      const res = await fetch('https://formspree.io/f/xojwnobl', {
        method: 'POST',
        body: data,
        headers: { Accept: 'application/json' },
      });

      if (res.ok) {
        window.location.href = '/thanks';
      } else {
        setStatus('error');
      }
    } catch {
      setStatus('error');
    }
  };

  return (
    <div className="flex flex-col animate-fade-in">
      <section className="pt-6 md:pt-10 pb-16">
        <h1 className="text-3xl md:text-4xl font-bold tracking-tight text-th-heading mb-3">
          Let's talk
        </h1>
        <p className="text-th-secondary text-sm font-sans mb-2 max-w-lg leading-relaxed">
          Whether it's a question, a collaboration idea, or just a conversation worth having — drop me a line.
          I typically respond within a few days.
        </p>
        <p className="text-th-secondary text-sm font-sans mb-12 max-w-lg leading-relaxed">
          I'm especially interested in conversations about distributed systems, complexity science, optimisation and software/hardware projects.
        </p>

        {/* Contact Form */}
        <form onSubmit={handleSubmit} className="max-w-lg mb-14">
          <div className="flex flex-col gap-5">
            <div>
              <label htmlFor="name" className="block text-xs text-th-tertiary uppercase tracking-wider mb-2">
                Name
              </label>
              <input
                type="text"
                id="name"
                name="name"
                required
                className="w-full px-4 py-3 bg-th-surface-alt border border-th-border rounded-sm text-th-heading text-sm
                           placeholder-th-muted outline-none transition-colors
                           focus:border-th-border-active focus:bg-th-elevated"
                placeholder="Your name"
              />
            </div>

            <div>
              <label htmlFor="email" className="block text-xs text-th-tertiary uppercase tracking-wider mb-2">
                Email
              </label>
              <input
                type="email"
                id="email"
                name="email"
                required
                className="w-full px-4 py-3 bg-th-surface-alt border border-th-border rounded-sm text-th-heading text-sm
                           placeholder-th-muted outline-none transition-colors
                           focus:border-th-border-active focus:bg-th-elevated"
                placeholder="you@example.com"
              />
            </div>

            <div>
              <label htmlFor="message" className="block text-xs text-th-tertiary uppercase tracking-wider mb-2">
                Message
              </label>
              <textarea
                id="message"
                name="message"
                required
                rows={5}
                className="w-full px-4 py-3 bg-th-surface-alt border border-th-border rounded-sm text-th-heading text-sm
                           placeholder-th-muted outline-none transition-colors resize-y
                           focus:border-th-border-active focus:bg-th-elevated"
                placeholder="What's on your mind?"
              />
            </div>
          </div>

          {status === 'error' && (
            <p className="text-red-400 text-xs mt-3">
              Something went wrong. You can also reach me at contact@infraphysics.net.
            </p>
          )}

          <button
            type="submit"
            disabled={status === 'submitting'}
            className="mt-6 px-6 py-2.5 bg-th-active border border-th-border rounded-sm text-th-heading text-sm
                       transition-all hover:bg-th-active-hover hover:border-th-border-hover
                       disabled:opacity-40 disabled:cursor-not-allowed"
          >
            {status === 'submitting' ? 'Sending...' : 'Send message'}
          </button>

          <p className="mt-6 text-xs text-th-muted leading-relaxed">
            Not a form person —{' '}
            <a href="mailto:contact@infraphysics.net" className="text-th-tertiary hover:text-th-heading transition-colors">
              contact@infraphysics.net
            </a>
            {' '}or{' '}
            <a href="mailto:yagomj@gmail.com" className="text-th-tertiary hover:text-th-heading transition-colors">
              yagomj@gmail.com
            </a>
            {' '}work just as well.
          </p>
        </form>

        {/* Elsewhere */}
        <div className="mb-14">
          <h2 className="text-xs text-th-tertiary uppercase tracking-wider mb-6">Elsewhere</h2>

          <div className="flex flex-col gap-4">
            <a
              href="https://linkedin.com/in/yago-mendoza"
              target="_blank"
              rel="noopener noreferrer"
              className="flex items-center gap-3 text-th-secondary hover:text-th-heading transition-colors group"
            >
              <span className="p-2 border border-th-border rounded-sm group-hover:border-th-border-active transition-colors">
                <LinkedInIcon />
              </span>
              <span className="text-sm font-sans">linkedin.com/in/<span className="text-th-heading">yago-mendoza</span></span>
            </a>

            <a
              href="https://github.com/yago-mendoza"
              target="_blank"
              rel="noopener noreferrer"
              className="flex items-center gap-3 text-th-secondary hover:text-th-heading transition-colors group"
            >
              <span className="p-2 border border-th-border rounded-sm group-hover:border-th-border-active transition-colors">
                <GitHubIcon />
              </span>
              <span className="text-sm font-sans">github.com/<span className="text-th-heading">yago-mendoza</span></span>
            </a>

            <a
              href="https://x.com/ymdatweets"
              target="_blank"
              rel="noopener noreferrer"
              className="flex items-center gap-3 text-th-secondary hover:text-th-heading transition-colors group"
            >
              <span className="p-2 border border-th-border rounded-sm group-hover:border-th-border-active transition-colors">
                <TwitterIcon />
              </span>
              <span className="text-sm font-sans">x.com/<span className="text-th-heading">@ymdatweets</span></span>
            </a>
          </div>
        </div>

        {/* Tiny copyright footer */}
        <div className="pt-6 border-t border-th-border text-[10px] text-th-muted">
          &copy; {new Date().getFullYear()} InfraPhysics
        </div>
      </section>
    </div>
  );
};


================================================================
# FILE: src/views/ThanksView.tsx  (24 lines)
================================================================
// Thank-you page shown after contact form submission

import React from 'react';
import { Link } from 'react-router-dom';

export const ThanksView: React.FC = () => {
  return (
    <div className="flex flex-col animate-fade-in items-center justify-center min-h-[60vh] text-center">
      <h1 className="text-3xl md:text-4xl font-bold tracking-tight text-th-heading mb-3">
        Message received
      </h1>
      <p className="text-th-secondary text-sm font-sans mb-10 max-w-md leading-relaxed">
        Thanks for reaching out. I'll get back to you as soon as I can.
      </p>
      <Link
        to="/home"
        className="px-6 py-2.5 bg-th-active border border-th-border rounded-sm text-th-heading text-sm
                   transition-all hover:bg-th-active-hover hover:border-th-border-hover"
      >
        Back to home
      </Link>
    </div>
  );
};


================================================================
# FILE: src/views/SectionView.tsx  (332 lines)
================================================================
// Category listing view component (projects, threads, bits2bricks) — theme-aware

import React, { useMemo, useState, useEffect, useRef } from 'react';
import { Link } from 'react-router-dom';
import { posts } from '../data/data';
import { Category } from '../types';
import { calculateReadingTime, stripHtml } from '../lib';
import { CATEGORY_CONFIG, getThemedColor } from '../config/categories';
import { useSectionState } from '../contexts/SectionStateContext';
import { useTheme } from '../contexts/ThemeContext';
import {
  SearchIcon,
  FilterIcon,
} from '../components/icons';
import {
  Bits2BricksGrid,
  ProjectsList,
  ThreadsList,
} from '../components/sections';
import type { SectionRendererProps } from '../components/sections';

interface SectionViewProps {
  category: Category;
}

const SECTION_RENDERERS: Record<string, React.FC<SectionRendererProps>> = {
  projects: ProjectsList,
  threads: ThreadsList,
  bits2bricks: Bits2BricksGrid,
};

const PAGE_CONFIG: Record<string, { initial: number; page: number }> = {
  projects: { initial: 3, page: 3 },
  threads: { initial: 3, page: 3 },
  bits2bricks: { initial: 3, page: 3 },
};

const STATUS_FILTER_CONFIG: Record<string, { label: string; color: string }> = {
  'ongoing': { label: 'Ongoing', color: 'violet-400' },
  'implemented': { label: 'Implemented', color: 'amber-600' },
};

export const SectionView: React.FC<SectionViewProps> = ({ category }) => {
  const { getState, setState: setSectionState } = useSectionState();
  const { query, sortBy, showFilters, selectedTopics, selectedTechs, selectedStatuses, visibleCount } = getState(category);
  const setQuery = (q: string) => setSectionState(category, { query: q });
  const setSortBy = (s: 'newest' | 'oldest' | 'title') => setSectionState(category, { sortBy: s });
  const setShowFilters = (f: boolean) => setSectionState(category, { showFilters: f });
  const toggleTopic = (t: string) => setSectionState(category, { selectedTopics: selectedTopics.includes(t) ? selectedTopics.filter(x => x !== t) : [...selectedTopics, t] });
  const toggleTech = (t: string) => setSectionState(category, { selectedTechs: selectedTechs.includes(t) ? selectedTechs.filter(x => x !== t) : [...selectedTechs, t] });
  const toggleStatus = (s: string) => setSectionState(category, { selectedStatuses: selectedStatuses.includes(s) ? selectedStatuses.filter(x => x !== s) : [...selectedStatuses, s] });

  const { theme } = useTheme();

  const sectionPosts = useMemo(() => posts.filter(p => p.category === category), [category]);

  const allTopics = useMemo(() => [...new Set(sectionPosts.flatMap(p => p.tags || []))].sort(), [sectionPosts]);
  const allTechs = useMemo(() => [...new Set(sectionPosts.flatMap(p => p.technologies || []))].sort(), [sectionPosts]);
  const allStatuses = useMemo(() => {
    const statuses = [...new Set(sectionPosts.map(p => p.status).filter(Boolean))] as string[];
    const order = ['ongoing', 'implemented'];
    return statuses.sort((a, b) => order.indexOf(a) - order.indexOf(b));
  }, [sectionPosts]);

  const topicCounts = useMemo(() => {
    const map: Record<string, number> = {};
    for (const p of sectionPosts) for (const t of p.tags || []) map[t] = (map[t] || 0) + 1;
    return map;
  }, [sectionPosts]);

  const techCounts = useMemo(() => {
    const map: Record<string, number> = {};
    for (const p of sectionPosts) for (const t of p.technologies || []) map[t] = (map[t] || 0) + 1;
    return map;
  }, [sectionPosts]);

  const statusCounts = useMemo(() => {
    const map: Record<string, number> = {};
    for (const p of sectionPosts) if (p.status) map[p.status] = (map[p.status] || 0) + 1;
    return map;
  }, [sectionPosts]);

  const filteredPosts = useMemo(() => {
    let result = sectionPosts;

    if (query) {
      const lowerQuery = query.toLowerCase();
      result = result.filter(p =>
        (p.displayTitle || p.title).toLowerCase().includes(lowerQuery) ||
        p.description.toLowerCase().includes(lowerQuery) ||
        stripHtml(p.content).toLowerCase().includes(lowerQuery)
      );
    }

    if (selectedTopics.length > 0) {
      result = result.filter(p => selectedTopics.some(t => (p.tags || []).includes(t)));
    }

    if (selectedTechs.length > 0) {
      result = result.filter(p => selectedTechs.some(t => (p.technologies || []).includes(t)));
    }

    if (selectedStatuses.length > 0) {
      result = result.filter(p => p.status && selectedStatuses.includes(p.status));
    }

    // Pinned posts first
    const pinned = result.filter(p => p.featured);
    const rest = result.filter(p => !p.featured);

    rest.sort((a, b) => {
      if (sortBy === 'newest') return new Date(b.date).getTime() - new Date(a.date).getTime();
      if (sortBy === 'oldest') return new Date(a.date).getTime() - new Date(b.date).getTime();
      if (sortBy === 'title') return (a.displayTitle || a.title).localeCompare(b.displayTitle || b.title);
      return 0;
    });

    return [...pinned, ...rest];
  }, [sectionPosts, query, sortBy, selectedTopics, selectedTechs, selectedStatuses]);

  // Infinite scroll
  const config = PAGE_CONFIG[category] || { initial: 6, page: 3 };
  const effectiveVisible = visibleCount || config.initial;
  const visiblePosts = filteredPosts.slice(0, effectiveVisible);
  const hasMore = effectiveVisible < filteredPosts.length;

  const [loading, setLoading] = useState(false);
  const sentinelRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    if (!hasMore || loading) return;
    const el = sentinelRef.current;
    if (!el) return;

    const observer = new IntersectionObserver(([entry]) => {
      if (entry.isIntersecting) {
        setLoading(true);
        setTimeout(() => {
          setSectionState(category, { visibleCount: effectiveVisible + config.page });
          setLoading(false);
        }, 800);
      }
    }, { rootMargin: '200px' });

    observer.observe(el);
    return () => observer.disconnect();
  }, [hasMore, loading, effectiveVisible, category, config.page, setSectionState]);

  const getExcerpt = (content: string, query: string) => {
    if (!query) return null;
    const plain = stripHtml(content);
    const index = plain.toLowerCase().indexOf(query.toLowerCase());
    if (index === -1) return null;
    const start = Math.max(0, index - 50);
    const end = Math.min(plain.length, index + 100);
    return "..." + plain.substring(start, end) + "...";
  };

  const getMatchCount = (content: string, query: string): number => {
    if (!query) return 0;
    const q = query.toLowerCase();
    const plain = stripHtml(content).toLowerCase();
    let count = 0;
    let pos = 0;
    while ((pos = plain.indexOf(q, pos)) !== -1) {
      count++;
      pos += q.length;
    }
    return count;
  };

  const categoryInfo = CATEGORY_CONFIG[category] || { title: category, description: '', icon: null, color: 'gray-400', colorClass: 'text-gray-400', accent: '#9ca3af' } as any;
  const themed = getThemedColor(category, theme as 'dark' | 'light');
  const Renderer = SECTION_RENDERERS[category] || ProjectsList;

  return (
    <div className={`animate-fade-in section-${category}`}>
      {/* Breadcrumb */}
      <nav className="mb-6 text-xs text-th-tertiary flex items-center gap-2">
        <Link to="/home" className="hover:text-th-secondary transition-colors">home</Link>
        <span className="text-th-muted">/</span>
        <span className="text-th-muted">{category === 'threads' || category === 'bits2bricks' ? 'blog' : 'lab'}</span>
        <span className="text-th-muted">/</span>
        <span className="text-th-secondary">{category}</span>
      </nav>

      {/* Header */}
      <header className="mb-8 pb-6 border-b border-th-border">
        <div className="flex items-baseline justify-between gap-4 mb-3">
          <h1 className={`text-4xl font-bold tracking-tight title-l-frame uppercase ${categoryInfo.colorClass}`}>
            <span className="text-th-heading">{categoryInfo.title}</span>
          </h1>
          <div className="flex items-center gap-4 text-xs text-th-tertiary">
            <span>{filteredPosts.length} {filteredPosts.length === 1 ? 'entry' : 'entries'}</span>
            <span className="text-th-muted">&middot;</span>
            <span>{filteredPosts.reduce((acc, p) => acc + calculateReadingTime(p.content), 0)} min total</span>
          </div>
        </div>
        <p className="text-sm text-th-secondary leading-relaxed max-w-2xl font-sans">
          {categoryInfo.description}
        </p>
      </header>

      {/* Toolbar — Search & Filters */}
      <div className="mb-8 space-y-4">
        <div className="flex gap-3">
          <div className="flex-1 group flex items-center border border-th-border px-3 py-2.5 focus-within:border-th-border-active transition-colors bg-th-surface-alt">
            <span className="text-th-tertiary"><SearchIcon /></span>
            <input
              type="text"
              value={query}
              onChange={(e) => setQuery(e.target.value)}
              onKeyDown={(e) => { if (e.key === 'Escape') { setQuery(''); (e.target as HTMLInputElement).blur(); } }}
              placeholder={`Search ${category}...`}
              spellCheck={false}
              autoComplete="off"
              className="w-full bg-transparent border-none ml-2.5 text-sm focus:outline-none placeholder-th-tertiary text-th-primary"
            />
          </div>

          <button
            onClick={() => setShowFilters(!showFilters)}
            className={`px-4 py-2.5 border flex items-center gap-2 text-xs transition-all ${showFilters ? 'bg-th-active text-th-heading border-th-border-hover' : 'border-th-border text-th-secondary hover:border-th-border-hover bg-th-surface-alt'}`}
          >
            <FilterIcon />
            Filters
          </button>
        </div>

        {showFilters && (
          <div className="p-4 bg-th-surface-alt border border-th-border rounded-sm animate-fade-in space-y-4">
            <div className="flex items-center gap-3 flex-wrap">
              <div className="flex items-center gap-2">
                <span className="text-xs text-th-tertiary uppercase">Sort by:</span>
                <select
                  value={sortBy}
                  onChange={(e) => setSortBy(e.target.value as 'newest' | 'oldest' | 'title')}
                  className="text-xs border border-th-border rounded-sm px-2 py-1.5 bg-th-elevated text-th-secondary focus:outline-none focus:border-th-border-active"
                  style={{ colorScheme: theme }}
                >
                  <option value="newest" className="bg-th-base text-th-secondary">Newest First</option>
                  <option value="oldest" className="bg-th-base text-th-secondary">Oldest First</option>
                  <option value="title" className="bg-th-base text-th-secondary">Alphabetical</option>
                </select>
              </div>
              {allStatuses.length > 0 && (
                <>
                  <div className="w-px h-4 bg-th-border" />
                  <span className="text-xs text-th-tertiary uppercase">Status:</span>
                  {allStatuses.map(s => {
                    const cfg = STATUS_FILTER_CONFIG[s] || { label: s, color: 'gray-400' };
                    const active = selectedStatuses.includes(s);
                    return (
                      <button
                        key={s}
                        onClick={() => toggleStatus(s)}
                        className={`text-xs px-2.5 py-0.5 border rounded-sm transition-colors ${
                          active
                            ? `bg-${cfg.color}/20 border-${cfg.color}/50 text-${cfg.color}`
                            : `border-${cfg.color}/20 text-${cfg.color}/60 hover:border-${cfg.color}/40`
                        }`}
                      >
                        {cfg.label} ({statusCounts[s] || 0})
                      </button>
                    );
                  })}
                </>
              )}
            </div>

            {allTopics.length > 0 && (
              <div>
                <span className="text-xs text-th-tertiary uppercase block mb-2">Tags</span>
                <div className="flex flex-wrap gap-2">
                  {allTopics.map(t => (
                    <button
                      key={t}
                      onClick={() => toggleTopic(t)}
                      className={`text-xs px-2.5 py-0.5 border rounded-sm transition-colors ${
                        selectedTopics.includes(t)
                          ? 'bg-slate-400/20 border-slate-400/50 text-slate-400'
                          : 'border-slate-400/20 text-slate-400/60 hover:border-slate-400/40'
                      }`}
                    >
                      {t} ({topicCounts[t] || 0})
                    </button>
                  ))}
                </div>
              </div>
            )}

            {allTechs.length > 0 && (
              <div>
                <span className="text-xs text-th-tertiary uppercase block mb-2">Technologies</span>
                <div className="flex flex-wrap gap-2">
                  {allTechs.map(t => (
                    <button
                      key={t}
                      onClick={() => toggleTech(t)}
                      className={`text-xs px-2.5 py-0.5 border rounded-sm transition-colors ${
                        selectedTechs.includes(t)
                          ? `bg-${themed.color}/20 border-${themed.color}/50 text-${themed.color}`
                          : `border-${themed.color}/20 text-${themed.color}/60 hover:border-${themed.color}/40`
                      }`}
                    >
                      {t} ({techCounts[t] || 0})
                    </button>
                  ))}
                </div>
              </div>
            )}
          </div>
        )}
      </div>

      {/* Delegated renderer */}
      <Renderer posts={visiblePosts} query={query} getExcerpt={getExcerpt} getMatchCount={getMatchCount} color={themed.color} accent={themed.accent} />

      {/* Infinite scroll sentinel */}
      {hasMore && (
        <div ref={sentinelRef} className="flex justify-center py-10">
          {loading && (
            <svg className="animate-spin h-5 w-5 text-th-tertiary" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="2.5" className="opacity-20" />
              <path d="M12 2a10 10 0 019.95 9" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" />
            </svg>
          )}
        </div>
      )}
    </div>
  );
};


================================================================
# FILE: src/views/PostView.tsx  (37 lines)
================================================================
// Post view router — delegates to ArticlePostView for all categories

import React, { useEffect } from 'react';
import { Link, useParams } from 'react-router-dom';
import { posts } from '../data/data';
import { ArticlePostView } from './ArticlePostView';

const HISTORY_KEY = 'infraphysics:article-history';
const MAX_HISTORY = 20;

export const PostView: React.FC = () => {
  const { category, id } = useParams();
  const post = posts.find(p => p.id === id && p.category === category);

  useEffect(() => {
    if (!post) return;
    try {
      const raw = localStorage.getItem(HISTORY_KEY);
      const history: { category: string; id: string }[] = raw ? JSON.parse(raw) : [];
      const filtered = history.filter(h => !(h.category === post.category && h.id === post.id));
      filtered.unshift({ category: post.category, id: post.id });
      localStorage.setItem(HISTORY_KEY, JSON.stringify(filtered.slice(0, MAX_HISTORY)));
    } catch { /* localStorage unavailable */ }
  }, [post]);

  if (!post) return (
    <div className="py-20 text-center">
      <div className="text-6xl mb-4 text-th-muted">404</div>
      <p className="text-th-tertiary">Entry not found in the archive</p>
      <Link to="/home" className="inline-block mt-6 px-4 py-2 bg-th-active text-th-heading text-sm hover:bg-th-active-hover transition-colors border border-th-border">
        Return Home
      </Link>
    </div>
  );

  return <ArticlePostView post={post} />;
};


================================================================
# FILE: src/views/ArticlePostView.tsx  (599 lines)
================================================================
// Article post view — unified terminal/cyberpunk theme for all article categories

import React, { useMemo, useEffect, useState, useCallback } from 'react';
import { Link, useLocation, useNavigate } from 'react-router-dom';
import { formatDate, formatDateTerminal, calculateReadingTime } from '../lib';
import { allFieldNotes } from '../lib/brainIndex';
import { WikiContent } from '../components/WikiContent';
import { CATEGORY_CONFIG, sectionPath as getSectionPath, postPath, isBlogCategory } from '../config/categories';
import { ArrowRightIcon, GitHubIcon, LinkedInIcon, TwitterIcon, RedditIcon, HackerNewsIcon, ClipboardIcon, CheckIcon } from '../components/icons';
import { posts } from '../data/data';
import { Post } from '../types';
import { useArticleContext } from '../contexts/ArticleContext';
import { useKeyboardShortcuts, ShortcutDef } from '../hooks/useKeyboardShortcuts';
import '../styles/article.css';

interface ArticlePostViewProps {
  post: Post;
}

export const ArticlePostView: React.FC<ArticlePostViewProps> = ({ post }) => {
  const sectionPathUrl = getSectionPath(post.category);
  const location = useLocation();
  const navigate = useNavigate();
  const catCfg = CATEGORY_CONFIG[post.category];
  const isBlog = isBlogCategory(post.category);
  const [copied, setCopied] = useState(false);
  const { setArticleState, clearArticleState, updateActiveHeading } = useArticleContext();

  // Compute next/prev posts within same category sorted by date
  const { nextPost, prevPost } = useMemo(() => {
    const sameCat = posts
      .filter(p => p.category === post.category)
      .sort((a, b) => a.date.localeCompare(b.date));
    const idx = sameCat.findIndex(p => p.id === post.id);
    return {
      nextPost: idx < sameCat.length - 1 ? sameCat[idx + 1] : null,
      prevPost: idx > 0 ? sameCat[idx - 1] : null,
    };
  }, [post.id, post.category]);

  // Status label + dot color — derived from PostStatus
  const statusConfig = (() => {
    switch (post.status) {
      case 'ongoing':      return { label: 'ONGOING',      dotColor: '#a78bfa' }; // violet-400
      case 'implemented':  return { label: 'IMPLEMENTED',  dotColor: '#34d399' }; // emerald-400
      case 'active':       return { label: 'ACTIVE',       dotColor: '#34d399' }; // emerald-400
      case 'in-progress':  return { label: 'IN PROGRESS',  dotColor: '#fbbf24' }; // amber-400
      case 'completed':    return { label: 'COMPLETED',    dotColor: '#60a5fa' }; // blue-400
      case 'archived':     return { label: 'ARCHIVED',     dotColor: '#9ca3af' }; // gray-400
      default:             return null;
    }
  })();

  const formattedDate = formatDateTerminal(post.date);
  const readingTime = calculateReadingTime(post.content);

  const authorName = post.author || 'Yago Mendoza';
  const authorDisplay = authorName.toUpperCase();
  const authorPath = authorName.toLowerCase() === 'yago mendoza' ? '/about' : '/contact';

  const notesArray: string[] = !post.notes
    ? []
    : Array.isArray(post.notes)
      ? post.notes
      : String(post.notes).split('\n').map(l => l.trim()).filter(Boolean);

  /*
   * Heading extraction + content enrichment
   */
  const { headings, contentWithIds } = useMemo(() => {
    const raw: { level: number; text: string; id: string }[] = [];
    const seen = new Map<string, number>();

    const processed = post.content.replace(
      /<(h[1-4])(\s[^>]*)?>(.+?)<\/\1>/gi,
      (_match, tag, attrs, inner) => {
        const level = parseInt(tag[1]);
        const text = inner.replace(/<[^>]*>/g, '').trim();
        let slug = text
          .toLowerCase()
          .replace(/[^a-z0-9\s-]/g, '')
          .replace(/\s+/g, '-')
          .replace(/(^-|-$)/g, '');
        if (!slug) slug = 'section';

        const count = seen.get(slug) || 0;
        seen.set(slug, count + 1);
        if (count > 0) slug += `-${count}`;

        const id = `toc-${slug}`;
        raw.push({ level, text, id });
        return `<${tag}${attrs || ''} id="${id}">${inner}</${tag}>`;
      }
    );

    // Blog posts: strip the first h1 (duplicates the displayTitle rendered above)
    let finalProcessed = processed;
    if (isBlog) {
      finalProcessed = finalProcessed.replace(/<h1[\s][^>]*>.*?<\/h1>/i, '');
      // Also remove it from TOC entries
      const firstH1Idx = raw.findIndex(h => h.level === 1);
      if (firstH1Idx !== -1) raw.splice(firstH1Idx, 1);
    }

    if (raw.length === 0) {
      return { headings: [] as { level: number; text: string; id: string; number: string; depth: number }[], contentWithIds: finalProcessed };
    }

    // Hierarchical numbering (1, 1.1, 1.2, 2, 2.1, …)
    const minLevel = Math.min(...raw.map(h => h.level));
    const maxDepth = Math.max(...raw.map(h => h.level)) - minLevel + 1;
    const counters = new Array(maxDepth).fill(0);

    const headings = raw.map(h => {
      const depth = h.level - minLevel;
      counters[depth]++;
      for (let i = depth + 1; i < maxDepth; i++) counters[i] = 0;
      const parts: number[] = [];
      for (let i = 0; i <= depth; i++) parts.push(counters[i]);
      return { ...h, number: parts.join('.'), depth };
    });

    return { headings, contentWithIds: finalProcessed };
  }, [post.content, isBlog]);

  const [tocOpen, setTocOpen] = useState(isBlog);

  // Scroll-based active heading tracking for inline TOC highlight.
  const [activeId, setActiveId] = useState<string>('');

  useEffect(() => {
    if (headings.length < 2) return;

    let currentActiveId = '';

    const handleScroll = () => {
      let newActiveId = '';
      for (const h of headings) {
        const el = document.getElementById(h.id);
        if (el) {
          const rect = el.getBoundingClientRect();
          if (rect.top <= 120) {
            newActiveId = h.id;
          }
        }
      }
      if (newActiveId !== currentActiveId) {
        currentActiveId = newActiveId;
        setActiveId(newActiveId);
      }
    };

    window.addEventListener('scroll', handleScroll, { passive: true });
    handleScroll();
    return () => window.removeEventListener('scroll', handleScroll);
  }, [headings]);

  // Compute active heading + its ancestor chain (parent sections)
  const activeIds = useMemo(() => {
    const ids = new Set<string>();
    if (!activeId || headings.length < 2) return ids;

    const activeIndex = headings.findIndex(h => h.id === activeId);
    if (activeIndex === -1) return ids;

    ids.add(activeId);

    // Walk backwards to find ancestor headings at each shallower depth
    let currentDepth = headings[activeIndex].depth;
    for (let i = activeIndex - 1; i >= 0; i--) {
      if (headings[i].depth < currentDepth) {
        ids.add(headings[i].id);
        currentDepth = headings[i].depth;
        if (currentDepth === 0) break;
      }
    }

    return ids;
  }, [activeId, headings]);

  // Push article state to ArticleContext (consumed by SearchPalette)
  useEffect(() => {
    setArticleState({
      post,
      headings: headings as any,
      activeHeadingId: activeId,
      nextPost,
      prevPost,
    });
    return () => clearArticleState();
  }, [post, headings, nextPost, prevPost]); // eslint-disable-line react-hooks/exhaustive-deps

  // Sync active heading ID to context
  useEffect(() => {
    updateActiveHeading(activeId);
  }, [activeId, updateActiveHeading]);

  // Contextual keyboard shortcuts
  const scrollToHeading = useCallback((direction: 'next' | 'prev') => {
    if (headings.length < 2) return;
    const activeIndex = headings.findIndex(h => h.id === activeId);
    let targetIdx: number;
    if (direction === 'next') {
      targetIdx = activeIndex < headings.length - 1 ? activeIndex + 1 : headings.length - 1;
      // If no active, go to first
      if (activeIndex === -1) targetIdx = 0;
    } else {
      targetIdx = activeIndex > 0 ? activeIndex - 1 : 0;
      if (activeIndex === -1) targetIdx = 0;
    }
    document.getElementById(headings[targetIdx].id)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, [headings, activeId]);

  const articleShortcuts = useMemo<ShortcutDef[]>(() => [
    { key: 'g', label: 'GitHub', action: () => { if (post.github) window.open(post.github, '_blank'); }, enabled: !!post.github },
    { key: 'd', label: 'Demo', action: () => { if (post.demo) window.open(post.demo, '_blank'); }, enabled: !!post.demo },
    { key: 'j', label: 'Next section', action: () => scrollToHeading('next'), enabled: headings.length > 1 },
    { key: 'k', label: 'Prev section', action: () => scrollToHeading('prev'), enabled: headings.length > 1 },
    { key: 't', label: 'Top', action: () => window.scrollTo({ top: 0, behavior: 'smooth' }) },
    { key: 'b', label: 'Bottom', action: () => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }) },
    { key: 'n', label: 'Newer', action: () => { if (nextPost) navigate(postPath(nextPost.category, nextPost.id)); }, enabled: !!nextPost },
    { key: 'p', label: 'Older', action: () => { if (prevPost) navigate(postPath(prevPost.category, prevPost.id)); }, enabled: !!prevPost },
  ], [post.github, post.demo, headings.length, nextPost, prevPost, scrollToHeading, navigate]);

  useKeyboardShortcuts(articleShortcuts);

  // Related posts — from target category, explicit frontmatter IDs or random fallback
  const targetCategory = catCfg?.relatedCategory || post.category;
  const targetCatCfg = CATEGORY_CONFIG[targetCategory];
  const relatedSectionPath = getSectionPath(targetCategory);
  const relatedHoverColor = targetCatCfg?.colorClass || 'text-gray-400';

  const recommendedPosts = useMemo(() => {
    const pool = posts.filter(p => p.category === targetCategory && p.id !== post.id);

    // If frontmatter specifies explicit IDs, resolve them (preserving order)
    if (post.related?.length) {
      const explicit = post.related
        .map(id => pool.find(p => p.id === id))
        .filter((p): p is Post => p !== undefined);
      if (explicit.length > 0) return explicit.slice(0, 3);
    }

    // Fallback: Fisher-Yates shuffle for unbiased random pick
    for (let i = pool.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [pool[i], pool[j]] = [pool[j], pool[i]];
    }
    return pool.slice(0, 3);
  }, [post, targetCategory]);

  // TOC list rendering
  const tocList = headings.length > 1 ? (
    <ol className="article-toc-list">
      {headings.map((h) => (
        <li
          key={h.id}
          className={`article-toc-item article-toc-depth-${h.depth}`}
        >
          <a
            href={`#${h.id}`}
            className={`article-toc-link${activeIds.has(h.id) ? ' article-toc-link--active' : ''}`}
            onClick={(e) => {
              e.preventDefault();
              document.getElementById(h.id)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }}
          >
            <span className="article-toc-num">{h.number}</span>
            {h.text}
          </a>
        </li>
      ))}
    </ol>
  ) : null;

  const backLabel = catCfg?.backLabel || 'RETURN_TO_ARCHIVES';
  const relatedLabel = catCfg?.relatedLabel || 'Related Articles';

  return (
    <div className={`article-page-wrapper article-${post.category}${isBlog ? ' article-blog' : ''} animate-fade-in`}>

      {/* ════════════════════════════════════════════
          THE BOX — .article-container
          Everything except Related Posts lives here
          ════════════════════════════════════════════ */}
      <article className="article-container">

        {/* ── HEADER BAR (projects only) ── */}
        {!isBlog && (
          <div className="article-header-bar">
            <span className="article-header-log">
              // {formattedDate}
            </span>
            {statusConfig && (
              <span className="article-header-status" style={{ color: statusConfig.dotColor }}>
                <span className="article-status-dot" style={{ background: statusConfig.dotColor }} />
                {statusConfig.label}
              </span>
            )}
          </div>
        )}

        {/* ── HERO IMAGE (projects only — grayscale) ── */}
        {!isBlog && post.thumbnail && (
          <div className={`article-hero thumb-${post.thumbnailAspect || 'full'} shade-${post.thumbnailShading || 'heavy'}`}>
            <img
              src={post.thumbnail}
              alt={post.displayTitle || post.title}
              className="article-hero-img"
            />
            <div className="article-hero-gradient" />
          </div>
        )}

        {/* ── BODY ── */}
        <div className="article-body">

          {/* Nav row: return link / breadcrumbs + social icons */}
          <div className="article-nav-row">
            {isBlog ? (
              <nav className="article-breadcrumbs">
                <Link to="/home" className="article-breadcrumb-link">home</Link>
                <span className="article-breadcrumb-sep">/</span>
                <span className="article-breadcrumb-static">blog</span>
                <span className="article-breadcrumb-sep">/</span>
                <Link to={sectionPathUrl} className="article-breadcrumb-link">
                  {catCfg?.breadcrumbLabel || post.category}
                </Link>
                <span className="article-breadcrumb-sep">/</span>
                <span className="article-breadcrumb-current">
                  {(post.displayTitle || post.title).toLowerCase()}
                </span>
              </nav>
            ) : (
              <>
                <Link to={sectionPathUrl} className="article-back-link">
                  &lt; {backLabel}
                </Link>
                <div className="article-social-icons">
                  {post.github && (
                    <a
                      href={post.github}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="article-social-btn article-social-github"
                      title="GitHub"
                    >
                      <GitHubIcon size={18} />
                    </a>
                  )}
                  <a
                    href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(`${window.location.origin}${location.pathname}`)}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="article-social-btn article-social-linkedin"
                    title="Share on LinkedIn"
                  >
                    <LinkedInIcon size={18} />
                  </a>
                </div>
              </>
            )}
          </div>

          {/* Context bar — full-width sub-header below breadcrumbs (blog only) */}
          {isBlog && post.context && (
            <div className="article-context-bar">
              <p className="article-context">{post.context}</p>
            </div>
          )}

          {/* Tags — pills for projects */}
          {!isBlog && (
            <>
              {post.tags && post.tags.length > 0 && (
                <div className="article-pills article-pills-topics">
                  {post.tags.map(tag => (
                    <span key={tag} className="article-pill article-pill-topic">{tag}</span>
                  ))}
                </div>
              )}
              {post.technologies && post.technologies.length > 0 && (
                <div className="article-pills article-pills-tech">
                  {post.technologies.map(tech => (
                    <span key={tech} className="article-pill article-pill-tech">{tech}</span>
                  ))}
                </div>
              )}
            </>
          )}

          {/* META — above title for blog, below for projects */}
          {isBlog && (
            <div className="article-meta">
              <span className="article-meta-date">{formatDate(post.date)}</span>
              <span className="article-meta-reading-time">{readingTime} min read</span>
              <Link to={authorPath} className="article-meta-author">{authorDisplay}</Link>
            </div>
          )}

          {/* Tag pills — below meta, above title (blog only) */}
          {isBlog && (post.tags?.length || post.technologies?.length) ? (
            <div className="article-hashtags">
              {[
                ...(post.tags || []).map(t => ({ label: t, tech: false })),
                ...(post.technologies || []).map(t => ({ label: t, tech: true })),
              ]
                .sort((a, b) => a.label.localeCompare(b.label))
                .map(({ label, tech }) => (
                  <span key={label} className={`article-hashtag${tech ? ' article-hashtag-tech' : ''}`}>#{label}</span>
                ))}
            </div>
          ) : null}

          {/* TITLE — displayTitle large + subtitle below smaller/gray */}
          <div className="article-title-block">
            <h1 className="article-title">
              {post.displayTitle || post.title}
            </h1>
            {post.subtitle && (
              <p className="article-subtitle">{post.subtitle}</p>
            )}
          </div>

          {/* META — below title for projects */}
          {!isBlog && (
            <div className="article-meta">
              <span className="article-meta-date">{formattedDate}</span>
              <span className="article-meta-reading-time">{readingTime} min read</span>
              <Link to={authorPath} className="article-meta-author">{authorDisplay}</Link>
            </div>
          )}

          {/* Separator between subtitle and image (blog only) */}
          {isBlog && <hr className="article-blog-sep" />}

          {/* Blog image — natural color, below meta (blog only) */}
          {isBlog && post.thumbnail && (
            <div className={`article-blog-image thumb-${post.thumbnailAspect || 'full'}`}>
              <img
                src={post.thumbnail}
                alt={post.displayTitle || post.title}
                className="article-blog-image-img"
              />
            </div>
          )}

          {/* NOTES + DIVIDERS (projects only) */}
          {!isBlog && (
            <>
              {/* Thin gray line between meta and notes */}
              <div className="article-divider-thin" />

              {/* Author notes */}
              {notesArray.length > 0 && (
                <div className="article-notes">
                  {notesArray.map((note, i) => (
                    <p key={i} className="article-notes-line">— {note}</p>
                  ))}
                </div>
              )}

              {/* Thick white line before article */}
              <div className="article-divider-thick" />
            </>
          )}

          {/* Table of Contents — collapsible */}
          {headings.length > 1 && (
            <nav className={`article-toc${isBlog ? ' article-toc--blog' : ''}`} id="article-toc">
              <button
                type="button"
                className="article-toc-toggle"
                onClick={() => setTocOpen(o => !o)}
                aria-expanded={tocOpen}
              >
                <span className="article-toc-label">{isBlog ? 'Contents' : '// CONTENTS'}</span>
                <svg
                  className={`article-toc-chevron${tocOpen ? ' article-toc-chevron--open' : ''}`}
                  viewBox="0 0 12 12"
                  width="12"
                  height="12"
                  fill="none"
                  stroke="currentColor"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                >
                  <path d="M3 4.5L6 7.5L9 4.5" />
                </svg>
              </button>
              {tocOpen && tocList}
            </nav>
          )}

          {/* Article content */}
          <WikiContent
            html={contentWithIds}
            allFieldNotes={allFieldNotes}
            className="article-content"
          />

          {/* Share bar — reader perspective */}
          <div className="article-actions">
            <div className="article-share-icons">
              <a
                href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(`Check out: ${post.displayTitle || post.title}`)}&url=${encodeURIComponent(`${window.location.origin}${location.pathname}`)}`}
                target="_blank"
                rel="noopener noreferrer"
                className="article-share-icon article-social-twitter"
                title="Share on X"
              >
                <TwitterIcon size={18} />
              </a>
              <a
                href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(`${window.location.origin}${location.pathname}`)}`}
                target="_blank"
                rel="noopener noreferrer"
                className="article-share-icon article-social-linkedin"
                title="Share on LinkedIn"
              >
                <LinkedInIcon size={18} />
              </a>
              <a
                href={`https://reddit.com/submit?url=${encodeURIComponent(`${window.location.origin}${location.pathname}`)}&title=${encodeURIComponent(post.displayTitle || post.title)}`}
                target="_blank"
                rel="noopener noreferrer"
                className="article-share-icon article-social-reddit"
                title="Share on Reddit"
              >
                <RedditIcon size={18} />
              </a>
              <a
                href={`https://news.ycombinator.com/submitlink?u=${encodeURIComponent(`${window.location.origin}${location.pathname}`)}&t=${encodeURIComponent(post.displayTitle || post.title)}`}
                target="_blank"
                rel="noopener noreferrer"
                className="article-share-icon article-social-hn"
                title="Share on Hacker News"
              >
                <HackerNewsIcon size={18} />
              </a>
              <button
                onClick={() => {
                  navigator.clipboard.writeText(`${window.location.origin}${location.pathname}`);
                  setCopied(true);
                  setTimeout(() => setCopied(false), 2000);
                }}
                className="article-share-icon article-social-copy"
                title={copied ? 'Copied!' : 'Copy link'}
              >
                {copied ? <CheckIcon size={18} /> : <ClipboardIcon size={18} />}
              </button>
            </div>
          </div>

        </div>
      </article>

      {/* ════════════════════════════════════════════
          RELATED POSTS — OUTSIDE the box
          ════════════════════════════════════════════ */}
      <div className={`article-related article-${targetCategory}`}>
        <div className="article-related-header">
          <h3 className="article-related-title">{relatedLabel}</h3>
          <Link to={relatedSectionPath} className="article-related-viewall">
            View all <ArrowRightIcon />
          </Link>
        </div>
        <div className="article-related-grid">
          {recommendedPosts.map(rec => (
            <Link
              key={rec.id}
              to={postPath(rec.category, rec.id)}
              className="article-related-card group"
            >
              <div className="article-related-thumb">
                <img
                  src={rec.thumbnail || ''}
                  alt=""
                  className="w-full h-full object-cover transition-transform group-hover:scale-105"
                />
              </div>
              <div className="article-related-info">
                <div className="article-related-meta">
                  <span className={`text-[10px] uppercase ${relatedHoverColor}`}>{rec.category}</span>
                  <span className="text-[10px] text-th-tertiary">{formatDate(rec.date)}</span>
                </div>
                <h4 className="article-related-name">
                  {rec.displayTitle || rec.title}
                </h4>
              </div>
            </Link>
          ))}
        </div>
      </div>

    </div>
  );
};


================================================================
# FILE: src/views/SecondBrainView.tsx  (352 lines)
================================================================
// Second Brain / Concept Wiki view component — theme-aware

import React, { useEffect, useCallback, useRef } from 'react';
import { Link } from 'react-router-dom';
import { useHub } from '../contexts/SecondBrainHubContext';
import { useSecondBrain } from '../hooks/useSecondBrain';
import { useNavigationTrail } from '../hooks/useNavigationTrail';
import { WikiContent } from '../components/WikiContent';
import { NavigationTrail } from '../components/NavigationTrail';
import { SearchIcon } from '../components/icons';
import { addressToId } from '../lib/addressToId';
import { noteById } from '../lib/brainIndex';
import type { SortMode } from '../hooks/useSecondBrainHub';
import type { Post } from '../types';

const SORT_OPTIONS: { value: SortMode; label: string }[] = [
  { value: 'a-z', label: 'A\u2013Z' },
  { value: 'most-links', label: 'most links' },
  { value: 'fewest-links', label: 'fewest links' },
  { value: 'depth', label: 'depth' },
  { value: 'shuffle', label: 'shuffle' },
];

const MAX_TRAIL = 25;

const toTrailItem = (post: Post) => ({
  id: post.id,
  label: post.displayTitle || post.title,
});

type TrailAction =
  | { type: 'reset'; post: Post }
  | { type: 'extend'; post: Post };

export const SecondBrainView: React.FC = () => {
  const hub = useHub();
  // Always call useSecondBrain (hooks must be unconditional).
  // Used as fallback on mobile where hub sidebar context is absent.
  const brain = useSecondBrain();
  const { trail, resetTrail, extendTrail, truncateTrail, clearTrail, initTrail } = useNavigationTrail();

  const hasHub = hub !== null;

  const allFieldNotes = hasHub ? hub.allFieldNotes : brain.allFieldNotes;
  const sortedResults = hasHub ? hub.sortedResults : brain.filteredNotes;
  const activePost = hasHub ? hub.activePost : brain.activePost;
  const backlinks = hasHub ? hub.backlinks : brain.backlinks;
  const relatedConcepts = hasHub ? hub.relatedConcepts : brain.relatedConcepts;
  const outgoingRefCount = hasHub ? hub.outgoingRefCount : brain.outgoingRefCount;
  const resolvedHtml = hasHub ? hub.resolvedHtml : brain.resolvedHtml;
  const query = hasHub ? hub.query : brain.query;
  const setQuery = hasHub ? hub.setQuery : brain.setQuery;
  const searchActive = hasHub ? hub.searchActive : (brain.query.length > 0);
  const clearSearch = hasHub ? hub.clearSearch : () => brain.setQuery('');
  const directoryScope = hasHub ? hub.directoryScope : null;
  const setDirectoryScope = hasHub ? hub.setDirectoryScope : null;
  const sortMode = hasHub ? hub.sortMode : 'a-z';
  const setSortMode = hasHub ? hub.setSortMode : null;

  // Pending trail action — set synchronously in click handlers, consumed by
  // the useEffect below so the breadcrumb updates in the same render as content.
  const pendingTrailAction = useRef<TrailAction | null>(null);

  // Directory nav signal from sidebar — treat as trail reset
  const directoryNavRef = hasHub ? hub.directoryNavRef : null;

  // Trail sync: when activePost changes, apply any pending trail action.
  // Falls back to initTrail for page-refresh / direct-URL landing.
  useEffect(() => {
    if (!activePost) return;
    const action = pendingTrailAction.current;
    pendingTrailAction.current = null;

    // Check sidebar directory signal
    const fromDirectory = directoryNavRef?.current ?? false;
    if (directoryNavRef) directoryNavRef.current = false;

    if (action) {
      if (action.type === 'reset') {
        resetTrail(toTrailItem(action.post));
      } else {
        extendTrail(toTrailItem(action.post));
      }
    } else if (fromDirectory) {
      // Sidebar directory click — reset trail (new context)
      resetTrail(toTrailItem(activePost));
    } else {
      // No pending action — page refresh or browser back/forward
      initTrail(toTrailItem(activePost));
    }
  }, [activePost, resetTrail, extendTrail, initTrail, directoryNavRef]);

  // Wiki-link click handler — extend trail with the clicked concept
  const handleWikiLinkClick = useCallback((conceptId: string) => {
    const concept = noteById.get(conceptId);
    if (concept) {
      pendingTrailAction.current = { type: 'extend', post: concept };
    }
  }, []);

  // Grid card click — reset trail to single item & clear search so detail view shows
  const handleGridCardClick = useCallback((post: Post) => {
    pendingTrailAction.current = { type: 'reset', post };
    clearSearch();
  }, [clearSearch]);

  // Related / backlink click — extend trail
  const handleConnectionClick = useCallback((post: Post) => {
    pendingTrailAction.current = { type: 'extend', post };
  }, []);

  // When search is active, force list view even if we're on a detail URL
  const showDetail = activePost && !searchActive;

  const isOverflowing = trail.length >= MAX_TRAIL;

  return (
    <div className="animate-fade-in">
      {/* Header — only shown when hub sidebar is NOT available (mobile) */}
      {!hasHub && (
        <header className="mb-8 pb-6 border-b border-th-border">
          <h1 className="text-3xl font-bold tracking-tight lowercase text-violet-400 mb-2">
            second brain
          </h1>
          <p className="text-xs text-th-secondary font-light leading-relaxed mt-2 mb-3 max-w-lg">
            Everything I know, linked together. A growing knowledge graph.
          </p>
          <div className="flex items-center gap-4 mb-4">
            <span className="text-xs text-th-tertiary">
              {brain.allFieldNotes.length} concepts &middot; {brain.totalLinks} links &middot; {brain.orphanCount} orphans
            </span>
          </div>

          {/* Search */}
          <div className="w-full">
            <div className="flex items-center border border-th-border px-3 py-2 bg-th-surface-alt focus-within:border-th-border-active transition-colors">
              <span className="text-th-tertiary"><SearchIcon /></span>
              <input
                type="text"
                placeholder="Search concepts..."
                value={query}
                onChange={(e) => setQuery(e.target.value)}
                onKeyDown={(e) => { if (e.key === 'Escape') { setQuery(''); (e.target as HTMLInputElement).blur(); } }}
                className="w-full text-xs ml-2 focus:outline-none placeholder-th-tertiary bg-transparent text-th-primary"
              />
              {query && (
                <button
                  onClick={() => setQuery('')}
                  className="text-th-tertiary hover:text-th-secondary text-xs ml-2"
                >
                  clear
                </button>
              )}
            </div>
          </div>
        </header>
      )}

      {/* Main Content */}
      {showDetail ? (
        /* --- Concept Detail View --- */
        <div className="grid grid-cols-1 lg:grid-cols-5 gap-12">
          {/* Left: Content */}
          <div className="lg:col-span-3">
            {/* Navigation Trail */}
            <NavigationTrail
              trail={trail}
              onItemClick={(index) => truncateTrail(index)}
              onAllConceptsClick={clearTrail}
              isOverflowing={isOverflowing}
            />

            {/* Concept Title */}
            <h2 className="text-2xl font-bold mb-1 text-th-heading">
              {activePost!.displayTitle || activePost!.title}
            </h2>
            <div className="text-[11px] text-th-tertiary mb-2">
              {activePost!.addressParts && activePost!.addressParts.length > 1
                ? activePost!.addressParts.map((part, i) => {
                    const pathUpTo = activePost!.addressParts!.slice(0, i + 1).join('//');
                    const id = addressToId(pathUpTo);
                    const isLast = i === activePost!.addressParts!.length - 1;
                    return (
                      <React.Fragment key={i}>
                        {i > 0 && <span className="mx-0.5 text-th-muted">/</span>}
                        {isLast
                          ? <span>{part}</span>
                          : <Link to={`/lab/second-brain/${id}`} className="hover:text-violet-400 transition-colors" onClick={() => {
                              const target = noteById.get(id);
                              if (target) pendingTrailAction.current = { type: 'reset', post: target };
                            }}>{part}</Link>
                        }
                      </React.Fragment>
                    );
                  })
                : <span>Root node</span>}
            </div>

            {/* Metadata line */}
            <div className="text-xs text-th-tertiary mb-6">
              links to {outgoingRefCount} &middot; linked from {backlinks.length}
            </div>

            {/* Content — pre-resolved HTML, no allFieldNotes needed */}
            <WikiContent
              html={resolvedHtml}
              className="text-sm leading-relaxed text-th-secondary font-light content-html"
              onWikiLinkClick={handleWikiLinkClick}
            />
          </div>

          {/* Right: Connections panel */}
          <div className="lg:col-span-2 space-y-6">
            {/* Related section */}
            {relatedConcepts.length > 0 && (
              <div>
                <h3 className="text-[10px] text-th-tertiary uppercase tracking-wider mb-3">
                  Related
                </h3>
                <div className="space-y-2">
                  {relatedConcepts.map(concept => (
                    <Link
                      key={concept.id}
                      to={`/lab/second-brain/${concept.id}`}
                      onClick={() => handleConnectionClick(concept)}
                      className="block p-3 border border-th-border rounded-sm bg-th-surface hover:border-violet-400/30 transition-all group"
                    >
                      <div className="text-xs font-medium text-th-secondary group-hover:text-violet-400 transition-colors">
                        {concept.displayTitle || concept.title}
                      </div>
                      {concept.addressParts && concept.addressParts.length > 1 && (
                        <div className="text-[10px] text-th-tertiary mt-0.5">
                          {concept.address}
                        </div>
                      )}
                    </Link>
                  ))}
                </div>
              </div>
            )}

            {/* Backlinks section */}
            {backlinks.length > 0 && (
              <div>
                <h3 className="text-[10px] text-th-tertiary uppercase tracking-wider mb-3">
                  Linked from
                </h3>
                <div className="space-y-2">
                  {backlinks.map(bl => (
                    <Link
                      key={bl.id}
                      to={`/lab/second-brain/${bl.id}`}
                      onClick={() => handleConnectionClick(bl)}
                      className="block p-3 border border-th-border rounded-sm bg-th-surface hover:border-violet-400/30 transition-all group"
                    >
                      <div className="text-xs font-medium text-th-secondary group-hover:text-violet-400 transition-colors">
                        {bl.displayTitle || bl.title}
                      </div>
                      {bl.addressParts && bl.addressParts.length > 1 && (
                        <div className="text-[10px] text-th-tertiary mt-0.5">
                          {bl.address}
                        </div>
                      )}
                    </Link>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      ) : (
        /* --- Concept List View --- */
        <div>
          {/* Sort control + scope/search indicators */}
          <div className="flex items-center justify-between gap-3 mb-3 flex-wrap">
            <div className="flex items-center gap-3 flex-wrap">
              {directoryScope && (
                <div className="flex items-center gap-1 text-xs text-th-tertiary">
                  <span className="text-th-muted">scope:</span>
                  <span className="text-violet-400">{directoryScope.replace(/\/\//g, ' / ')}</span>
                  {setDirectoryScope && (
                    <button
                      onClick={() => setDirectoryScope(null)}
                      className="text-th-muted hover:text-th-secondary ml-0.5"
                    >
                      &times;
                    </button>
                  )}
                </div>
              )}
              {query && (
                <div className="text-xs text-th-tertiary">
                  {sortedResults.length} result{sortedResults.length !== 1 ? 's' : ''} for &ldquo;{query}&rdquo;
                </div>
              )}
            </div>
            {setSortMode && (
              <div className="flex items-center gap-1.5">
                {SORT_OPTIONS.map(opt => (
                  <button
                    key={opt.value}
                    onClick={() => setSortMode(opt.value)}
                    className={`text-[10px] px-2 py-0.5 rounded-sm transition-colors ${
                      sortMode === opt.value
                        ? 'text-violet-400 bg-violet-400/10'
                        : 'text-th-muted hover:text-th-secondary'
                    }`}
                  >
                    {opt.label}
                  </button>
                ))}
              </div>
            )}
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            {sortedResults.length > 0 ? (
              sortedResults.map(note => (
                <Link
                  key={note.id}
                  to={`/lab/second-brain/${note.id}`}
                  onClick={() => handleGridCardClick(note)}
                  className="block p-4 border border-th-border rounded-sm bg-th-surface hover:border-th-border-hover transition-all group"
                >
                  <div className="mb-0.5">
                    <span className="text-sm font-medium text-violet-400 group-hover:text-th-primary transition-colors">
                      {note.displayTitle || note.title}
                    </span>
                  </div>
                  {note.addressParts && note.addressParts.length > 1 && (
                    <div className="text-[10px] text-th-tertiary mb-1">
                      {note.address}
                    </div>
                  )}
                  {note.description && (
                    <div className="text-xs text-th-secondary line-clamp-2 font-sans">
                      {note.description}
                    </div>
                  )}
                </Link>
              ))
            ) : (
              <div className="text-xs text-th-tertiary py-8 text-center col-span-3">
                No concepts match your search
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
};


================================================================
# FILE: src/styles/article.css  (1520 lines)
================================================================
/* ═══════════════════════════════════════════════════════════════
   ARTICLE POST VIEW — Terminal/Cyberpunk Theme
   Unified template for all article categories (projects, threads, bits2bricks)
   Responds to light/dark via CSS custom properties (--art-*)

   ESTRUCTURA:
   Theme tokens — CSS variables for dark (default) and light
   Category accents — per-category color overrides via wrapper class
   Section A — Layout shell (ArticlePostView)
   Section B — Article content (HTML compilado desde markdown)
   Section C — Bottom sections (actions, related)
   Section D — Responsive
   ═══════════════════════════════════════════════════════════════ */


/* ─────────────────────────────────────────────────
   THEME TOKENS
   ───────────────────────────────────────────────── */

:root {
  /* Surfaces */
  --art-surface:      #111111;
  --art-surface-alt:  #0d0d0d;
  --art-surface-code: #0a0a0a;
  --art-surface-bar:  #1a1a1a;
  --art-surface-card: #0d0d0d;

  /* Borders */
  --art-border:       #2a2a2a;
  --art-border-subtle:#222;
  --art-border-strong:#333;
  --art-border-card:  #1a1a1a;

  /* Accent (lime — default / projects) */
  --art-accent:             #a3e635;
  --art-accent-dim:         rgba(163,230,53,0.3);
  --art-accent-bg:          rgba(163,230,53,0.05);
  --art-accent-code-bg:     rgba(163,230,53,0.08);
  --art-accent-code-border: rgba(163,230,53,0.15);
  --art-accent-mark-bg:     rgba(163,230,53,0.15);
  --art-accent-quote-bg:    rgba(163,230,53,0.04);
  --art-accent-hover-border:rgba(163,230,53,0.4);
  --art-accent-hover-bg:    rgba(163,230,53,0.05);

  /* Purple (topics) */
  --art-purple:      #a855f7;
  --art-purple-dim:  rgba(168,85,247,0.3);
  --art-purple-bg:   rgba(168,85,247,0.05);

  /* Text hierarchy */
  --art-text-title:    #f0f0f0;
  --art-text-strong:   #e0e0e0;
  --art-text-h2:       #e8e8e8;
  --art-text-h3:       #d0d0d0;
  --art-text-h4:       #c0c0c0;
  --art-text-bright:   #ccc;
  --art-text-body:     #b0b0b0;
  --art-text-mid:      #888;
  --art-text-subtitle: #777;
  --art-text-dim:      #666;
  --art-text-muted:    #555;
  --art-text-card:     #ccc;

  /* Context bar */
  --art-surface-context: #171717;
  --art-text-context:    #999;

  /* Dividers */
  --art-divider-thick: #555;
}

[data-theme="light"] {
  --art-surface:      #ffffff;
  --art-surface-alt:  #f7f7f7;
  --art-surface-code: #f5f5f5;
  --art-surface-bar:  #eeeeee;
  --art-surface-card: #fafafa;

  --art-border:       #e0e0e0;
  --art-border-subtle:#eaeaea;
  --art-border-strong:#ccc;
  --art-border-card:  #e8e8e8;

  --art-accent:             #4d7c0f;
  --art-accent-dim:         rgba(77,124,15,0.3);
  --art-accent-bg:          rgba(77,124,15,0.06);
  --art-accent-code-bg:     rgba(77,124,15,0.08);
  --art-accent-code-border: rgba(77,124,15,0.2);
  --art-accent-mark-bg:     rgba(77,124,15,0.12);
  --art-accent-quote-bg:    rgba(77,124,15,0.06);
  --art-accent-hover-border:rgba(77,124,15,0.4);
  --art-accent-hover-bg:    rgba(77,124,15,0.05);

  --art-purple:      #7c3aed;
  --art-purple-dim:  rgba(124,58,237,0.3);
  --art-purple-bg:   rgba(124,58,237,0.06);

  --art-text-title:    #1a1a1a;
  --art-text-strong:   #1a1a1a;
  --art-text-h2:       #222;
  --art-text-h3:       #333;
  --art-text-h4:       #444;
  --art-text-bright:   #555;
  --art-text-body:     #444;
  --art-text-mid:      #666;
  --art-text-subtitle: #666;
  --art-text-dim:      #888;
  --art-text-muted:    #999;
  --art-text-card:     #333;

  --art-surface-context: #f7f7f7;
  --art-text-context:    #777;

  --art-divider-thick: #bbb;
}


/* ─────────────────────────────────────────────────
   CATEGORY ACCENT OVERRIDES
   Projects = lime (default in :root, no overrides needed)
   ───────────────────────────────────────────────── */

/* Threads — rose */
.article-threads {
  --art-accent:             #fb7185;
  --art-accent-dim:         rgba(251,113,133,0.3);
  --art-accent-bg:          rgba(251,113,133,0.05);
  --art-accent-code-bg:     rgba(251,113,133,0.08);
  --art-accent-code-border: rgba(251,113,133,0.15);
  --art-accent-mark-bg:     rgba(251,113,133,0.15);
  --art-accent-quote-bg:    rgba(251,113,133,0.04);
  --art-accent-hover-border:rgba(251,113,133,0.4);
  --art-accent-hover-bg:    rgba(251,113,133,0.05);
}

[data-theme="light"] .article-threads {
  --art-accent:             #e11d48;
  --art-accent-dim:         rgba(225,29,72,0.3);
  --art-accent-bg:          rgba(225,29,72,0.06);
  --art-accent-code-bg:     rgba(225,29,72,0.08);
  --art-accent-code-border: rgba(225,29,72,0.2);
  --art-accent-mark-bg:     rgba(225,29,72,0.12);
  --art-accent-quote-bg:    rgba(225,29,72,0.06);
  --art-accent-hover-border:rgba(225,29,72,0.4);
  --art-accent-hover-bg:    rgba(225,29,72,0.05);
}

/* Bits2Bricks — blue */
.article-bits2bricks {
  --art-accent:             #3B82F6;
  --art-accent-dim:         rgba(59,130,246,0.3);
  --art-accent-bg:          rgba(59,130,246,0.05);
  --art-accent-code-bg:     rgba(59,130,246,0.08);
  --art-accent-code-border: rgba(59,130,246,0.15);
  --art-accent-mark-bg:     rgba(59,130,246,0.15);
  --art-accent-quote-bg:    rgba(59,130,246,0.04);
  --art-accent-hover-border:rgba(59,130,246,0.4);
  --art-accent-hover-bg:    rgba(59,130,246,0.05);
}

[data-theme="light"] .article-bits2bricks {
  --art-accent:             #2563eb;
  --art-accent-dim:         rgba(37,99,235,0.3);
  --art-accent-bg:          rgba(37,99,235,0.06);
  --art-accent-code-bg:     rgba(37,99,235,0.08);
  --art-accent-code-border: rgba(37,99,235,0.2);
  --art-accent-mark-bg:     rgba(37,99,235,0.12);
  --art-accent-quote-bg:    rgba(37,99,235,0.06);
  --art-accent-hover-border:rgba(37,99,235,0.4);
  --art-accent-hover-bg:    rgba(37,99,235,0.05);
}


/* ─────────────────────────────────────────────────
   A. LAYOUT SHELL
   ───────────────────────────────────────────────── */

/* A0. Page wrapper (contains box + related outside) */

.article-page-wrapper {
  max-width: 52rem;
}

/* A1. Container box */

.article-container {
  background: var(--art-surface);
  border: 1px solid var(--art-border);
  border-radius: 2px;
  overflow: hidden;
}

/* A2. Header bar */

.article-header-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem 1rem;
  font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
  font-size: 0.7rem;
  color: var(--art-text-muted);
  border-bottom: 1px solid var(--art-border);
  background: var(--art-surface-alt);
}

.article-header-log {
  letter-spacing: 0.05em;
}

.article-header-status {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  color: var(--art-accent);
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

.article-status-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--art-accent);
  display: inline-block;
}

/* A3. Hero image */

.article-hero {
  position: relative;
  width: 100%;
  overflow: hidden;
  border-bottom: 1px solid var(--art-border);
}

.article-hero-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  filter: grayscale(80%) brightness(0.6) contrast(1.1);
}

[data-theme="light"] .article-hero-img {
  filter: grayscale(50%) brightness(0.8) contrast(1.05);
}

/* A3b. Thumbnail shading presets */
/* heavy = default (defined above on .article-hero-img) */
/* light = milder filter, softer gradient */
.shade-light .article-hero-img        { filter: grayscale(30%) brightness(0.8) contrast(1.05); }
[data-theme="light"] .shade-light .article-hero-img { filter: grayscale(20%) brightness(0.9) contrast(1.02); }
.shade-light .article-hero-gradient    { height: 25%; opacity: 0.6; }

/* none = no filter, no gradient */
.shade-none .article-hero-img         { filter: none; }
[data-theme="light"] .shade-none .article-hero-img  { filter: none; }
.shade-none .article-hero-gradient     { display: none; }

/* A3c. Thumbnail aspect presets (hero + blog image) */
.thumb-full                    { aspect-ratio: auto; }
.thumb-full img                { height: auto; object-fit: contain; }
.thumb-wide                    { aspect-ratio: 16 / 7; }
.thumb-banner                  { aspect-ratio: 16 / 4; }
.thumb-strip                   { aspect-ratio: 16 / 2; }

.article-hero-gradient {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 40%;
  background: linear-gradient(to top, var(--art-surface), transparent);
  pointer-events: none;
}

[data-theme="light"] .article-hero-gradient {
  background: linear-gradient(to top, #111111, transparent);
}

/* A4. Body */

.article-body {
  padding: 1.5rem 2rem 2rem;
}

/* A5. Nav row */

.article-nav-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
}

.article-blog .article-body {
  padding-top: 0;
}

.article-blog .article-nav-row {
  margin: 0 -2rem;
  padding: 0.55rem 2rem;
  border-bottom: 1px solid var(--art-border);
}

.article-back-link {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  color: var(--art-accent);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  text-decoration: none;
  transition: opacity 0.2s;
}

.article-back-link:hover {
  opacity: 0.7;
}

/* A6. Social icon buttons */

.article-social-icons {
  display: flex;
  gap: 0.5rem;
}

.article-social-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 34px;
  height: 34px;
  border: 1px solid var(--art-border);
  background: var(--art-surface);
  color: var(--art-text-muted);
  transition: all 0.2s ease;
  border-radius: 2px;
  text-decoration: none;
}

.article-social-github:hover {
  color: var(--art-accent);
  border-color: var(--art-accent-hover-border);
  background: var(--art-accent-hover-bg);
}

.article-social-linkedin:hover {
  color: #0A66C2;
  border-color: rgba(10, 102, 194, 0.4);
  background: rgba(10, 102, 194, 0.05);
}

.article-social-twitter:hover {
  color: var(--art-text-title);
}

.article-social-reddit:hover {
  color: #FF4500;
}

.article-social-hn:hover {
  color: #FF6600;
}

.article-social-copy:hover {
  color: var(--art-accent);
}

/* A7. Tag pills — two rows: topics (purple) + technologies (accent) */

.article-pills {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

.article-pills-topics {
  margin-bottom: 0.4rem;
}

.article-pills-tech {
  margin-bottom: 1.25rem;
}

.article-pill {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.65rem;
  padding: 0.25rem 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
}

/* Topics → purple */
.article-pill-topic {
  border: 1px solid var(--art-purple-dim);
  color: var(--art-purple);
  background: var(--art-purple-bg);
}

/* Technologies → accent */
.article-pill-tech {
  border: 1px solid var(--art-accent-dim);
  color: var(--art-accent);
  background: var(--art-accent-bg);
}

/* A8. Title block */

.article-title-block {
  margin-bottom: 1.25rem;
}

.article-title {
  font-family: 'JetBrains Mono', 'Courier New', monospace;
  font-size: 2.75rem;
  font-weight: 800;
  line-height: 1.1;
  color: var(--art-text-title);
  text-transform: uppercase;
  letter-spacing: -0.01em;
  margin: 0;
}

/* Subtitle — slightly smaller, gray */
.article-subtitle {
  font-family: 'JetBrains Mono', monospace;
  font-size: 1.1rem;
  font-weight: 500;
  color: var(--art-text-subtitle);
  text-transform: uppercase;
  letter-spacing: 0.02em;
  margin-top: 0.5rem;
  margin-bottom: 0;
}

@media (min-width: 768px) {
  .article-title {
    font-size: 3.5rem;
  }
  .article-subtitle {
    font-size: 1.25rem;
  }
}

/* A9. Meta — date + reading time + author on same line */

.article-meta {
  display: flex;
  align-items: baseline;
  gap: 0.75rem;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  margin-bottom: 0.75rem;
}

.article-meta-date {
  color: var(--art-accent);
}

.article-meta-reading-time {
  color: var(--art-text-mid);
}

.article-meta-author {
  color: var(--art-text-mid);
  font-family: 'Inter', var(--font-sans);
  text-decoration: underline;
  text-underline-offset: 2px;
  transition: color 0.2s;
}

.article-meta-author:hover {
  color: var(--art-text-title);
}

/* A10. Dividers */

/* Thin gray line (between meta and notes) */
.article-divider-thin {
  border-top: 1px solid var(--art-border);
  margin-top: 0.75rem;
  margin-bottom: 0.75rem;
}

/* Thick line (between notes and article) */
.article-divider-thick {
  border-top: 2px solid var(--art-divider-thick);
  margin-top: 1rem;
  margin-bottom: 2rem;
}

/* A11. Author notes */

.article-notes {
  display: flex;
  flex-direction: column;
  gap: 0.6rem;
  margin-bottom: 0.5rem;
  padding-top: 0.25rem;
}

.article-notes-line {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.7rem;
  color: var(--art-text-muted);
  line-height: 1.6;
}


/* A12. Table of Contents (collapsible) */

.article-toc-toggle {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  padding: 0.6rem 0.75rem;
  background: none;
  border: none;
  cursor: pointer;
}

.article-toc-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  color: var(--art-accent);
  letter-spacing: 0.1em;
}

.article-toc-chevron {
  color: var(--art-accent);
  width: 16px;
  height: 16px;
  transition: transform 0.25s ease;
}

.article-toc-chevron--open {
  transform: rotate(180deg);
}

.article-toc-list {
  list-style: none;
  padding: 0.5rem 1rem 0.75rem;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 0.1rem;
  border-top: 1px solid var(--art-accent-dim);
}

.article-toc-item {
  display: flex;
}

.article-toc-link {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  color: var(--art-text-dim);
  text-decoration: none;
  text-transform: uppercase;
  letter-spacing: 0.03em;
  display: inline-flex;
  align-items: baseline;
  gap: 0.5rem;
  transition: color 0.2s;
  line-height: 1.8;
}

.article-toc-link:hover {
  color: var(--art-accent);
}

.article-toc-num {
  color: var(--art-accent);
  font-size: 0.65rem;
  min-width: 2rem;
}

/* Top-level entries — bolder, with a thin accent line between number and title */
.article-toc-depth-0 > .article-toc-link {
  font-weight: 600;
  align-items: center;
}

.article-toc-depth-0 > .article-toc-link > .article-toc-num::after {
  content: '';
  display: inline-block;
  width: 1.25rem;
  border-top: 1px solid var(--art-accent-dim);
  vertical-align: middle;
  margin-left: 0.35rem;
}

/* Active heading highlight (current section + its ancestor chain) */
.article-toc-link--active {
  color: var(--art-text-title) !important;
}

/* Indentation by depth */
.article-toc-depth-0 { padding-left: 0; }
.article-toc-depth-1 { padding-left: 1.25rem; }
.article-toc-depth-2 { padding-left: 2.5rem; }
.article-toc-depth-3 { padding-left: 3.75rem; }

/* A12a. Inline TOC (always visible, between thick divider and content) */

.article-toc {
  border: 1px solid var(--art-accent-dim);
  margin-bottom: 1.5rem;
  scroll-margin-top: 1rem;
}

/* Scroll target offset for anchored headings */
.article-content h1[id],
.article-content h2[id],
.article-content h3[id],
.article-content h4[id] {
  scroll-margin-top: 1.5rem;
}


/* ─────────────────────────────────────────────────
   B. ARTICLE CONTENT (.article-content)
   HTML compilado desde markdown
   ───────────────────────────────────────────────── */

/* B1. Headings */

.article-content h1,
.article-content h2,
.article-content h3,
.article-content h4 {
  font-family: 'JetBrains Mono', monospace;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  font-weight: 700;
}

.article-content h1 {
  font-size: 1.75rem;
  color: var(--art-accent);
  margin: 2.5rem 0 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid var(--art-border-subtle);
}

.article-content h2 {
  font-size: 1.35rem;
  color: var(--art-text-h2);
  margin: 2rem 0 0.75rem;
}

.article-content h3 {
  font-size: 1.05rem;
  color: var(--art-text-h3);
  margin: 1.5rem 0 0.5rem;
}

.article-content h4 {
  font-size: 0.9rem;
  color: var(--art-text-h4);
  margin: 1.25rem 0 0.4rem;
}

/* B2. Paragraphs */

.article-content p {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.875rem;
  color: var(--art-text-body);
  line-height: 1.6;
  margin-bottom: 1rem;
}

/* B3. Typed blockquotes {bkqt:type:text} */

.article-content .bkqt {
  margin: 1.5rem 0;
  border-radius: 0;
  overflow: hidden;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.78rem;
  color: var(--art-text-bright);
  line-height: 1.6;
}

.article-content .bkqt-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.2rem 0.75rem;
  background: var(--bkqt-bg-header);
}

.article-content .bkqt-body {
  padding: 0.75rem 1rem;
  background: var(--bkqt-bg);
}

.article-content .bkqt-body > *:first-child {
  margin-top: 0;
}

.article-content .bkqt-body > *:last-child {
  margin-bottom: 0;
}

.article-content .bkqt p {
  font-size: inherit;
  margin: 0.75rem 0 0 0;
}

.article-content .bkqt ul {
  list-style: none;
  padding-left: 0;
  margin: 0.5rem 0 0 0;
}

.article-content .bkqt ul li {
  position: relative;
  padding-left: 1.5rem;
  margin-bottom: 0.25rem;
  font-size: inherit;
}

.article-content .bkqt ul li::before {
  content: '•';
  position: absolute;
  left: 0;
  top: 0;
  color: var(--bkqt-color);
  font-weight: bold;
  font-size: inherit;
  line-height: 1.45;
}

.article-content .bkqt ol {
  padding-left: 1.5rem;
  margin: 0.5rem 0 0 0;
}

.article-content .bkqt ol li {
  margin-bottom: 0.25rem;
  font-size: inherit;
}

.article-content .bkqt ol li::marker {
  color: var(--bkqt-color);
  font-weight: bold;
}

.article-content .bkqt code:not(pre code) {
  color: var(--bkqt-color) !important;
  background: rgba(255,255,255,0.04);
  border-color: rgba(255,255,255,0.06);
}

.article-content .bkqt-label {
  font-weight: 400;
  color: var(--bkqt-color);
}

.article-content .copy-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
  background: none;
  border: none;
  cursor: pointer;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.6rem;
  color: var(--art-text-mid);
  padding: 0.15rem 0.4rem;
  border-radius: 3px;
  transition: color 0.15s, background 0.15s;
}

.article-content .copy-btn:hover {
  color: var(--art-text-bright);
  background: rgba(255,255,255,0.06);
}

.article-content .copy-btn.copied {
  color: var(--bkqt-color, var(--art-accent));
}

/* bkqt type variants — dark */
.article-content .bkqt-note       { --bkqt-color: var(--art-accent); --bkqt-bg-header: color-mix(in srgb, var(--art-accent) 10%, transparent); --bkqt-bg: color-mix(in srgb, var(--art-accent) 4%, transparent); }
.article-content .bkqt-tip        { --bkqt-color: #22c55e; --bkqt-bg-header: rgba(34,197,94,0.10);  --bkqt-bg: rgba(34,197,94,0.04); }
.article-content .bkqt-warning    { --bkqt-color: #d97706; --bkqt-bg-header: rgba(217,119,6,0.10);  --bkqt-bg: rgba(217,119,6,0.04); }
.article-content .bkqt-danger     { --bkqt-color: #dc2626; --bkqt-bg-header: rgba(220,38,38,0.10);  --bkqt-bg: rgba(220,38,38,0.04); }
.article-content .bkqt-deepdive   { --bkqt-color: #3b82f6; --bkqt-bg-header: rgba(59,130,246,0.10); --bkqt-bg: rgba(59,130,246,0.04); }
.article-content .bkqt-keyconcept { --bkqt-color: #a855f7; --bkqt-bg-header: rgba(168,85,247,0.10); --bkqt-bg: rgba(168,85,247,0.04); }

/* bkqt type variants — light */
[data-theme="light"] .article-content .bkqt-tip        { --bkqt-color: #15803d; --bkqt-bg-header: rgba(21,128,61,0.12);  --bkqt-bg: rgba(21,128,61,0.05); }
[data-theme="light"] .article-content .bkqt-warning    { --bkqt-color: #b45309; --bkqt-bg-header: rgba(180,83,9,0.12);   --bkqt-bg: rgba(180,83,9,0.05); }
[data-theme="light"] .article-content .bkqt-danger     { --bkqt-color: #b91c1c; --bkqt-bg-header: rgba(185,28,28,0.12);  --bkqt-bg: rgba(185,28,28,0.05); }
[data-theme="light"] .article-content .bkqt-deepdive   { --bkqt-color: #2563eb; --bkqt-bg-header: rgba(37,99,235,0.12);  --bkqt-bg: rgba(37,99,235,0.05); }
[data-theme="light"] .article-content .bkqt-keyconcept { --bkqt-color: #7c3aed; --bkqt-bg-header: rgba(124,58,237,0.12); --bkqt-bg: rgba(124,58,237,0.05); }

/* B3b. Small text (> markdown blocks) */

.article-content .small-text {
  margin: 1rem 0;
}

.article-content .small-text p {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.7rem;
  color: var(--art-text-mid);
  line-height: 1.6;
  margin-bottom: 0.4rem;
}

/* B4. Unordered lists */

.article-content ul {
  list-style: none;
  padding-left: 0;
  margin: 1rem 0;
}

.article-content ul li {
  position: relative;
  padding-left: 1.5rem;
  margin-bottom: 0.5rem;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.875rem;
  color: var(--art-text-body);
  line-height: 1.45;
}

.article-content ul li::before {
  content: '•';
  position: absolute;
  left: 0;
  color: var(--art-accent);
  font-weight: bold;
  font-size: 1rem;
}

/* B5. Ordered lists */

.article-content ol {
  list-style: decimal;
  padding-left: 1.5rem;
  margin: 1rem 0;
}

.article-content ol li {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.875rem;
  color: var(--art-text-body);
  line-height: 1.45;
  margin-bottom: 0.5rem;
}

.article-content ol li::marker {
  color: var(--art-accent);
  font-weight: bold;
}

/* B6. Code blocks — terminal macOS */

.article-content .code-terminal {
  background-color: var(--art-surface-code);
  border: 1px solid var(--art-border);
  border-radius: 0;
  margin: 1.5rem 0;
  overflow: hidden;
  transition: background-color 0.95s ease, border-color 0.95s ease;
}

.article-content .code-terminal-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.35rem 0.75rem;
  background-color: var(--art-surface-bar);
  border-bottom: 1px solid var(--art-border-subtle);
  transition: background-color 0.95s ease, border-color 0.95s ease;
}

.article-content .code-terminal-dots {
  display: flex;
  gap: 5px;
}

.article-content .code-terminal-dots span {
  width: 9px;
  height: 9px;
  border-radius: 50%;
}

.article-content .code-terminal-dots span:nth-child(1) { background: #c74b47; }
.article-content .code-terminal-dots span:nth-child(2) { background: #c9a22a; }
.article-content .code-terminal-dots span:nth-child(3) { background: #2ea043; }

.article-content .code-terminal-right {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.article-content .code-terminal-lang {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.65rem;
  color: var(--art-text-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.article-content .code-terminal pre {
  margin: 0;
  padding: 1rem;
  overflow-x: auto;
  background: transparent;
  border: none;
}

.article-content .code-terminal code {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.8rem;
  color: var(--art-text-bright);
  line-height: 1.6;
  background: transparent;
  padding: 0;
  border: none;
  border-radius: 0;
}

/* Fallback: pre>code without wrapper */
.article-content pre:not(.code-terminal pre) {
  background-color: var(--art-surface-code);
  border: 1px solid var(--art-border);
  border-radius: 0;
  padding: 1rem;
  margin: 1.5rem 0;
  overflow-x: auto;
  transition: background-color 0.95s ease, border-color 0.95s ease;
}

.article-content pre:not(.code-terminal pre) code {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.8rem;
  color: var(--art-text-bright);
  background: transparent;
  padding: 0;
  border: none;
}

/* B7. Inline code */

.article-content code:not(pre code) {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.8em;
  color: var(--art-accent);
  background: var(--art-accent-code-bg);
  border: 1px solid var(--art-accent-code-border);
  padding: 0.15em 0.4em;
  border-radius: 4px;
}

/* B8. Horizontal rules */

.article-content hr {
  border: none;
  border-top: 1px solid var(--art-border);
  margin: 2rem 0;
}

/* B9. Links */

.article-content a:not(.wiki-ref):not(.wiki-ref-resolved):not(.doc-ref) {
  color: var(--art-accent);
  text-decoration: none;
  border-bottom: 1px solid var(--art-accent-dim);
  transition: border-color 0.2s;
}

.article-content a:not(.wiki-ref):not(.wiki-ref-resolved):not(.doc-ref):hover {
  border-bottom-color: var(--art-accent);
}

/* B10. Images */

.article-content img {
  border-radius: 4px;
  border: 1px solid var(--art-border);
  margin: 1.5rem 0;
}

/* B10b. Figcaptions */

.article-content figure {
  margin: 1.5rem 0;
}

.article-content figure.img-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
  max-width: 100%;
  width: fit-content;
}

.article-content figure.img-center img {
  margin: 0;
}

.article-content figure.img-full {
  width: 100%;
}

.article-content figure.img-full img {
  width: 100%;
  margin: 0;
}

.article-content figure img {
  margin-bottom: 0;
}

.article-content figcaption {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.7rem;
  color: var(--art-text-dim);
  text-align: center;
  margin-top: 0.5rem;
}

/* B11. Tables */

.article-content table {
  width: 100%;
  border-collapse: collapse;
  margin: 1.5rem 0;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.8rem;
}

.article-content th {
  background: var(--art-surface-bar);
  color: var(--art-accent);
  text-transform: uppercase;
  font-size: 0.7rem;
  letter-spacing: 0.05em;
  padding: 0.5rem 0.75rem;
  border-bottom: 1px solid var(--art-border-strong);
  text-align: left;
}

.article-content td {
  padding: 0.5rem 0.75rem;
  border-bottom: 1px solid var(--art-border-subtle);
  color: var(--art-text-body);
}

/* B12. Strong / Em */

.article-content strong {
  color: var(--art-text-strong);
  font-weight: 700;
}

.article-content em {
  color: var(--art-text-bright);
  font-style: italic;
}

/* B13. <mark> highlight */

.article-content mark {
  background: var(--art-accent-mark-bg);
  color: var(--art-accent);
  padding: 0.1em 0.3em;
  border-radius: 2px;
}

/* B13b. Accent-colored text (--text--) */

.article-content .accent-text {
  color: var(--art-accent);
}

/* B13c. Mark + accent-text adapt color inside blockquotes */

.article-content .bkqt mark {
  color: var(--bkqt-color);
  background: color-mix(in srgb, var(--bkqt-color) 15%, transparent);
}

.article-content .bkqt .accent-text {
  color: var(--bkqt-color);
}

/* B14. <kbd> keyboard */

.article-content kbd {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75em;
  background: var(--art-surface-bar);
  border: 1px solid var(--art-border-strong);
  border-bottom: 2px solid var(--art-border-strong);
  color: var(--art-text-bright);
  padding: 0.1em 0.4em;
  border-radius: 3px;
}

/* B15. Wiki refs */

.article-content .wiki-ref,
.article-content .wiki-ref-resolved {
  color: var(--art-accent);
  border-bottom: 1px dashed var(--art-accent-hover-border);
  cursor: pointer;
  text-decoration: none;
}

.article-content .wiki-ref:hover,
.article-content .wiki-ref-resolved:hover {
  border-bottom-style: solid;
}

/* B16. Inline code inside colored spans adapts bg/border to parent color */

.article-content [style*="color"] > code:not(pre code) {
  color: inherit;
  background: color-mix(in srgb, currentColor 8%, transparent);
  border-color: color-mix(in srgb, currentColor 20%, transparent);
}

/* B17. Cross-document links */

.article-content .doc-ref {
  text-decoration: none;
  border-bottom: 1px dashed;
  cursor: pointer;
  transition: border-color 0.2s;
}

.article-content .doc-ref:hover {
  border-bottom-style: solid;
}

.article-content .doc-ref-projects { color: #a3e635; border-bottom-color: rgba(163,230,53,0.4); }
.article-content .doc-ref-threads  { color: #fb7185; border-bottom-color: rgba(251,113,133,0.4); }
.article-content .doc-ref-bits2bricks { color: #3B82F6; border-bottom-color: rgba(59,130,246,0.4); }
.article-content .doc-ref-external { color: #9ca3af; border-bottom-color: rgba(156,163,175,0.4); }

[data-theme="light"] .article-content .doc-ref-projects { color: #4d7c0f; border-bottom-color: rgba(77,124,15,0.4); }
[data-theme="light"] .article-content .doc-ref-threads  { color: #e11d48; border-bottom-color: rgba(225,29,72,0.4); }
[data-theme="light"] .article-content .doc-ref-bits2bricks { color: #2563eb; border-bottom-color: rgba(37,99,235,0.4); }
[data-theme="light"] .article-content .doc-ref-external { color: #6b7280; border-bottom-color: rgba(107,114,128,0.4); }

/* B18. Side image layouts */

.article-content .img-side-layout {
  margin: 1.5rem 0;
}

.article-content .img-side-layout .img-side-img {
  border-radius: 4px;
  border: 1px solid var(--art-border);
}

.article-content .img-side-layout .img-side-content p {
  color: var(--art-text-body);
}


/* ─────────────────────────────────────────────────
   C. BOTTOM SECTIONS
   ───────────────────────────────────────────────── */

/* C1. Actions bar (inside box) */

.article-actions {
  margin-top: 3rem;
  padding-top: 1.5rem;
  border-top: 1px solid var(--art-border);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
}

.article-share-icons {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.article-share-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--art-text-muted);
  transition: color 0.2s ease;
  text-decoration: none;
  background: none;
  border: none;
  padding: 0.25rem;
  cursor: pointer;
}

.article-actions-github {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.4rem 0.8rem;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.7rem;
  color: var(--art-text-mid);
  border: 1px solid var(--art-border);
  background: var(--art-surface);
  text-decoration: none;
  transition: all 0.2s;
  border-radius: 2px;
}

.article-actions-github:hover {
  color: var(--art-accent);
  border-color: var(--art-accent-dim);
}

/* C2. Related posts (OUTSIDE box) */

.article-related {
  margin-top: 2.5rem;
}

.article-related-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1.25rem;
}

.article-related-title {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.65rem;
  color: var(--art-text-muted);
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

.article-related-viewall {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.65rem;
  color: var(--art-accent);
  text-decoration: none;
  display: flex;
  align-items: center;
  gap: 0.25rem;
  transition: opacity 0.2s;
}

.article-related-viewall:hover {
  opacity: 0.7;
}

.article-related-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 1rem;
}

@media (min-width: 768px) {
  .article-related-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

.article-related-card {
  display: block;
  border: 1px solid var(--art-border-card);
  overflow: hidden;
  background: var(--art-surface-card);
  transition: border-color 0.2s;
  text-decoration: none;
}

.article-related-card:hover {
  border-color: var(--art-border);
}

.article-related-thumb {
  aspect-ratio: 16 / 9;
  overflow: hidden;
  background: var(--art-surface-code);
}

.article-related-thumb img {
  border: none;
  border-radius: 0;
  margin: 0;
}

.article-related-info {
  padding: 0.75rem;
}

.article-related-meta {
  display: flex;
  align-items: baseline;
  gap: 0.5rem;
  margin-bottom: 0.4rem;
}

.article-related-name {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--art-text-card);
  text-transform: lowercase;
  line-height: 1.3;
  transition: color 0.2s;
}

.article-related-card:hover .article-related-name {
  color: var(--art-accent);
}


/* ─────────────────────────────────────────────────
   D. RESPONSIVE
   ───────────────────────────────────────────────── */

@media (max-width: 768px) {
  .article-body {
    padding: 1rem 1.25rem 1.5rem;
  }
  .article-title {
    font-size: 2rem;
  }
  .article-subtitle {
    font-size: 0.95rem;
  }
  .article-nav-row {
    flex-wrap: wrap;
    gap: 0.75rem;
  }
  .article-blog .article-nav-row {
    margin-left: -1.25rem;
    margin-right: -1.25rem;
    padding-left: 1.25rem;
    padding-right: 1.25rem;
  }
  .article-context-bar {
    margin-left: -1.25rem;
    margin-right: -1.25rem;
    padding-left: 1.25rem;
    padding-right: 1.25rem;
  }
}


/* ─────────────────────────────────────────────────
   E. BLOG LAYOUT (.article-blog)
   Scoped overrides for threads + bits2bricks
   ───────────────────────────────────────────────── */

/* E1. Body font override — Inter for prose */
.article-blog .article-content p,
.article-blog .article-content li,
.article-blog .article-content td,
.article-blog .article-content .small-text p {
  font-family: 'Inter', var(--font-sans);
  font-size: 0.9rem;
  line-height: 1.45;
}

/* E2. Blog title — Inter, no uppercase */
.article-blog .article-title {
  font-family: 'Inter', var(--font-sans);
  text-transform: none;
}

.article-blog .article-content h1,
.article-blog .article-content h2,
.article-blog .article-content h3,
.article-blog .article-content h4 {
  text-transform: none;
}

/* E2b. Blog subtitle — Inter, not uppercased */
.article-blog .article-subtitle {
  font-family: 'Inter', var(--font-sans);
  text-transform: none;
  letter-spacing: normal;
}

/* E3. Breadcrumbs */
.article-breadcrumbs {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.7rem;
}

.article-breadcrumb-link {
  color: var(--art-text-dim);
  text-decoration: none;
}

.article-breadcrumb-link:hover {
  color: var(--art-accent);
}

.article-breadcrumb-static {
  color: var(--art-text-muted);
}

.article-breadcrumb-sep {
  color: var(--art-text-muted);
}

.article-breadcrumb-current {
  color: var(--art-text-mid);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 20rem;
}

/* E4. Hashtag tag pills — below meta, above title (blog) */
.article-hashtags {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 0.4rem;
  margin-bottom: 0.75rem;
}

.article-hashtag {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.6rem;
  color: var(--art-purple);
  letter-spacing: 0.03em;
  border: 1px solid color-mix(in srgb, var(--art-purple) 30%, transparent);
  padding: 0.15rem 0.5rem;
  border-radius: 2px;
}

.article-hashtag-tech {
  color: var(--art-accent);
  border-color: color-mix(in srgb, var(--art-accent) 30%, transparent);
}

/* Threads: topic hashtags match accent (rose) instead of purple */
.article-threads .article-hashtag {
  color: var(--art-accent);
  border-color: color-mix(in srgb, var(--art-accent) 30%, transparent);
}

/* E4b. Blog separator — neutral line between subtitle and image */
.article-blog-sep {
  border: none;
  border-top: 1px solid var(--art-border);
  margin: 1.25rem 0 0;
}

/* E5. Blog image (natural color, below title) */
.article-blog-image {
  margin: 1.5rem 0 2rem;
  overflow: hidden;
  border-radius: 4px;
  border: 1px solid var(--art-border);
}

.article-blog-image-img {
  width: 100%;
  height: 100%;
  display: block;
  object-fit: cover;
}

/* E6. Context bar — full-width sub-header below breadcrumbs */
.article-context-bar {
  margin: 0 -2rem 1.25rem;
  padding: 0.65rem 2rem;
  background: var(--art-surface-context);
  border-bottom: 1px solid var(--art-border);
}

.article-context {
  margin: 0;
  padding: 0;
  font-family: 'Inter', var(--font-sans);
  font-size: 0.65rem;
  color: var(--art-text-context);
  line-height: 1.6;
  font-style: italic;
}

/* E7. Simplified TOC — bottom line only, accent color */
.article-toc--blog {
  border: none;
  border-bottom: 1px solid var(--art-accent-dim);
}

.article-toc--blog .article-toc-toggle {
  padding: 0.5rem 0;
}

.article-toc--blog .article-toc-label {
  text-transform: none;
  font-size: 0.7rem;
  letter-spacing: 0.05em;
}

.article-toc--blog .article-toc-link {
  text-transform: none;
  font-family: 'Inter', var(--font-sans);
  font-size: 0.75rem;
}


================================================================
# FILE: scripts/build-content.js  (546 lines)
================================================================
import fs from 'fs';
import path from 'path';
import matter from 'gray-matter';
import { marked, Renderer } from 'marked';
import { load as loadYaml } from 'js-yaml';
import { fileURLToPath } from 'url';
import { createHighlighter, bundledLanguages } from 'shiki';
import { validateFieldnotes } from './validate-fieldnotes.js';
import compilerConfig from './compiler.config.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Custom renderer for images with positioning (center/full only - left/right handled by preprocessor)
const customRenderer = new Renderer();
const { titlePattern, classMap } = compilerConfig.imagePositions;

// Override blockquote renderer — > produces small text, not blockquotes
customRenderer.blockquote = function(token) {
  const body = this.parser.parse(token.tokens);
  return `<div class="small-text">${body}</div>\n`;
};

customRenderer.image = function({ href, title, text }) {
  let className = '';
  let style = '';
  let finalTitle = title;

  if (title) {
    const positionMatch = title.match(titlePattern);
    if (positionMatch) {
      const position = positionMatch[1];
      const width = positionMatch[2];
      className = classMap[position] || '';
      if (width && position !== 'full') style = `width: ${width};`;
      finalTitle = null;
    }
  }

  // Figcaption support: ![alt|Caption text](url "position")
  let alt = text || '';
  let caption = '';
  if (alt.includes('|')) {
    const pipeIndex = alt.indexOf('|');
    caption = alt.slice(pipeIndex + 1).trim();
    alt = alt.slice(0, pipeIndex).trim();
  }

  const styleAttr = style ? ` style="${style}"` : '';
  const titleAttr = finalTitle ? ` title="${finalTitle}"` : '';

  if (caption) {
    const figClass = className ? ` class="${className}"` : '';
    const imgTag = `<img src="${href}" alt="${alt}"${styleAttr}${titleAttr} />`;
    return `<figure${figClass}>${imgTag}<figcaption>${caption}</figcaption></figure>`;
  }

  const classAttr = className ? ` class="${className}"` : '';
  const imgTag = `<img src="${href}" alt="${alt}"${classAttr}${styleAttr}${titleAttr} />`;
  return imgTag;
};

marked.setOptions({
  renderer: customRenderer,
  ...compilerConfig.marked,
});

// Apply pre-processors (before marked.parse, on raw markdown)
function applyPreProcessors(markdown) {
  let result = markdown;
  for (const rule of compilerConfig.preProcessors) {
    result = result.replace(rule.pattern, rule.replace);
  }
  return result;
}

// ── Backtick protection ──
// Shields inline code and fenced code blocks from pre-processors

function protectBackticks(markdown) {
  const placeholders = [];

  // 1. Fenced code blocks (``` ... ```)
  let result = markdown.replace(/```[\s\S]*?```/g, (match) => {
    placeholders.push(match);
    return `%%CBLK_${placeholders.length - 1}%%`;
  });

  // 2. Inline code — double backticks then single
  result = result.replace(/``[^`]+``|`[^`\n]+`/g, (match) => {
    placeholders.push(match);
    return `%%CBLK_${placeholders.length - 1}%%`;
  });

  return { text: result, placeholders };
}

function restoreBackticks(text, placeholders) {
  return text.replace(/%%CBLK_(\d+)%%/g, (_, idx) => placeholders[parseInt(idx)]);
}

// ── Copy button icon ──

const COPY_ICON = `<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>`;
const COPY_BTN = `<button class="copy-btn" aria-label="Copiar">${COPY_ICON} Copiar</button>`;

// ── Typed blockquotes {bkqt:type:text} ──

const BKQT_TYPES = {
  note:       { label: 'Note' },
  tip:        { label: 'Tip' },
  warning:    { label: 'Warning' },
  danger:     { label: 'Danger' },
  deepdive:   { label: 'Deep dive' },
  keyconcept: { label: 'Key concept' },
};

function processCustomBlockquotes(markdown, placeholders) {
  return markdown.replace(
    /\{bkqt\/(note|tip|warning|danger|deepdive|keyconcept)(?:\|([^:]*))?\:([\s\S]*?)\}/g,
    (_, type, customLabel, text) => {
      const config = BKQT_TYPES[type];
      const label = customLabel ? customLabel.trim() : config.label;
      const withNewlines = text.trim()
        .replace(/\/n(?=\s*(?:- |\d+\. ))/g, '\n')
        .replace(/\/n/g, '\n\n');
      const restored = restoreBackticks(withNewlines, placeholders);
      const body = marked.parse(restored);
      return `<div class="bkqt bkqt-${type}"><div class="bkqt-header"><span class="bkqt-label">${label}</span>${COPY_BTN}</div><div class="bkqt-body">${body}</div></div>`;
    }
  );
}

// ── HTML code-segment protection ──
// Wraps a processing function so it skips <pre> and <code> content

function processOutsideCode(html, fn) {
  const segments = [];
  let safe = html.replace(/<pre[\s\S]*?<\/pre>|<code[\s\S]*?<\/code>/g, (match) => {
    segments.push(match);
    return `%%CSEG_${segments.length - 1}%%`;
  });
  safe = fn(safe);
  return safe.replace(/%%CSEG_(\d+)%%/g, (_, idx) => segments[parseInt(idx)]);
}

// ── External URL links [[https://...|text]] ──
// Processed BEFORE marked.parse to prevent URL auto-linking corruption

function processExternalUrls(markdown) {
  return markdown.replace(/\[\[(https?:\/\/[^\]|]+)(?:\|([^\]]+))?\]\]/g, (_, url, displayText) => {
    const href = url.trim();
    const display = displayText ? displayText.trim() : href;
    return `<a class="doc-ref doc-ref-external" href="${href}" target="_blank" rel="noopener noreferrer">${display}</a>`;
  });
}

// ── Unified [[link]] processing ──
// All [[...]] links are processed in a single pass.
// Address pattern determines the type:
//   projects/slug, threads/slug, bits2bricks/slug → cross-doc link (display text required)
//   anything else (word, parent//child)           → second-brain wiki-ref

const buildErrors = [];

const CROSS_DOC_CATEGORIES = {
  projects:    { path: '/lab/projects' },
  threads:     { path: '/blog/threads' },
  bits2bricks: { path: '/blog/bits2bricks' },
};

function processAllLinks(html) {
  if (!compilerConfig.wikiLinks.enabled) return html;

  return html.replace(/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/g, (match, address, displayText) => {
    const crossDocMatch = address.match(/^(projects|threads|bits2bricks)\/(.*)/);

    if (crossDocMatch) {
      const [, category, slug] = crossDocMatch;
      const config = CROSS_DOC_CATEGORIES[category];
      if (!config) return match;

      if (!displayText) {
        const msg = `cross-doc link [[${address.trim()}]] missing display text — use [[${address.trim()}|Display Text]]`;
        console.error(`  \x1b[31mERROR: ${msg}\x1b[0m`);
        buildErrors.push(msg);
        return match;
      }

      const href = `${config.path}/${slug.trim()}`;
      return `<a class="doc-ref doc-ref-${category}" href="${href}" target="_blank" rel="noopener noreferrer">${displayText.trim()}</a>`;
    }

    // Second-brain wiki-ref
    const segments = address.split('//');
    const display = displayText ? displayText.trim() : segments[segments.length - 1].trim();
    return `<a class="wiki-ref" data-address="${address}">${display}</a>`;
  });
}

// Apply post-processors (after marked.parse, on HTML)
function applyPostProcessors(html) {
  let result = html;
  for (const rule of compilerConfig.postProcessors) {
    result = result.replace(rule.pattern, rule.replace);
  }
  return result;
}

// Preprocess markdown to handle side-by-side image layouts
// Pattern: ![alt](src "left|right:width") followed by text lines until empty line
function preprocessSideImages(markdown) {
  const blocks = markdown.split(/\n\n+/);
  const result = [];

  for (const block of blocks) {
    // Match image with left/right position at start of block
    const match = block.match(/^!\[([^\]]*)\]\(([^\s)]+)(?:\s+"(left|right):?(\d+px)?")?\)([\s\S]*)/);

    if (match && (match[3] === 'left' || match[3] === 'right')) {
      const [, alt, src, position, width, restOfBlock] = match;
      const widthStyle = width ? `width: ${width};` : '';

      // Get text lines after the image (same block = no empty line between)
      const textLines = restOfBlock.trim().split('\n').filter(l => l.trim());

      if (textLines.length > 0) {
        // Process each line through marked for inline formatting (bold, italic, links, etc.)
        const paragraphs = textLines.map(line => {
          const processed = marked.parseInline(line);
          return `<p>${processed}</p>`;
        }).join('\n');

        // Create flexbox container with image and text side by side
        result.push(`<div class="img-side-layout img-side-${position}">
<img src="${src}" alt="${alt}" class="img-side-img" style="${widthStyle}">
<div class="img-side-content">
${paragraphs}
</div>
</div>`);
      } else {
        // No text after image, let marked handle it normally
        result.push(block);
      }
    } else {
      result.push(block);
    }
  }

  return result.join('\n\n');
}

// ── Shiki syntax highlighting ──

// Per-language theme pairs (dark key → --shiki-dark, light key → --shiki-light)
const LANG_THEMES = {
  typescript: { dark: 'one-dark-pro',      light: 'one-light'        },
  javascript: { dark: 'one-dark-pro',      light: 'one-light'        },
  python:     { dark: 'catppuccin-mocha',  light: 'catppuccin-latte' },
  rust:       { dark: 'rose-pine',         light: 'rose-pine-dawn'   },
  go:         { dark: 'min-dark',          light: 'min-light'        },
  yaml:       { dark: 'github-dark',       light: 'github-light'     },
  json:       { dark: 'github-dark',       light: 'github-light'     },
};
const DEFAULT_THEMES = { dark: 'vitesse-dark', light: 'vitesse-light' };

function decodeHtmlEntities(str) {
  return str
    .replace(/&amp;/g, '&')
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>')
    .replace(/&quot;/g, '"')
    .replace(/&#39;/g, "'");
}

function highlightCodeBlocks(html, highlighter) {
  // Code blocks with language tag
  html = html.replace(
    /<pre><code class="language-(\w+)">([\s\S]*?)<\/code><\/pre>/g,
    (_match, lang, escapedCode) => {
      const rawCode = decodeHtmlEntities(escapedCode).replace(/\n$/, '');
      const langLabel = lang.toUpperCase();
      const themes = LANG_THEMES[lang] || DEFAULT_THEMES;

      let codeContent;
      try {
        const highlighted = highlighter.codeToHtml(rawCode, {
          lang,
          themes,
          defaultColor: false,
        });
        const inner = highlighted.match(/<code>([\s\S]*?)<\/code>/);
        codeContent = inner ? inner[1] : escapedCode;
      } catch {
        codeContent = escapedCode;
      }

      return `<div class="code-terminal"><div class="code-terminal-bar"><div class="code-terminal-dots"><span></span><span></span><span></span></div><div class="code-terminal-right"><span class="code-terminal-lang">${langLabel}</span>${COPY_BTN}</div></div><pre><code class="language-${lang}">${codeContent}</code></pre></div>`;
    }
  );

  // Code blocks without language tag
  html = html.replace(
    /<pre><code(?!\s+class="language-)>([\s\S]*?)<\/code><\/pre>/g,
    (_match, code) => {
      return `<div class="code-terminal"><div class="code-terminal-bar"><div class="code-terminal-dots"><span></span><span></span><span></span></div><div class="code-terminal-right"><span class="code-terminal-lang"></span>${COPY_BTN}</div></div><pre><code>${code}</code></pre></div>`;
    }
  );

  return html;
}

// Collect all themes needed and create highlighter
const allThemes = new Set([DEFAULT_THEMES.dark, DEFAULT_THEMES.light]);
for (const t of Object.values(LANG_THEMES)) {
  allThemes.add(t.dark);
  allThemes.add(t.light);
}

const highlighter = await createHighlighter({
  themes: [...allThemes],
  langs: Object.keys(bundledLanguages),
});

const PAGES_DIR = path.join(__dirname, '../src/data/pages');
const OUTPUT_FILE = path.join(__dirname, '../src/data/posts.generated.json');
const CATEGORIES_OUTPUT = path.join(__dirname, '../src/data/categories.generated.json');
const HOME_FEATURED_OUTPUT = path.join(__dirname, '../src/data/home-featured.generated.json');

function processMarkdownFile(filePath) {
  const fileContent = fs.readFileSync(filePath, 'utf-8');
  const { data: frontmatter, content } = matter(fileContent);

  // Pipeline: protect → preProcessors → bkqt (with placeholders) → restore → externalUrls → sideImages → marked → shiki → postProcessors
  const { text: safeContent, placeholders } = protectBackticks(content);
  const withCustomSyntax = applyPreProcessors(safeContent);
  const withBkqt = processCustomBlockquotes(withCustomSyntax, placeholders);
  const restored = restoreBackticks(withBkqt, placeholders);
  const withExternalUrls = processExternalUrls(restored);
  const withSideImages = preprocessSideImages(withExternalUrls);
  const parsed = marked.parse(withSideImages);
  const highlighted = highlightCodeBlocks(parsed, highlighter);
  const htmlContent = applyPostProcessors(highlighted);

  return {
    id: frontmatter.id,
    title: frontmatter.title,
    displayTitle: frontmatter.displayTitle,
    category: frontmatter.category,
    date: frontmatter.date,
    thumbnail: frontmatter.thumbnail || null,
    thumbnailAspect: frontmatter.thumbnailAspect || null,
    thumbnailShading: frontmatter.thumbnailShading || null,
    description: frontmatter.description,
    content: htmlContent,
    status: frontmatter.status || null,
    technologies: frontmatter.technologies || null,
    tags: frontmatter.tags || null,
    github: frontmatter.github || null,
    demo: frontmatter.demo || null,
    caseStudy: frontmatter.caseStudy || null,
    duration: frontmatter.duration || null,
    featured: frontmatter.featured || null,
    author: frontmatter.author || null,
    subtitle: frontmatter.subtitle || null,
    notes: frontmatter.notes || null,
    context: frontmatter.context || null,
    related: frontmatter.related || null,
  };
}

function loadCategoryConfig(filePath) {
  const content = fs.readFileSync(filePath, 'utf-8');
  return loadYaml(content);
}

function getAllMarkdownFiles(dir) {
  const files = [];
  const items = fs.readdirSync(dir);

  for (const item of items) {
    const fullPath = path.join(dir, item);
    const stat = fs.statSync(fullPath);

    if (stat.isDirectory()) {
      files.push(...getAllMarkdownFiles(fullPath));
    } else if (item.endsWith('.md') && !item.startsWith('_')) {
      // Skip _fieldnotes.md and other _*.md files
      files.push(fullPath);
    }
  }

  return files;
}

function getAllCategoryConfigs(dir) {
  const configs = {};
  const items = fs.readdirSync(dir);

  for (const item of items) {
    const fullPath = path.join(dir, item);
    const stat = fs.statSync(fullPath);

    if (stat.isDirectory()) {
      const configPath = path.join(fullPath, '_category.yaml');
      if (fs.existsSync(configPath)) {
        const config = loadCategoryConfig(configPath);
        configs[config.name] = config;
      }
    }
  }

  return configs;
}

// --- Fieldnotes: parse _fieldnotes.md ---

function processFieldnotesFile() {
  const fieldnotesDir = path.join(PAGES_DIR, 'fieldnotes');
  if (!fs.existsSync(fieldnotesDir)) return [];

  // Find _*.md files (not _category.yaml)
  const dirFiles = fs.readdirSync(fieldnotesDir);
  const fieldnotesFile = dirFiles.find(f => f.startsWith('_') && f.endsWith('.md'));
  if (!fieldnotesFile) return [];

  const filePath = path.join(fieldnotesDir, fieldnotesFile);
  const content = fs.readFileSync(filePath, 'utf-8');
  const blocks = content.split(/\n---\n/).map(b => b.trim()).filter(Boolean);

  return blocks.map(block => {
    const lines = block.split('\n');
    const address = lines[0].trim();
    const bodyLines = lines.slice(1);
    const bodyMd = bodyLines.join('\n').trim();

    // Generate ID: lowercase, // → --, / → -, space → -
    const id = address.toLowerCase().replace(/\/\//g, '--').replace(/\//g, '-').replace(/\s+/g, '-');

    // Address parts
    const addressParts = address.split('//').map(s => s.trim());
    const displayTitle = addressParts[addressParts.length - 1];

    // Description: first non-empty, non-heading, non-image text line
    const firstTextLine = bodyLines.find(l => {
      const trimmed = l.trim();
      return trimmed && !trimmed.startsWith('#') && !trimmed.startsWith('!');
    });
    const description = firstTextLine
      ? firstTextLine.trim().replace(/\[\[([^\]]+)\]\]/g, (_m, addr) => addr.split('//').pop().trim())
      : '';

    // Extract ALL [[...]] references from body markdown
    const refRegex = /\[\[([^\]]+)\]\]/g;
    const references = [];
    let match;
    while ((match = refRegex.exec(bodyMd)) !== null) {
      references.push(match[1]);
    }

    // Extract trailing refs (standalone [[...]] lines at end of block)
    const trailingRefs = [];
    const trailingRefPattern = /^\s*(\[\[[^\]]+\]\]\s*)+$/;
    for (let i = bodyLines.length - 1; i >= 0; i--) {
      const line = bodyLines[i].trim();
      if (!line) continue;
      if (trailingRefPattern.test(line)) {
        const lineRefRegex = /\[\[([^\]]+)\]\]/g;
        let lineMatch;
        while ((lineMatch = lineRefRegex.exec(line)) !== null) {
          trailingRefs.push(lineMatch[1]);
        }
      } else {
        break;
      }
    }

    // Pipeline: protect → preProcessors → bkqt (with placeholders) → restore → externalUrls → sideImages → marked → shiki → postProcessors
    const { text: safeBody, placeholders } = protectBackticks(bodyMd);
    const withCustomSyntax = applyPreProcessors(safeBody);
    const withBkqt = processCustomBlockquotes(withCustomSyntax, placeholders);
    const restoredBody = restoreBackticks(withBkqt, placeholders);
    const withExternalUrls = processExternalUrls(restoredBody);
    const withSideImages = preprocessSideImages(withExternalUrls);
    const parsed = marked.parse(withSideImages);
    const highlighted = highlightCodeBlocks(parsed, highlighter);
    const htmlContent = applyPostProcessors(highlighted);

    return {
      id,
      title: address,
      displayTitle,
      category: 'fieldnotes',
      date: '',
      thumbnail: null,
      description,
      content: htmlContent,
      address,
      addressParts,
      references,
      trailingRefs,
    };
  });
}

// Main
console.log('Building content...');

const markdownFiles = getAllMarkdownFiles(PAGES_DIR);
const regularPosts = markdownFiles.map(processMarkdownFile);
const fieldnotePosts = processFieldnotesFile();

// Apply unified [[link]] processing to all posts (skipping <code> content)
const allPosts = [...regularPosts, ...fieldnotePosts].map(post => ({
  ...post,
  content: processOutsideCode(post.content, processAllLinks),
}));

const categories = getAllCategoryConfigs(PAGES_DIR);

// Validate fieldnotes + wiki-links
const validation = validateFieldnotes(fieldnotePosts, allPosts, compilerConfig.validation);

const totalErrors = buildErrors.length + validation.errors;
if (totalErrors > 0) {
  console.error(`\x1b[31mBuild failed with ${totalErrors} error(s)\x1b[0m`);
  process.exit(1);
}

// --- Home featured posts ---

const homeFeaturedPath = path.join(PAGES_DIR, 'home', '_home-featured.yaml');
let homeFeatured = { featured: [] };

if (fs.existsSync(homeFeaturedPath)) {
  const raw = loadYaml(fs.readFileSync(homeFeaturedPath, 'utf-8'));
  homeFeatured = raw;
}

fs.writeFileSync(OUTPUT_FILE, JSON.stringify(allPosts, null, 2));
fs.writeFileSync(CATEGORIES_OUTPUT, JSON.stringify(categories, null, 2));
fs.writeFileSync(HOME_FEATURED_OUTPUT, JSON.stringify(homeFeatured, null, 2));

console.log(`Generated ${allPosts.length} posts → ${OUTPUT_FILE}`);
console.log(`Generated ${Object.keys(categories).length} categories → ${CATEGORIES_OUTPUT}`);
console.log(`Generated home featured config → ${HOME_FEATURED_OUTPUT}`);


================================================================
# FILE: scripts/compiler.config.js  (57 lines)
================================================================
// Centralized compiler configuration
// Controls all build-time processing of markdown content

export default {
  // marked.js options
  marked: {
    gfm: true,
    breaks: false,
  },

  // Wiki-links: [[address]] → <a class="wiki-ref">
  wikiLinks: {
    enabled: true,
    pattern: /\[\[([^\]]+)\]\]/g,
    toHtml: (address) => {
      const segments = address.split('//');
      const displayText = segments[segments.length - 1].trim();
      return `<a class="wiki-ref" data-address="${address}">${displayText}</a>`;
    },
  },

  // Image positioning (title-based)
  imagePositions: {
    positions: ['right', 'left', 'center', 'full'],
    titlePattern: /^(right|left|center|full):?(\d+px)?$/,
    classMap: {
      center: 'img-center',
      full: 'img-full',
      right: 'img-float-right',
      left: 'img-float-left',
    },
  },

  // Pre-processors: applied BEFORE marked.parse (on raw markdown)
  // Order matters: curly-brace patterns first (unambiguous), then bare-delimiter patterns
  preProcessors: [
    { name: 'text-color',       pattern: /\{#([a-fA-F0-9]{3,6}|[a-z]+):([^}]+)\}/g,  replace: '<span style="color:#$1">$2</span>' },
    { name: 'small-caps',       pattern: /\{sc:([^}]+)\}/g,                             replace: '<span style="font-variant:small-caps">$1</span>' },
    { name: 'superscript',      pattern: /\{\^:([^}]+)\}/g,                             replace: '<sup>$1</sup>' },
    { name: 'subscript',        pattern: /\{v:([^}]+)\}/g,                              replace: '<sub>$1</sub>' },
    { name: 'keyboard',         pattern: /\{kbd:([^}]+)\}/g,                            replace: '<kbd>$1</kbd>' },
    { name: 'underline',        pattern: /(?<!\w)_([^_\n]+?)_(?!\w)/g,                  replace: '<span style="text-decoration:underline">$1</span>' },
    { name: 'highlight',        pattern: /(?<!=)==([^=\n]+?)==(?!=)/g,                   replace: '<mark>$1</mark>' },
    { name: 'accent-text',      pattern: /(?<!-)--([^-\n]+?)--(?!-)/g,                  replace: '<span class="accent-text">$1</span>' },
  ],

  // Post-processors: applied AFTER marked.parse (on HTML output)
  // Note: code-terminal wrapping + Shiki highlighting is handled in build-content.js
  postProcessors: [],

  // Validation flags
  validation: {
    validateRegularPostWikiLinks: true,
    validateFieldnoteRefs: true,
    validateParentSegments: true,
  },
};


================================================================
# FILE: src/data/pages/projects/compiler-pipeline-demo.md  (44 lines)
================================================================
---
id: compiler-pipeline-demo
title: compiler-pipeline-demo
displayTitle: compiler pipeline demo
category: projects
date: 2025-01-30
thumbnail: https://images.unsplash.com/photo-1555949963-aa79dcee981c?q=80&w=400&auto=format&fit=crop
description: showcasing the custom compiler pipeline.
status: completed
technologies: [TypeScript, Marked, Vite]
demo: https://infraphysics.dev
---

# compiler pipeline demo

this project documents and tests the ==entire compilation pipeline== of infraphysics — from raw markdown to rendered HTML.

## custom syntax in action

the compiler supports {#7C3AED:colored text} inline. this is {#e74c3c:red}, this is {#2ecc71:green}, and this is {#3498db:blue}.

text can be _underlined_, ==highlighted==, or --accented-- — each with its own semantic intent.

chemical formulas: H{v:2}O, CO{v:2}, C{v:6}H{v:12}O{v:6}

mathematical notation: x{^:2} + y{^:2} = r{^:2}, or E = mc{^:2}

{sc:small caps} are useful for {sc:abbreviations} like {sc:nasa} or {sc:http}.

press {kbd:Ctrl+C} to copy, {kbd:Ctrl+V} to paste, {kbd:Ctrl+Shift+I} to open devtools.

## wiki-links

this compiler pipeline is related to [[Headless device]] concepts — the build runs headlessly, no GUI needed.

the output is ultimately rendered through a [[UI//GUI]], but the compilation itself is pure CLI.

## mixed markdown + custom syntax

> ==key insight==: the pre-processors run _before_ marked parses the markdown, so **bold {#e74c3c:red text}** works because the color span is already HTML when marked sees it.

- item with {#7C3AED:violet color}
- item with _underline_
- item with H{v:2}O formula


================================================================
# FILE: src/data/pages/threads/anatomy-of-a-markdown-compiler.md  (43 lines)
================================================================
---
id: anatomy-of-a-markdown-compiler
title: anatomy-of-a-markdown-compiler
displayTitle: anatomy of a markdown compiler
category: threads
date: 2025-01-30
thumbnail: https://images.unsplash.com/photo-1516116216517-838c2b4c4e8e?q=80&w=400&auto=format&fit=crop
description: how custom syntax coexists with standard markdown.
tags: [compilers, syntax, markdown]
---

# anatomy of a markdown compiler

writing your own markup extensions on top of markdown is a _delicate_ balance. the trick is ==ordering== — knowing _when_ each transformation runs.

## the ordering problem

imagine you write `{#e74c3c:some **bold** text}`. what happens?

1. {#7C3AED:pre-processors} fire first — the color syntax becomes `<span style="color:#e74c3c">some **bold** text</span>`
2. {#7C3AED:marked} parses next — it sees `**bold**` inside the span and converts it to `<strong>bold</strong>`
3. result: {#e74c3c:some **bold** text} — both work

if the order were reversed, marked would see `{#e74c3c:...}` as plain text and leave it as-is. the braces would survive into the HTML literally. _that would be a bug_.

## entropy and compilers

every transformation adds entropy to the pipeline. a [[Headless device]] analogy: each processing stage is a black box that transforms input without visual feedback. errors compound silently.

the solution: ==validation at the end==. after the full pipeline runs, the validator checks every `data-address` attribute in the output HTML against the fieldnotes database. broken links are caught at _build time_, not runtime.

## syntax cheat sheet

| what you write | what you get |
|---|---|
| `{#FF0000:text}` | {#FF0000:colored} |
| `_text_` | _underlined_ |
| `==text==` | ==highlighted== |
| `--text--` | --accented-- |
| `{sc:text}` | {sc:small caps} |
| `{^:text}` | x{^:2} |
| `{v:text}` | H{v:2}O |
| `{kbd:text}` | {kbd:Enter} |


================================================================
# FILE: src/data/pages/bits2bricks/custom-syntax-pcb.md  (41 lines)
================================================================
---
id: custom-syntax-pcb
title: custom-syntax-pcb
displayTitle: custom syntax pcb
category: bits2bricks
date: 2025-01-30
thumbnail: https://images.unsplash.com/photo-1518770660439-4636190af475?q=80&w=400&auto=format&fit=crop
thumbnailAspect: banner # full (auto) / wide (16/7) / banner (16/4) / strip (16/2)
description: bridging markup syntax and hardware notation.
tags: [pcb, hardware, syntax]
---

# custom syntax pcb

hardware documentation benefits from rich inline formatting. a PCB design log is the perfect test case.

## component values

the bypass cap is {sc:mlcc} type, rated at 100{sc:nf}. supply voltage: V{v:cc} = 3.3V, max current I{v:max} = 500mA.

power dissipation: P = I{^:2} x R = (0.5){^:2} x 10 = {#e74c3c:2.5W} — ==too hot without a heatsink==.

## status annotations

- {#2ecc71:PASS} — uart tx verified at 115200 baud
- {#e74c3c:FAIL} — rx oversampling glitch at _edge cases_
- {#f39c12:PENDING} — _thermal testing incomplete_

## cross-references

this board interfaces with a [[Headless device]] via serial. the debug output renders through a [[UI//GUI]] terminal emulator.

the uart protocol itself is documented in the fpga-uart-controller project.

## keyboard shortcuts for the test bench

{kbd:F5} — run test suite
{kbd:Ctrl+R} — reset FPGA
{kbd:Ctrl+Shift+L} — capture logic analyzer trace

> {..:note}: the {_:pull-up resistors} on the I{^:2}C bus measured 4.7k, within spec for V{v:dd} = 3.3V.


================================================================
# FILE: src/data/pages/home/_home-featured.yaml  (9 lines)
================================================================
featured:
  - ref: projects/neural-cellular-automata
    highlight: self-organizing textures that heal — exploring emergent computation through neural update rules.
  - ref: threads/entropy-and-software-decay
    highlight: why code rots without maintenance, and what physics tells us about building lasting systems.
  - ref: bits2bricks/fpga-uart-controller
    highlight: bridging bits and bricks — a verilog uart from first principles on a cyclone iv.
  - ref: threads/minimalism-is-hard
    highlight: the discipline of subtraction in engineering and design.


================================================================
 END — 69 files, 9847 total lines
================================================================
